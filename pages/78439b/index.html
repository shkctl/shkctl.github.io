<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入剖析arthas技术原理 | The Complete Backend Engineer</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-6948347885301434" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="禅与计算机程序设计的艺术">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.fd8a955e.css" as="style"><link rel="preload" href="/assets/js/app.e893bc68.js" as="script"><link rel="preload" href="/assets/js/2.0f2864c1.js" as="script"><link rel="preload" href="/assets/js/40.6eebc32d.js" as="script"><link rel="prefetch" href="/assets/js/10.44e0ca78.js"><link rel="prefetch" href="/assets/js/100.0ed371f6.js"><link rel="prefetch" href="/assets/js/101.7f722fd7.js"><link rel="prefetch" href="/assets/js/102.30c89284.js"><link rel="prefetch" href="/assets/js/103.3ed92c68.js"><link rel="prefetch" href="/assets/js/104.90df8f47.js"><link rel="prefetch" href="/assets/js/105.68247c1d.js"><link rel="prefetch" href="/assets/js/106.7c9f10c1.js"><link rel="prefetch" href="/assets/js/107.a515064a.js"><link rel="prefetch" href="/assets/js/108.80b5fa66.js"><link rel="prefetch" href="/assets/js/109.02b1ee2e.js"><link rel="prefetch" href="/assets/js/11.c76d3e56.js"><link rel="prefetch" href="/assets/js/110.1dccb364.js"><link rel="prefetch" href="/assets/js/111.464698db.js"><link rel="prefetch" href="/assets/js/112.857e923f.js"><link rel="prefetch" href="/assets/js/113.68e5c6a3.js"><link rel="prefetch" href="/assets/js/114.f6ffbf1a.js"><link rel="prefetch" href="/assets/js/115.e217114c.js"><link rel="prefetch" href="/assets/js/116.b65b8e0b.js"><link rel="prefetch" href="/assets/js/117.f6f15ef6.js"><link rel="prefetch" href="/assets/js/118.21180219.js"><link rel="prefetch" href="/assets/js/119.0a50382f.js"><link rel="prefetch" href="/assets/js/12.116d6a17.js"><link rel="prefetch" href="/assets/js/120.c76f2e28.js"><link rel="prefetch" href="/assets/js/121.c77bd4d8.js"><link rel="prefetch" href="/assets/js/122.753a4628.js"><link rel="prefetch" href="/assets/js/123.7d9268b9.js"><link rel="prefetch" href="/assets/js/124.23413b75.js"><link rel="prefetch" href="/assets/js/125.8d808d11.js"><link rel="prefetch" href="/assets/js/126.5c328cd4.js"><link rel="prefetch" href="/assets/js/127.be8eb4c7.js"><link rel="prefetch" href="/assets/js/128.14eaf4c6.js"><link rel="prefetch" href="/assets/js/129.037cada8.js"><link rel="prefetch" href="/assets/js/13.86ee0ee4.js"><link rel="prefetch" href="/assets/js/130.3f4b81a3.js"><link rel="prefetch" href="/assets/js/131.0a8a91be.js"><link rel="prefetch" href="/assets/js/132.d5865515.js"><link rel="prefetch" href="/assets/js/133.334e4ec7.js"><link rel="prefetch" href="/assets/js/134.074fbb0c.js"><link rel="prefetch" href="/assets/js/135.4c1d75b4.js"><link rel="prefetch" href="/assets/js/136.3e122b41.js"><link rel="prefetch" href="/assets/js/137.fe10b09a.js"><link rel="prefetch" href="/assets/js/138.54b4b2ef.js"><link rel="prefetch" href="/assets/js/139.3883fff5.js"><link rel="prefetch" href="/assets/js/14.e34688a7.js"><link rel="prefetch" href="/assets/js/140.078eff15.js"><link rel="prefetch" href="/assets/js/141.949d876b.js"><link rel="prefetch" href="/assets/js/142.54e6ed21.js"><link rel="prefetch" href="/assets/js/143.ff73dde5.js"><link rel="prefetch" href="/assets/js/144.cf979a70.js"><link rel="prefetch" href="/assets/js/145.b217db72.js"><link rel="prefetch" href="/assets/js/146.c9872ef2.js"><link rel="prefetch" href="/assets/js/147.32147c50.js"><link rel="prefetch" href="/assets/js/148.411a0638.js"><link rel="prefetch" href="/assets/js/149.ed899419.js"><link rel="prefetch" href="/assets/js/15.03c300fc.js"><link rel="prefetch" href="/assets/js/150.4c278e80.js"><link rel="prefetch" href="/assets/js/151.73bd004f.js"><link rel="prefetch" href="/assets/js/152.5716ffe7.js"><link rel="prefetch" href="/assets/js/153.33575577.js"><link rel="prefetch" href="/assets/js/154.6e0c3807.js"><link rel="prefetch" href="/assets/js/155.79acad7a.js"><link rel="prefetch" href="/assets/js/156.1ca46e9e.js"><link rel="prefetch" href="/assets/js/157.b8e1cb13.js"><link rel="prefetch" href="/assets/js/158.047ce40d.js"><link rel="prefetch" href="/assets/js/159.564cb107.js"><link rel="prefetch" href="/assets/js/16.76d8d610.js"><link rel="prefetch" href="/assets/js/160.0b4be4c9.js"><link rel="prefetch" href="/assets/js/161.2d0b6a29.js"><link rel="prefetch" href="/assets/js/162.7b7cddf9.js"><link rel="prefetch" href="/assets/js/163.9c1d2ab4.js"><link rel="prefetch" href="/assets/js/164.9a7309b6.js"><link rel="prefetch" href="/assets/js/165.11d81960.js"><link rel="prefetch" href="/assets/js/166.266c02dd.js"><link rel="prefetch" href="/assets/js/167.6d4d9953.js"><link rel="prefetch" href="/assets/js/168.aa4ee3b8.js"><link rel="prefetch" href="/assets/js/169.0d3373fb.js"><link rel="prefetch" href="/assets/js/17.453cb3dd.js"><link rel="prefetch" href="/assets/js/170.ce20f019.js"><link rel="prefetch" href="/assets/js/171.b4f20fc0.js"><link rel="prefetch" href="/assets/js/172.75742b66.js"><link rel="prefetch" href="/assets/js/173.8daa037e.js"><link rel="prefetch" href="/assets/js/174.5243dead.js"><link rel="prefetch" href="/assets/js/175.9a313498.js"><link rel="prefetch" href="/assets/js/176.4c2b81b0.js"><link rel="prefetch" href="/assets/js/177.dad18ef5.js"><link rel="prefetch" href="/assets/js/178.f3fa8d3b.js"><link rel="prefetch" href="/assets/js/179.589b3e1b.js"><link rel="prefetch" href="/assets/js/18.4de1c5f4.js"><link rel="prefetch" href="/assets/js/180.ea36098d.js"><link rel="prefetch" href="/assets/js/181.92cdb1c7.js"><link rel="prefetch" href="/assets/js/182.c0b21f1f.js"><link rel="prefetch" href="/assets/js/183.a0eb2e49.js"><link rel="prefetch" href="/assets/js/184.b5aa56e6.js"><link rel="prefetch" href="/assets/js/185.81cb4cac.js"><link rel="prefetch" href="/assets/js/186.53b06c41.js"><link rel="prefetch" href="/assets/js/187.dfae4e44.js"><link rel="prefetch" href="/assets/js/188.b0cb81de.js"><link rel="prefetch" href="/assets/js/189.3678f44d.js"><link rel="prefetch" href="/assets/js/19.3e76d54a.js"><link rel="prefetch" href="/assets/js/190.83946875.js"><link rel="prefetch" href="/assets/js/191.3ff7b14d.js"><link rel="prefetch" href="/assets/js/192.701461bb.js"><link rel="prefetch" href="/assets/js/193.559260cc.js"><link rel="prefetch" href="/assets/js/194.be81abc2.js"><link rel="prefetch" href="/assets/js/195.9b8d270a.js"><link rel="prefetch" href="/assets/js/196.bec3303f.js"><link rel="prefetch" href="/assets/js/197.63dafd74.js"><link rel="prefetch" href="/assets/js/198.605f2efc.js"><link rel="prefetch" href="/assets/js/199.edfd56ac.js"><link rel="prefetch" href="/assets/js/20.6e6b3fc4.js"><link rel="prefetch" href="/assets/js/200.3e48ab94.js"><link rel="prefetch" href="/assets/js/201.233d8a2d.js"><link rel="prefetch" href="/assets/js/202.91a5ef9c.js"><link rel="prefetch" href="/assets/js/203.bc0fabe9.js"><link rel="prefetch" href="/assets/js/204.8bc8880b.js"><link rel="prefetch" href="/assets/js/205.0f5a3300.js"><link rel="prefetch" href="/assets/js/206.b3505d50.js"><link rel="prefetch" href="/assets/js/207.a394ee4c.js"><link rel="prefetch" href="/assets/js/208.837b0596.js"><link rel="prefetch" href="/assets/js/209.e9d3bceb.js"><link rel="prefetch" href="/assets/js/21.69f77bb4.js"><link rel="prefetch" href="/assets/js/210.edb571f9.js"><link rel="prefetch" href="/assets/js/211.fc30ee35.js"><link rel="prefetch" href="/assets/js/212.0c76fd95.js"><link rel="prefetch" href="/assets/js/213.4c91febb.js"><link rel="prefetch" href="/assets/js/214.0a2395e5.js"><link rel="prefetch" href="/assets/js/215.d4637411.js"><link rel="prefetch" href="/assets/js/216.c1454bb1.js"><link rel="prefetch" href="/assets/js/217.0c0e6f55.js"><link rel="prefetch" href="/assets/js/218.1451ab92.js"><link rel="prefetch" href="/assets/js/219.0f96b0c8.js"><link rel="prefetch" href="/assets/js/22.201d31e2.js"><link rel="prefetch" href="/assets/js/220.8f6313e8.js"><link rel="prefetch" href="/assets/js/221.11a00bef.js"><link rel="prefetch" href="/assets/js/222.8649b716.js"><link rel="prefetch" href="/assets/js/223.d8939fd6.js"><link rel="prefetch" href="/assets/js/224.f7a5a821.js"><link rel="prefetch" href="/assets/js/225.0c642b7c.js"><link rel="prefetch" href="/assets/js/226.5860464c.js"><link rel="prefetch" href="/assets/js/227.079d5421.js"><link rel="prefetch" href="/assets/js/228.d433e6e5.js"><link rel="prefetch" href="/assets/js/229.5068c386.js"><link rel="prefetch" href="/assets/js/23.10bf4243.js"><link rel="prefetch" href="/assets/js/230.20571aa5.js"><link rel="prefetch" href="/assets/js/231.a2977032.js"><link rel="prefetch" href="/assets/js/232.2c809bc8.js"><link rel="prefetch" href="/assets/js/233.443b82b0.js"><link rel="prefetch" href="/assets/js/234.800cdff1.js"><link rel="prefetch" href="/assets/js/235.fb8d4938.js"><link rel="prefetch" href="/assets/js/236.36863586.js"><link rel="prefetch" href="/assets/js/237.ad86391f.js"><link rel="prefetch" href="/assets/js/238.be050d3f.js"><link rel="prefetch" href="/assets/js/239.12a16a50.js"><link rel="prefetch" href="/assets/js/24.824afdae.js"><link rel="prefetch" href="/assets/js/25.35475e70.js"><link rel="prefetch" href="/assets/js/26.e02e9bae.js"><link rel="prefetch" href="/assets/js/27.271f5ef4.js"><link rel="prefetch" href="/assets/js/28.a3385896.js"><link rel="prefetch" href="/assets/js/29.b0f185f2.js"><link rel="prefetch" href="/assets/js/3.a5b363ab.js"><link rel="prefetch" href="/assets/js/30.e3ccdef2.js"><link rel="prefetch" href="/assets/js/31.f96d307d.js"><link rel="prefetch" href="/assets/js/32.c0b9fe86.js"><link rel="prefetch" href="/assets/js/33.200a99d3.js"><link rel="prefetch" href="/assets/js/34.2b031524.js"><link rel="prefetch" href="/assets/js/35.9cf4ce52.js"><link rel="prefetch" href="/assets/js/36.1d78bdc4.js"><link rel="prefetch" href="/assets/js/37.080c4136.js"><link rel="prefetch" href="/assets/js/38.a96300bf.js"><link rel="prefetch" href="/assets/js/39.fcf7d628.js"><link rel="prefetch" href="/assets/js/4.373178a6.js"><link rel="prefetch" href="/assets/js/41.3ad4146c.js"><link rel="prefetch" href="/assets/js/42.c1beb08d.js"><link rel="prefetch" href="/assets/js/43.76cd763e.js"><link rel="prefetch" href="/assets/js/44.6b1fdcd3.js"><link rel="prefetch" href="/assets/js/45.51579c3c.js"><link rel="prefetch" href="/assets/js/46.52741878.js"><link rel="prefetch" href="/assets/js/47.cd93b2de.js"><link rel="prefetch" href="/assets/js/48.773c188b.js"><link rel="prefetch" href="/assets/js/49.44412d53.js"><link rel="prefetch" href="/assets/js/5.6a44f71a.js"><link rel="prefetch" href="/assets/js/50.b4bbbbea.js"><link rel="prefetch" href="/assets/js/51.e8ef0c3a.js"><link rel="prefetch" href="/assets/js/52.4a55bbf5.js"><link rel="prefetch" href="/assets/js/53.c1087a52.js"><link rel="prefetch" href="/assets/js/54.c8e13749.js"><link rel="prefetch" href="/assets/js/55.cc84db26.js"><link rel="prefetch" href="/assets/js/56.f454b553.js"><link rel="prefetch" href="/assets/js/57.918eb2e9.js"><link rel="prefetch" href="/assets/js/58.d1a59570.js"><link rel="prefetch" href="/assets/js/59.044ec60b.js"><link rel="prefetch" href="/assets/js/6.6a62d9f9.js"><link rel="prefetch" href="/assets/js/60.81e16e70.js"><link rel="prefetch" href="/assets/js/61.ed5542f5.js"><link rel="prefetch" href="/assets/js/62.72b114ed.js"><link rel="prefetch" href="/assets/js/63.3e421524.js"><link rel="prefetch" href="/assets/js/64.1e3fb052.js"><link rel="prefetch" href="/assets/js/65.e1ed1c12.js"><link rel="prefetch" href="/assets/js/66.07753887.js"><link rel="prefetch" href="/assets/js/67.36f77f4b.js"><link rel="prefetch" href="/assets/js/68.5ddddae3.js"><link rel="prefetch" href="/assets/js/69.31b6a988.js"><link rel="prefetch" href="/assets/js/7.2f58813b.js"><link rel="prefetch" href="/assets/js/70.a04b238e.js"><link rel="prefetch" href="/assets/js/71.5ccef793.js"><link rel="prefetch" href="/assets/js/72.b1127849.js"><link rel="prefetch" href="/assets/js/73.7749f2a0.js"><link rel="prefetch" href="/assets/js/74.2fe0cec9.js"><link rel="prefetch" href="/assets/js/75.962eca85.js"><link rel="prefetch" href="/assets/js/76.ea97d2ca.js"><link rel="prefetch" href="/assets/js/77.182bb4ac.js"><link rel="prefetch" href="/assets/js/78.b9d2abaa.js"><link rel="prefetch" href="/assets/js/79.d6901320.js"><link rel="prefetch" href="/assets/js/8.779d1361.js"><link rel="prefetch" href="/assets/js/80.13663490.js"><link rel="prefetch" href="/assets/js/81.b09db84b.js"><link rel="prefetch" href="/assets/js/82.2bcbd31f.js"><link rel="prefetch" href="/assets/js/83.344d67cf.js"><link rel="prefetch" href="/assets/js/84.45bc9110.js"><link rel="prefetch" href="/assets/js/85.84a31255.js"><link rel="prefetch" href="/assets/js/86.fe802e40.js"><link rel="prefetch" href="/assets/js/87.be2bb441.js"><link rel="prefetch" href="/assets/js/88.3d367f79.js"><link rel="prefetch" href="/assets/js/89.87678ad0.js"><link rel="prefetch" href="/assets/js/9.87ad8bb5.js"><link rel="prefetch" href="/assets/js/90.f0b552b5.js"><link rel="prefetch" href="/assets/js/91.ab54ea37.js"><link rel="prefetch" href="/assets/js/92.f5490bfc.js"><link rel="prefetch" href="/assets/js/93.5cbe8d45.js"><link rel="prefetch" href="/assets/js/94.681b3734.js"><link rel="prefetch" href="/assets/js/95.f3017fa5.js"><link rel="prefetch" href="/assets/js/96.52ebd59a.js"><link rel="prefetch" href="/assets/js/97.e28a6ef9.js"><link rel="prefetch" href="/assets/js/98.84e88e28.js"><link rel="prefetch" href="/assets/js/99.9f1258fc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fd8a955e.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="The Complete Backend Engineer" class="logo"> <span class="site-name can-hide">The Complete Backend Engineer</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java核心技术" class="dropdown-title"><a href="/java-core/" class="link-title">Java核心技术</a> <span class="title" style="display:none;">Java核心技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>Java并发编程</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/pages/7e6285/" class="nav-link">浅谈Java并发安全发布技术</a></li><li class="dropdown-subitem"><a href="/pages/bb708f/" class="nav-link">浅谈Java线程池中拒绝策略与流控的艺术</a></li><li class="dropdown-subitem"><a href="/pages/ea4da6/" class="nav-link">深入源码解析synchronized关键字</a></li><li class="dropdown-subitem"><a href="/pages/a62174/" class="nav-link">浅谈Java并发编程中断的哲学</a></li><li class="dropdown-subitem"><a href="/pages/54f168/" class="nav-link">深入理解Java中的final关键字</a></li><li class="dropdown-subitem"><a href="/pages/d9feaf/" class="nav-link">深入剖析Java并发编程中的死锁问题</a></li><li class="dropdown-subitem"><a href="/pages/e171b0/" class="nav-link">浅谈池化技术的优雅关闭</a></li><li class="dropdown-subitem"><a href="/pages/96493d/" class="nav-link">synchronized关键字使用指南</a></li><li class="dropdown-subitem"><a href="/pages/17210f/" class="nav-link">浅谈并发编程等待通知模型</a></li><li class="dropdown-subitem"><a href="/pages/d2df46/" class="nav-link">浅谈传统并发编程的优化思路</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li><li class="dropdown-item"><h4>JVM相关</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/78918f/" class="nav-link">从零开始理解JVM的JIT编译机制</a></li><li class="dropdown-subitem"><a href="/pages/8e1e94/" class="nav-link">简明的Arthas配置及基础运维教程</a></li><li class="dropdown-subitem"><a href="/pages/1ac322/" class="nav-link">基于Arthas Idea的JVM故障排查与指令生成</a></li><li class="dropdown-subitem"><a href="/pages/fca4af/" class="nav-link">基于arthas量化监控诊断java应用方法论与实践</a></li><li class="dropdown-subitem"><a href="/pages/78439b/" aria-current="page" class="nav-link router-link-exact-active router-link-active">深入剖析arthas技术原理</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><a href="/cs/" class="link-title">计算机基础</a> <span class="title" style="display:none;">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>计算机组成原理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/aa591a/" class="nav-link">浅谈CPU流水线的艺术</a></li></ul></li><li class="dropdown-item"><h4>操作系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/a32bff/" class="nav-link">Linux性能问题排查最佳实践</a></li><li class="dropdown-subitem"><a href="/pages/8902d5/" class="nav-link">Linux上IO性能问题的故障排除实践</a></li><li class="dropdown-subitem"><a href="/pages/09184d/" class="nav-link">浅谈Linux权限管理</a></li><li class="dropdown-subitem"><a href="/pages/29f9e1/" class="nav-link">从操作系统底层浅谈程序栈的高效性</a></li></ul></li><li class="dropdown-item"><h4>编码最佳实践</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/968465/" class="nav-link">浅谈现代软件工程TDD最佳实践</a></li><li class="dropdown-subitem"><a href="/pages/2b73d8/" class="nav-link">浅谈TDD模式下并发程序设计与实现</a></li><li class="dropdown-subitem"><a href="/pages/50d82f/" class="nav-link">面向AI编程新范式Trae后端开发环境搭建与实践</a></li><li class="dropdown-subitem"><a href="/pages/3d2b25/" class="nav-link">基于提示词工程的Redis签到功能开发实践</a></li><li class="dropdown-subitem"><a href="/pages/745def/" class="nav-link">基于Vibe Coding的Redis分页查询实现</a></li><li class="dropdown-subitem"><a href="/pages/5b74d3/" class="nav-link">告别AI无效对话：资深工程师的提示词设计最佳实践</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="程序员日常" class="dropdown-title"><a href="/coder-life/" class="link-title">程序员日常</a> <span class="title" style="display:none;">程序员日常</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>实用技巧与配置</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/9dae72/" class="nav-link">Mac常用快捷键与效率插件指南</a></li></ul></li><li class="dropdown-item"><h4>写作</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/38a0f7/" class="nav-link">写好技术博客的5大核心原则：从认知科学到AI工具的全流程指南</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程工具" class="dropdown-title"><a href="/technology/" class="link-title">编程工具</a> <span class="title" style="display:none;">编程工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>开发工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/609690/" class="nav-link">IDEA配置详解与高效使用指南</a></li></ul></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/sharkchili/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://jsd.cdn.zzko.cn/gh/sharkchili/image_store/blog/20200103123203.jpg"> <div class="blogger-info"><h3>sharkchili</h3> <span>计算机禅修者</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java核心技术" class="dropdown-title"><a href="/java-core/" class="link-title">Java核心技术</a> <span class="title" style="display:none;">Java核心技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>Java并发编程</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/pages/7e6285/" class="nav-link">浅谈Java并发安全发布技术</a></li><li class="dropdown-subitem"><a href="/pages/bb708f/" class="nav-link">浅谈Java线程池中拒绝策略与流控的艺术</a></li><li class="dropdown-subitem"><a href="/pages/ea4da6/" class="nav-link">深入源码解析synchronized关键字</a></li><li class="dropdown-subitem"><a href="/pages/a62174/" class="nav-link">浅谈Java并发编程中断的哲学</a></li><li class="dropdown-subitem"><a href="/pages/54f168/" class="nav-link">深入理解Java中的final关键字</a></li><li class="dropdown-subitem"><a href="/pages/d9feaf/" class="nav-link">深入剖析Java并发编程中的死锁问题</a></li><li class="dropdown-subitem"><a href="/pages/e171b0/" class="nav-link">浅谈池化技术的优雅关闭</a></li><li class="dropdown-subitem"><a href="/pages/96493d/" class="nav-link">synchronized关键字使用指南</a></li><li class="dropdown-subitem"><a href="/pages/17210f/" class="nav-link">浅谈并发编程等待通知模型</a></li><li class="dropdown-subitem"><a href="/pages/d2df46/" class="nav-link">浅谈传统并发编程的优化思路</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li><li class="dropdown-item"><h4>JVM相关</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/78918f/" class="nav-link">从零开始理解JVM的JIT编译机制</a></li><li class="dropdown-subitem"><a href="/pages/8e1e94/" class="nav-link">简明的Arthas配置及基础运维教程</a></li><li class="dropdown-subitem"><a href="/pages/1ac322/" class="nav-link">基于Arthas Idea的JVM故障排查与指令生成</a></li><li class="dropdown-subitem"><a href="/pages/fca4af/" class="nav-link">基于arthas量化监控诊断java应用方法论与实践</a></li><li class="dropdown-subitem"><a href="/pages/78439b/" aria-current="page" class="nav-link router-link-exact-active router-link-active">深入剖析arthas技术原理</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><a href="/cs/" class="link-title">计算机基础</a> <span class="title" style="display:none;">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>计算机组成原理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/aa591a/" class="nav-link">浅谈CPU流水线的艺术</a></li></ul></li><li class="dropdown-item"><h4>操作系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/a32bff/" class="nav-link">Linux性能问题排查最佳实践</a></li><li class="dropdown-subitem"><a href="/pages/8902d5/" class="nav-link">Linux上IO性能问题的故障排除实践</a></li><li class="dropdown-subitem"><a href="/pages/09184d/" class="nav-link">浅谈Linux权限管理</a></li><li class="dropdown-subitem"><a href="/pages/29f9e1/" class="nav-link">从操作系统底层浅谈程序栈的高效性</a></li></ul></li><li class="dropdown-item"><h4>编码最佳实践</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/968465/" class="nav-link">浅谈现代软件工程TDD最佳实践</a></li><li class="dropdown-subitem"><a href="/pages/2b73d8/" class="nav-link">浅谈TDD模式下并发程序设计与实现</a></li><li class="dropdown-subitem"><a href="/pages/50d82f/" class="nav-link">面向AI编程新范式Trae后端开发环境搭建与实践</a></li><li class="dropdown-subitem"><a href="/pages/3d2b25/" class="nav-link">基于提示词工程的Redis签到功能开发实践</a></li><li class="dropdown-subitem"><a href="/pages/745def/" class="nav-link">基于Vibe Coding的Redis分页查询实现</a></li><li class="dropdown-subitem"><a href="/pages/5b74d3/" class="nav-link">告别AI无效对话：资深工程师的提示词设计最佳实践</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="程序员日常" class="dropdown-title"><a href="/coder-life/" class="link-title">程序员日常</a> <span class="title" style="display:none;">程序员日常</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>实用技巧与配置</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/9dae72/" class="nav-link">Mac常用快捷键与效率插件指南</a></li></ul></li><li class="dropdown-item"><h4>写作</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/38a0f7/" class="nav-link">写好技术博客的5大核心原则：从认知科学到AI工具的全流程指南</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程工具" class="dropdown-title"><a href="/technology/" class="link-title">编程工具</a> <span class="title" style="display:none;">编程工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>开发工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/609690/" class="nav-link">IDEA配置详解与高效使用指南</a></li></ul></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/sharkchili/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div class="sidebar-slot sidebar-slot-top"><!--  固定100% * 150px可显示，max-height:150px 未见显示-->
       <ins class="adsbygoogle"
             style="display:inline-block;width:100%;max-height:150px"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="8819267679"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script>

</div> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>并发编程</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>JVM相关</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/pages/78918f/" class="sidebar-link">从零开始理解JVM的JIT编译机制</a></li><li><a href="/pages/8e1e94/" class="sidebar-link">简明的Arthas配置及基础运维教程</a></li><li><a href="/pages/1ac322/" class="sidebar-link">基于Arthas Idea的JVM故障排查与指令生成</a></li><li><a href="/pages/fca4af/" class="sidebar-link">基于arthas量化监控诊断java应用方法论与实践</a></li><li><a href="/pages/78439b/" aria-current="page" class="active sidebar-link">深入剖析arthas技术原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/78439b/#写在文章开头" class="sidebar-link">写在文章开头</a></li><li class="sidebar-sub-header level2"><a href="/pages/78439b/#前置知识铺垫" class="sidebar-link">前置知识铺垫</a></li><li class="sidebar-sub-header level2"><a href="/pages/78439b/#环境说明" class="sidebar-link">环境说明</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/78439b/#jvm如何工作的" class="sidebar-link">jvm如何工作的</a></li><li class="sidebar-sub-header level3"><a href="/pages/78439b/#arhtas增强工作机制" class="sidebar-link">arhtas增强工作机制</a></li><li class="sidebar-sub-header level3"><a href="/pages/78439b/#arthas对于字节码增强的应用" class="sidebar-link">arthas对于字节码增强的应用</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/78439b/#详解arthas工作全流程" class="sidebar-link">详解arthas工作全流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/78439b/#arthas-boot启动" class="sidebar-link">arthas boot启动</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#宏观流程说明" class="sidebar-link">宏观流程说明</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#参数解析" class="sidebar-link">参数解析</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#获取目标进程" class="sidebar-link">获取目标进程</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#整合参数启动arthas-core" class="sidebar-link">整合参数启动arthas-core</a></li><li class="sidebar-sub-header level3"><a href="/pages/78439b/#arthas-core-启动" class="sidebar-link">arthas-core 启动</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#执行流程和调试环境说明" class="sidebar-link">执行流程和调试环境说明</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#工作流程介绍" class="sidebar-link">工作流程介绍</a></li><li class="sidebar-sub-header level3"><a href="/pages/78439b/#arthas-agent-增强-重点" class="sidebar-link">arthas agent 增强(重点)</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#宏观流程介绍" class="sidebar-link">宏观流程介绍</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#调试环境搭建" class="sidebar-link">调试环境搭建</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#attach流程说明" class="sidebar-link">attach流程说明</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/78439b/#详解arthasbootstrap启动核心流程" class="sidebar-link">详解ArthasBootstrap启动核心流程</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/78439b/#详解spy初始化-重点" class="sidebar-link">详解spy初始化(重点)</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#为什么需要加载spyapi" class="sidebar-link">为什么需要加载SpyAPI</a></li><li class="sidebar-sub-header level4"><a href="/pages/78439b/#为什么需要通过根加载器进行加载" class="sidebar-link">为什么需要通过根加载器进行加载</a></li><li class="sidebar-sub-header level3"><a href="/pages/78439b/#启动arthas-server" class="sidebar-link">启动arthas server</a></li><li class="sidebar-sub-header level3"><a href="/pages/78439b/#客户端建立连接" class="sidebar-link">客户端建立连接</a></li><li class="sidebar-sub-header level3"><a href="/pages/78439b/#基于stack了解arthas设计理念与工作机制" class="sidebar-link">基于stack了解arthas设计理念与工作机制</a></li><li class="sidebar-sub-header level3"><a href="/pages/78439b/#解耦化拦截类方法执行增强逻辑" class="sidebar-link">解耦化拦截类方法执行增强逻辑</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/78439b/#关于arthas性能问题的探讨" class="sidebar-link">关于arthas性能问题的探讨</a></li><li class="sidebar-sub-header level2"><a href="/pages/78439b/#小结" class="sidebar-link">小结</a></li><li class="sidebar-sub-header level2"><a href="/pages/78439b/#参考" class="sidebar-link">参考</a></li></ul></li></ul></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
         <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="8723616095"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=Java%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF" title="分类" data-v-06225672>Java核心技术</a></li><li data-v-06225672><a href="/categories/?category=JVM%E7%9B%B8%E5%85%B3" title="分类" data-v-06225672>JVM相关</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/shkctl" target="_blank" title="作者" class="beLink" data-v-06225672>sharkchili</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2025-12-25</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABGpJREFUSA3tVVtoXFUU3fvOI53UlmCaKIFmwEhsE7QK0ipFEdHEKpXaZGrp15SINsXUWvBDpBgQRKi0+KKoFeJHfZA+ED9KKoIU2gYD9UejTW4rVIzm0VSTziPzuNu1z507dibTTjL4U/DAzLn3nL3X2o91ziX6f9wMFdh6Jvbm9nNSV0msViVO6tN1Rm7NMu2OpeJ9lWBUTDxrJbYTS0hInuwciu9eLHlFxCLCZEk3MegsJmZ5K/JD6t7FkFdEvGUo1g7qJoG3MHImqRIn8/nzY1K9UPKKiJmtnUqHVE3Gbuay6vJE/N2FEmuxFjW2nUuE0yQXRRxLiTUAzs36zhZvOXJPdX850EVnnLZkB8prodQoM5JGj7Xk2mvC7JB8tG04Ef5PiXtG0UtxupRQSfTnBoCy554x18yJHI6I+G5Eru4LHmPJZEQsrvPUbMiA8G/WgMK7w7I+ez7++o2ANfbrjvaOl1tFMs+htG3IrZH9/hDX1Pr8Tc0UvH8tcX29KzAgIGcEkINyW5BF9x891hw6VYqgJHEk0huccS7vh3C6gTiODL+26huuBtbct8eZnqLML8PkxGYpuPZBqtqwkSjgc4mB5gbgig5i+y0UDK35LMxXisn9xQtK+nd26gTIHsHe/oblK/b29fUmN/8Y+9jAQrnBp56m1LcDlDp9irKTExSKduXJVWSqdBMA08pEJnEIOB3FPPMybu/oeV8zFeYN3xx576Q6RH+VmplE4ncQV5v+5rzSoyOU7PuEAg8g803PwBJ0CExno/jcMbN8tONYeOmHiuUNryvm3fRUy4tMPVLdAGkUhNWuggGrJcXPv+ouCjz0MKUHz1J2/E8IC9nqTabcxgaBYM0hPhD5Y65FsbxRQKxCQrDjDctW7PUM3HuZunFyifSAqEfuzCp48Il24luWUWZoyJCaPR82jE0+kFA643wRFVni4RYSq3ohJO2pZ7B5dO4xkDWbEpossJPLSrPjYID8rS2UHTlvyNxqIGsg674XJJ7vnh5L7PNwC4hh2sjCI96mzszOTpxLF0T7l88Yz7lAuK6OnL8gXLOnTvpzSb22YG8W7us3jSebFHeeqnXRG1vt+MoUM84LQIBmMsCTAcOauTh0T0l0neQK7m2bLMt2mGxU3HYssS0J2cdv5wljlPsrIuZLAG/2DOZIXgCYT8uMGZN+e2kSirfxZOPCsC0f24nTZzspnVn9VePS1Z5vubmAGGXG8ZFno9Hel0yfA5ZPhF7Dh972BQJ2qCpgH67lmWtBYbvk6sz02wjky2vXyz0XErP/kFB619js1BtwfOV4OPRqOQBjy3Qbk18vigUPPSD5ceHnwck7W9bhAqZdd7SuG7w4/P2F/GaJh8c7e9qgow+Q7cGBo+98WsLkuktFqiZabtXuQTu/Y5ETbR0v7tNSFnvrmu6pjdoan2KjMu8q/Hmj1EfCO2ZGfEIbIXKUlw8qaX9/b2oeSJmFksSeT/Fn0V3nSypChh4Gjh74ybO9aeZ/AN2dwciu2/MhAAAAAElFTkSuQmCC">深入剖析arthas技术原理<!----></h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
        <ins class="adsbygoogle"
             style="display:inline-block;width:100%;max-height:90px"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="8542375009"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script></div> <div class="theme-vdoing-content content__default"><h2 id="写在文章开头"><a href="#写在文章开头" class="header-anchor">#</a> 写在文章开头</h2> <p>笔者一直强调，计算机是一门理性的学科，一切都是需要可量化和落地的，而本文的arthas是一款强大的监控诊断工具，了解其设计理念和工作机制，可以辅助我们更好的使用这款工具。而本文将从<code>jdk8</code>版本兼容的旧有版本，即arhtas 3.6.0的源码角度出发，来深入分析和学习<code>arthas</code>出色的设计理念，希望对你日常使用有所帮助。</p> <p>你好，我是 <strong>SharkChili</strong> ，禅与计算机程序设计艺术布道者，希望我的理念对您有所启发。</p> <p><strong>📝 我的公众号：写代码的SharkChili</strong><br>
在这里，我会分享技术干货、编程思考与开源项目实践。</p> <p><strong>🚀 我的开源项目：mini-redis</strong><br>
一个用于教学理解的 Redis 精简实现，欢迎 Star &amp; Contribute：<br> <a href="https://github.com/shark-ctrl/mini-redis" target="_blank" rel="noopener noreferrer">https://github.com/shark-ctrl/mini-redis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>👥 欢迎加入读者群</strong><br>
关注公众号，回复 <strong>【加群】</strong> 即可获取联系方式，期待与你交流技术、共同成长！</p> <h2 id="前置知识铺垫"><a href="#前置知识铺垫" class="header-anchor">#</a> 前置知识铺垫</h2> <h2 id="环境说明"><a href="#环境说明" class="header-anchor">#</a> 环境说明</h2> <p>考虑到大部分读者使用的jdk版本为jdk8，所以笔者选择artahs 3.6.0的源码来展开演示本文的所有内容，无论是macOS还是Windows用户，请严格遵循如下几个环境说明：</p> <ol><li>克隆或者下载arhtas-3.6.0版本：<a href="https://github.com/alibaba/arthas/tree/arthas-all-3.6.0" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/arthas/tree/arthas-all-3.6.0<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ol> <p><img src="https://qiniuyun.sharkchili.com/202512250931490.png" alt=""></p> <ol start="2"><li>调试时，程序会从本地拉取arthas-core和agent文件，请读者提前完成arhtas-3.6.0 zip包的下载：</li></ol> <p><img src="https://qiniuyun.sharkchili.com/202512250931615.png" alt=""></p> <p>并解压到默认读取路径，以mac os为例则是：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>/Users/用户名/.arthas/lib/3.6.0/arthas/arthas-agent.jar和 arthas-core.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对应Windows用户则是：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>C:/Users/用户名/.arthas/lib/3.6.0/arthas/arthas-agent.jar和 arthas-core.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h3 id="jvm如何工作的"><a href="#jvm如何工作的" class="header-anchor">#</a> jvm如何工作的</h3> <p>在此之前，我们还是需要了解一下<code>java</code>程序的执行过程，方便对后文的理解，按照周志明老师《深入理解jvm虚拟机》说法，对应<code>java</code>程序分为前端编译和后端编译，这里前端编译我们可以理解为程序运行前的操作，该阶段会将写好的<code>java</code>代码通过<code>javac</code>编译器编译为虚拟机所能理解的字节码。</p> <p>基于上述的处理构建成字节码也就是程序语言的中间表示形式，我们键入<code>java</code>指令启动程序，此时就会通过<code>C++</code>启动一个虚拟机实例处理上述字节码，也就是将字节码转为本地基础设施也就是操作系统所能识别的指令集并运行，这也就是后端编译，即：
解释器不断解释生成操作系统可理解的机器码运行
对于一些热点代码，虚拟机<code>JIT</code>会将其优化并编译为机器码缓存，后续则以机器码版本运行。基于上述步骤虚拟机以方法作为基本单元，即以栈帧来支持方法的调用和这些指令方法对应的数据结构的执行：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931825.png" alt=""></p> <h3 id="arhtas增强工作机制"><a href="#arhtas增强工作机制" class="header-anchor">#</a> arhtas增强工作机制</h3> <p>因为java是一门半截式半编译的语言，所以在运行时就有了很大的可操作空间，例如我们日常的<code>web</code>接口有大量的业务查询逻辑，就像下面这段代码：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">UserService</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token class-name">JSONObject</span> <span class="token function">findById</span><span class="token punctuation">(</span><span class="token keyword">long</span> id<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//模拟查询和返回用户数据</span>
        <span class="token class-name">ThreadUtil</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token class-name">RandomUtil</span><span class="token punctuation">.</span><span class="token function">randomInt</span><span class="token punctuation">(</span><span class="token number">200</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">JSONObject</span> jsonObject <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JSONObject</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putOnce</span><span class="token punctuation">(</span><span class="token string">&quot;id&quot;</span><span class="token punctuation">,</span> id<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">putOnce</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;张三&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;查询结果:&quot;</span><span class="token operator">+</span>jsonObject<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> jsonObject<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>此时我们为了统一打印输出接口耗时，强行在既有代码中进行各种硬编码不仅非常繁琐，还会让研发人员过分侵入到一些非业务工作以外的事情，影响编码的效率。</p> <p>所以设计者基于java程序运行的特性在<code>jdk5</code>中引入了一种字节码增强的技术，其底层依赖于JVMTI也就是JVM Tool interface，它是JVM暴露出来来用户扩展的接口集合，基于这些接口编写我们就可以拓展开发属于自己的增强逻辑：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931208.png" alt=""></p> <p>该技术范围启动前增强和启动时增强，启动前增强顾名思义则是<code>JVM</code>启动时针对字节码做的增强操作，对应我们可以通过实现如下方法，基于入参<code>instrumentation</code>编写增强逻辑，例如<code>arthas-agent</code>的<code>AgentBootstrap</code>就基于该函数实现了启动前增强逻辑：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">premain</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//字节码增强逻辑</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>然后在打jar包时，通过<code>Premain-Class</code>指定入口类即可：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token operator">&lt;</span>Premain-Class<span class="token operator">&gt;</span>com.taobao.arthas.agent334.AgentBootstrap<span class="token operator">&lt;</span>/Premain-Class<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对应我们也给出运行流程图，如下图，我们通过-jar 参数将打包好的jar包attach到目标虚拟机，在启动前通过<code>addTransformer</code>将字节码转换器添加到目标<code>JVM</code>拦截所有类实现定制化字节码增强。</p> <p>此时，对应JVM进行类加载时，就会通过<code>ClassFileTransformer</code>完成字节码修改实现运行前增强，这种做法最典型的运用场景便是日常的idea破解即通过<code>-javaagent:/xxxx.jar=param</code>指定<code>jar</code>包完成运行前增强修改加密文件和证书：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931426.png" alt=""></p> <p>而另外一种则是运行时增强，最典型的运用就是<code>artahs</code>，运行时增强的实现则是通过实现<code>agentmain</code>函数，对应我们也可以在arthas-agent看到这个函数的实现：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">agentmain</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">,</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">main</span><span class="token punctuation">(</span>args<span class="token punctuation">,</span> inst<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>在<code>agentmain</code>完成增强逻辑后，针对打包的jar通过Agent-Class指定入口类：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code> <span class="token operator">&lt;</span>Agent-Class<span class="token operator">&gt;</span>com.taobao.arthas.agent334.AgentBootstrap<span class="token operator">&lt;</span>/Agent-Class<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对应其工作流程如下图，通过VirtualMachine遍历定位到目标进程后，将agent attach到目标进程，执行agentmain完成jvm实例增强：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931733.png" alt=""></p> <h3 id="arthas对于字节码增强的应用"><a href="#arthas对于字节码增强的应用" class="header-anchor">#</a> arthas对于字节码增强的应用</h3> <p>arthas就是利用运行时增强的典型运用，其本质上就是在运行时通过attach到目标虚拟机，针对匹配的类进行通过高效简洁字节码工具<code>bytekit</code>完成字节码增强，而这也就是arthas的monitor、stack、trace等命令实现的本质。</p> <p>对此笔者也给出一个简单的<code>bytekit</code>示例，我们还是以上面的<code>UserService</code>为例，我们希望针对这个类进行耗时打印同时耗时的逻辑不侵入到业务代码中，对此我们就可以用到阿里的bytekit这款简单易上手的字节码增强工具完成接口耗时打印的字节码增强。</p> <p>首先我们引入相关的依赖，对应依赖和版本如下</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>com.alibaba<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>bytekit-core<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">0.1</span>.<span class="token operator"><span class="token file-descriptor important">5</span>&lt;</span>/version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>

        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>org.benf<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>cfr<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">0.15</span><span class="token operator"><span class="token file-descriptor important">2</span>&lt;</span>/version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>


        <span class="token operator">&lt;</span>dependency<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>groupId<span class="token operator">&gt;</span>net.bytebuddy<span class="token operator">&lt;</span>/groupId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>artifactId<span class="token operator">&gt;</span>byte-buddy-agent<span class="token operator">&lt;</span>/artifactId<span class="token operator">&gt;</span>
            <span class="token operator">&lt;</span>version<span class="token operator">&gt;</span><span class="token number">1.14</span>.<span class="token operator"><span class="token file-descriptor important">9</span>&lt;</span>/version<span class="token operator">&gt;</span>
        <span class="token operator">&lt;</span>/dependency<span class="token operator">&gt;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>然后我们就可以落地下面这样一段代码，即基于<code>bytekit</code>注解声明方法执行前后的增强逻辑，以笔者本次的案例为例，本质就是：</p> <ol><li>通过<code>atEnter</code>注解声明拦截逻辑执行前的逻辑，即记录开始时间，并通过inline指明逻辑直接放在方法内部，这种做法的好处是在于jit进行逃逸分析时可以做一些类似于方法内联等优化执行效率的逻辑</li> <li><code>atEit</code>声明方法执行的后置逻辑，即打印输出耗时</li></ol> <p>对应的拦截器的逻辑如下：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleInterceptor</span>  <span class="token punctuation">{</span>
    
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> start<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@AtEnter</span><span class="token punctuation">(</span>inline <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">atEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//记录开始时间</span>
        start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AtExit</span><span class="token punctuation">(</span>inline <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">atEit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//输出打印被增强的方法总耗时</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;cost:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>随后我们再给出对应的增强逻辑，核心代码如下：</p> <ol><li>解析上述<code>SampleInterceptor</code>注解</li> <li>获取<code>UserService</code>字节码</li> <li>定位到<code>findById</code>，通过解析后得到的<code>processors</code>对该字节码进行增强</li> <li>打印字节码和增强后的逻辑</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 解析定义的 Interceptor类 和相关的注解</span>
        <span class="token class-name">DefaultInterceptorClassParser</span> interceptorClassParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultInterceptorClassParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InterceptorProcessor</span><span class="token punctuation">&gt;</span></span> processors <span class="token operator">=</span> interceptorClassParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">SampleInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载字节码</span>
        <span class="token class-name">ClassNode</span> classNode <span class="token operator">=</span> <span class="token class-name">AsmUtils</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对加载到的字节码做增强处理</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodNode</span> methodNode <span class="token operator">:</span> classNode<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>methodNode<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token string">&quot;findById&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">continue</span><span class="token punctuation">;</span>

            <span class="token class-name">MethodProcessor</span> methodProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodProcessor</span><span class="token punctuation">(</span>classNode<span class="token punctuation">,</span> methodNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InterceptorProcessor</span> interceptor <span class="token operator">:</span> processors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                interceptor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>methodProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取增强后的字节码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token class-name">AsmUtils</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>classNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 查看反编译结果</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Decompiler</span><span class="token punctuation">.</span><span class="token function">decompile</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AgentUtils</span><span class="token punctuation">.</span><span class="token function">reTransform</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">UserService</span> sample <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        sample<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>


    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br></div></div><p>对应的增强后的字节码和耗时增强逻辑结果如下：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931007.png" alt=""></p> <p>为了更好的理解arthas的设计理念和逻辑，笔者也基于上述的demo示例进行设计和封装一个字节码增强工具类Enhancer。辅助我们更好的理解arhtas复杂的源码设计和实现，可以看到通过<code>ByteKit</code>本质上就是要求我们基于注解和方法给出需要声明的逻辑，然后AsmUtils会加载目标类的字节码修改目标方法的逻辑。</p> <p>所以我们的<code>Enhancer</code>对于参数的封装要做到如下几点：</p> <ol><li>明确要求用户传入需要增强的类类型</li> <li>通过抽象类做好注解声明并规范用户要实现的方法</li> <li>明确给出set集合让用户指明需要增强的方法</li></ol> <p>有了上述的参数，我们的增强工具类就可以做到：</p> <ol><li>通过传入的累加器的类类型解析得出拦截处理器</li> <li>加载目标字节码文件</li> <li>通过<code>set</code>过滤出需要增强的目标方法</li> <li>修改目标方法的字节码</li> <li>返回字节码文件</li></ol> <p><img src="https://qiniuyun.sharkchili.com/202512250931284.png" alt=""></p> <p>所以基于这个思路我们封装出了拦截器的抽象类，告知用户可灵活继承实现的扩展点：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 规范性约束
 */</span>
<span class="token keyword">public</span> <span class="token keyword">abstract</span> <span class="token keyword">class</span> <span class="token class-name">AbstractInterceptor</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * 函数入口增强点
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">atEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//nothing to do</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * 函数退出扩展点
     */</span>
    <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">atExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//nothing to do</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>对应的我们的sample继承关系就变为这样：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SampleInterceptor</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractInterceptor</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> start<span class="token punctuation">;</span>

    <span class="token annotation punctuation">@AtEnter</span><span class="token punctuation">(</span>inline <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">atEnter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//记录开始时间</span>
        start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token annotation punctuation">@AtExit</span><span class="token punctuation">(</span>inline <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">)</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">atEit</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//输出打印被增强的方法总耗时</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;cost:&quot;</span> <span class="token operator">+</span> <span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">-</span> start<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><p>在此基础上我们封装一个字节码增强的工具类，即：</p> <ol><li>通过<code>interceptorClzz</code>生成处理器<code>processorList</code></li> <li>通过<code>AsmUtils</code>加载目标类的字节码</li> <li>通过<code>matcherMethod</code>匹配目标方法，并通过<code>processorList</code>修改字节码完成增强</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token comment">/**
 * 字节码增强工具类
 */</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Enhancer</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">Class</span> target<span class="token punctuation">,</span>
                          <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> matcherMethod<span class="token punctuation">,</span>
                          <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">AbstractInterceptor</span><span class="token punctuation">&gt;</span></span> clzz<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token comment">// 解析定义的 Interceptor类 和相关的注解</span>
        <span class="token class-name">DefaultInterceptorClassParser</span> interceptorClassParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultInterceptorClassParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">InterceptorProcessor</span><span class="token punctuation">&gt;</span></span> processorList <span class="token operator">=</span> interceptorClassParser<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>clzz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 加载需要增强的类的字节码</span>
        <span class="token class-name">ClassNode</span> classNode <span class="token operator">=</span> <span class="token class-name">AsmUtils</span><span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span>target<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 对加载到的字节码做增强处理</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodNode</span> methodNode <span class="token operator">:</span> classNode<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//判断是否是匹配的方法,如果不是不做增强</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>matcherMethod<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>methodNode<span class="token punctuation">.</span>name<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">continue</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//基于解析后的processorList对目标进行增强</span>
            <span class="token class-name">MethodProcessor</span> methodProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodProcessor</span><span class="token punctuation">(</span>classNode<span class="token punctuation">,</span> methodNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InterceptorProcessor</span> interceptor <span class="token operator">:</span> processorList<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                interceptor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>methodProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">// 获取增强后的字节码</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> <span class="token class-name">AsmUtils</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>classNode<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">return</span> bytes<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>最后我们再给出使用示例：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">Enhancer</span> enhance <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Enhancer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> bytes <span class="token operator">=</span> enhance<span class="token punctuation">.</span><span class="token function">enhance</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                <span class="token class-name">CollUtil</span><span class="token punctuation">.</span><span class="token function">newHashSet</span><span class="token punctuation">(</span><span class="token string">&quot;findById&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                <span class="token class-name">SampleInterceptor</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 查看反编译结果</span>
        <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token class-name">Decompiler</span><span class="token punctuation">.</span><span class="token function">decompile</span><span class="token punctuation">(</span>bytes<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">AgentUtils</span><span class="token punctuation">.</span><span class="token function">reTransform</span><span class="token punctuation">(</span><span class="token class-name">UserService</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> bytes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//测试修改后的结果是否打印输出耗时</span>
        <span class="token class-name">UserService</span> userService <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UserService</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        userService<span class="token punctuation">.</span><span class="token function">findById</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br></div></div><p>同时我们也给出对应的输出结果：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931663.png" alt=""></p> <h2 id="详解arthas工作全流程"><a href="#详解arthas工作全流程" class="header-anchor">#</a> 详解arthas工作全流程</h2> <h3 id="arthas-boot启动"><a href="#arthas-boot启动" class="header-anchor">#</a> arthas boot启动</h3> <h4 id="宏观流程说明"><a href="#宏观流程说明" class="header-anchor">#</a> 宏观流程说明</h4> <p>通过上述的铺垫，我们已经对<code>arthas</code>运用的核心技术有了初步的了解，接下来笔者将从源码的江都深入分析这一点，首先我们需要从<code>arthas-boot</code>这个程序说起，本质上当我们执行<code>as.sh</code>后，执行脚本就是启动一个<code>arthas-boot</code>进程，对应的执行核心流程为：</p> <ol><li>解析用户参数</li> <li>获取非<code>arthas</code>进程以外的程序，并生成列表在控制台输出</li> <li>等待用户输入需要指定进程序号</li> <li>将目标进程号、<code>arhtas-core</code>和<code>arthas-agent</code>路径作为参数，启动<code>arthas-core.jar</code>让其完成后续工作</li></ol> <p><img src="https://qiniuyun.sharkchili.com/202512250931851.png" alt=""></p> <p>如下图，笔者传入<code>--telnet-port 9999</code>启动<code>arthas-boot</code>，<code>arhtas-boot</code>启动时就会解析参数，然后通过执行jps指令获取非本进程的程序pid，然后生成列表，等待用户选择：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931134.png" alt=""></p> <p>最后将pid号和arhtas-core和arthas一并作为参数启动arthas-core，就像下面这样：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-jar</span> /Users/sharkchili/.arthas/lib/4.1.3/arthas/arthas-core.jar  <span class="token parameter variable">-pid</span>  <span class="token number">61223</span>  -telnet-port <span class="token number">9999</span>, <span class="token parameter variable">-core</span> /Users/sharkchili/.arthas/lib/4.1.3/arthas/arthas-core.jar  <span class="token parameter variable">-agent</span>  /Users/sharkchili/.arthas/lib/4.1.3/arthas/arthas-agent.jar 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><h4 id="参数解析"><a href="#参数解析" class="header-anchor">#</a> 参数解析</h4> <p>对应的笔者也给出对应源码来印证这一点，上述的主流程都位于<code>arthas-boot</code>的<code>Bootstrap</code>的<code>main</code>方法，因为逻辑比较长所以笔者这里逐步拆解分析，首先是参数解析，例如笔者上述传入的telnet参数就会在这里完成解析并绑定到<code>bootstrap</code>：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>		<span class="token class-name">CLI</span> cli <span class="token operator">=</span> <span class="token class-name">CLIConfigurator</span><span class="token punctuation">.</span><span class="token function">define</span><span class="token punctuation">(</span><span class="token class-name">Bootstrap</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//--telnet-port 9999</span>
        <span class="token class-name">CommandLine</span> commandLine <span class="token operator">=</span> cli<span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span><span class="token class-name">Arrays</span><span class="token punctuation">.</span><span class="token function">asList</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token comment">//将参数绑定到bootstrap 此时bootstrap属性就会添加配置的参数值</span>
            <span class="token class-name">CLIConfigurator</span><span class="token punctuation">.</span><span class="token function">inject</span><span class="token punctuation">(</span>commandLine<span class="token punctuation">,</span> bootstrap<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">//......</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h4 id="获取目标进程"><a href="#获取目标进程" class="header-anchor">#</a> 获取目标进程</h4> <p>然后就是查看用户启动参数中是否指明了pid，若没有则调用<code>ProcessUtils</code>的<code>select</code>通过jps指令生成进程列表让用户选择：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code>		<span class="token comment">//查看参数是否指明了pid,若没有</span>
        <span class="token keyword">long</span> pid <span class="token operator">=</span> bootstrap<span class="token punctuation">.</span><span class="token function">getPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 若没有指明pid,则调用select输出所有进程让用户选择</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>pid <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
            		<span class="token comment">//调用jps生成进程列表等待用户选择</span>
                pid <span class="token operator">=</span> <span class="token class-name">ProcessUtils</span><span class="token punctuation">.</span><span class="token function">select</span><span class="token punctuation">(</span>bootstrap<span class="token punctuation">.</span><span class="token function">isVerbose</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> telnetPortPid<span class="token punctuation">,</span> bootstrap<span class="token punctuation">.</span><span class="token function">getSelect</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">InputMismatchException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token comment">//......</span>
            <span class="token punctuation">}</span>
           <span class="token comment">//......</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p>对应的笔者也给出<code>ProcessUtils</code>的<code>select</code>的具体实现展开说明：</p> <ol><li>通过jps获取非本进程以外的java进程</li> <li>生成pid为key，进程pid+启动类的字符串value作为值如<code>57844 org.jetbrains.jps.cmdline.Launcher</code>的map集合</li> <li>按顺序将其输出</li> <li>利用Scanner工具类等待用户终端输入序号</li> <li>返回对应pid，执行后续步骤：</li></ol> <p><img src="https://qiniuyun.sharkchili.com/202512250931394.png" alt=""></p> <p>对应源码如下，大体逻辑和上述说明一致即通过jps获取所有进程，并生成map映射按序输出，随后基于用户选择结果返回指定pid号：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">long</span> <span class="token function">select</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> v<span class="token punctuation">,</span> <span class="token keyword">long</span> telnetPortPid<span class="token punctuation">,</span> <span class="token class-name">String</span> select<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InputMismatchException</span> <span class="token punctuation">{</span>
        <span class="token comment">//执行jps指令生成pid为key 进程详情的value的map</span>
        <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> processMap <span class="token operator">=</span> <span class="token function">listProcessByJps</span><span class="token punctuation">(</span>v<span class="token punctuation">)</span><span class="token punctuation">;</span> 
       	<span class="token comment">//......</span>
        <span class="token comment">// 将进程按序打印,从1开始,方便用户直观选择进程</span>
        <span class="token keyword">int</span> count <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> process <span class="token operator">:</span> processMap<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>count <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;* [&quot;</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">&quot;]: &quot;</span> <span class="token operator">+</span> process<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;  [&quot;</span> <span class="token operator">+</span> count <span class="token operator">+</span> <span class="token string">&quot;]: &quot;</span> <span class="token operator">+</span> process<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            count<span class="token operator">++</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// 等待用户选择</span>
        <span class="token class-name">String</span> line <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span><span class="token class-name">System</span><span class="token punctuation">.</span>in<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextLine</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>line<span class="token punctuation">.</span><span class="token function">trim</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// get the first process id</span>
            <span class="token keyword">return</span> processMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">int</span> choice <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Scanner</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">nextInt</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">//......</span>
        <span class="token comment">//通过数字定位到具体pid号返回</span>
        <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Long</span><span class="token punctuation">&gt;</span></span> idIter <span class="token operator">=</span> processMap<span class="token punctuation">.</span><span class="token function">keySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token keyword">int</span> i <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span> i <span class="token operator">&lt;=</span> choice<span class="token punctuation">;</span> <span class="token operator">++</span>i<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>i <span class="token operator">==</span> choice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> idIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            idIter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br></div></div><h4 id="整合参数启动arthas-core"><a href="#整合参数启动arthas-core" class="header-anchor">#</a> 整合参数启动arthas-core</h4> <p>有了上述解析的参数和pid进程号，<code>arthas-boot</code>就会基于这些信息启动<code>arthas-core</code>，让其完成后续的核心工作(工作内容笔者后文会展开说明)，这里我们先看看<code>artahs-core</code>的最重要的一步<code>arthas-core</code>启动的实现，从源码可以看到其内部会通过<code>attachArgs</code>顺序拼接各种参数，然后生成类似于如下的启动指令启动core：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code><span class="token function">java</span> <span class="token parameter variable">-jar</span> /Users/sharkchili/.arthas/lib/4.1.3/arthas/arthas-core.jar  <span class="token parameter variable">-pid</span>  <span class="token number">61223</span>  -telnet-port <span class="token number">9999</span>, <span class="token parameter variable">-core</span> /Users/sharkchili/.arthas/lib/4.1.3/arthas/arthas-core.jar  <span class="token parameter variable">-agent</span>  /Users/sharkchili/.arthas/lib/4.1.3/arthas/arthas-agent.jar
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>对应逻辑比较简单，就是拼接和解析参数生成启动指令启动<code>jar</code>的逻辑，这里笔者就不多做赘述了：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>telnetPortPid <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">&amp;&amp;</span> pid <span class="token operator">==</span> telnetPortPid<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">AnsiLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;The target process already listen port {}, skip attach.&quot;</span><span class="token punctuation">,</span> bootstrap<span class="token punctuation">.</span><span class="token function">getTelnetPortOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          	 <span class="token comment">//double check telnet port and pid before attach</span>
            telnetPortPid <span class="token operator">=</span> <span class="token function">findProcessByTelnetClient</span><span class="token punctuation">(</span>arthasHomeDir<span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> bootstrap<span class="token punctuation">.</span><span class="token function">getTelnetPortOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">checkTelnetPortPid</span><span class="token punctuation">(</span>bootstrap<span class="token punctuation">,</span> telnetPortPid<span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// start arthas-core.jar</span>
            <span class="token comment">//拼接jar和arhtas-boot路径</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> attachArgs <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;-jar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>arthasHomeDir<span class="token punctuation">,</span> <span class="token string">&quot;arthas-core.jar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;-pid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//......</span>
            <span class="token comment">//拼接我们添加的telnet参数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>bootstrap<span class="token punctuation">.</span><span class="token function">getTelnetPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;-telnet-port&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span> bootstrap<span class="token punctuation">.</span><span class="token function">getTelnetPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>bootstrap<span class="token punctuation">.</span><span class="token function">getHttpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;-http-port&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span> bootstrap<span class="token punctuation">.</span><span class="token function">getHttpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//拼接core和agent的路径绝对路径地址</span>
            attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;-core&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>arthasHomeDir<span class="token punctuation">,</span> <span class="token string">&quot;arthas-core.jar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token string">&quot;-agent&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            attachArgs<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>arthasHomeDir<span class="token punctuation">,</span> <span class="token string">&quot;arthas-agent.jar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getAbsolutePath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//......</span>

            <span class="token class-name">AnsiLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Try to attach process &quot;</span> <span class="token operator">+</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">AnsiLog</span><span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span><span class="token string">&quot;Start arthas-core.jar args: &quot;</span> <span class="token operator">+</span> attachArgs<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//基于上述attachArgs生成启动命令启动arthas-core</span>
            <span class="token class-name">ProcessUtils</span><span class="token punctuation">.</span><span class="token function">startArthasCore</span><span class="token punctuation">(</span>pid<span class="token punctuation">,</span> attachArgs<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//java -jar /Users/sharkchili/.arthas/lib/4.1.3/arthas/arthas-core.jar  -pid  61223  -telnet-port 9999, -core /Users/sharkchili/.arthas/lib/4.1.3/arthas/arthas-core.jar  -agent  /Users/sharkchili/.arthas/lib/4.1.3/arthas/arthas-agent.jar</span>

            <span class="token class-name">AnsiLog</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;Attach process {} success.&quot;</span><span class="token punctuation">,</span> pid<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br></div></div><p>自此我们来小结一下，<code>arthas-boot</code>启动步骤：</p> <ol><li>解析启动参数</li> <li>获取所有java进程生成列表等待用户选择</li> <li>基于选择的pid号和agent和core两个核心模块的绝对路径生成arthas-core指令启动arhtas-core</li></ol> <h3 id="arthas-core-启动"><a href="#arthas-core-启动" class="header-anchor">#</a> arthas-core 启动</h3> <h4 id="执行流程和调试环境说明"><a href="#执行流程和调试环境说明" class="header-anchor">#</a> 执行流程和调试环境说明</h4> <p>我们重点还是关注一下arthas-core的逻辑，它是动态增强并实现动态插桩增强的关键，其内部本质工作本质就是将arthas-agent attach到上一步选定的进程进行动态增强。</p> <p>为了能够调测这段源代码，笔者针对这段调测过程进行一个简要的说明，本质上通过上一步的arthas-boot会启动artahs-core让其将<code>arthas-agent</code>能够attach到运行时的目标虚拟机上，所以为了能够调测的attach的逻辑，arthas的作者也在启动脚本上做了一些手脚。</p> <p>首先我们需要通过as脚本指定<code>--debug-attach</code>将<code>arthas-boot</code>启动，然后我们按照说明选择目标进程，以笔者为例就是一个<code>demo</code>进程，此时远程的<code>arhtas-core</code>就会开启调试模式监听<code>8888</code>端口等待idea远程<code>attach</code>，对应我们idea通过远程调试模式设置8888端口点击执行，此时我们idea就可以开始调测了解arhtas-core如何<code>attach</code>代理工具arthas-agent的逻辑了：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931617.png" alt=""></p> <p>了解整体思路之后，我们就开始搭建调测环境，首先我们编写一个demo程序，并将其通过javac编译：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Demo</span> <span class="token punctuation">{</span>
    <span class="token keyword">static</span> <span class="token keyword">class</span> <span class="token class-name">Counter</span> <span class="token punctuation">{</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token class-name">AtomicInteger</span> count <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AtomicInteger</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            count<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> count<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
        <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">increment</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;counter: &quot;</span> <span class="token operator">+</span> <span class="token class-name">Counter</span><span class="token punctuation">.</span><span class="token function">value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">SECONDS</span><span class="token punctuation">.</span><span class="token function">sleep</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>然后通过jdk8的java指令启动：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>/Users/sharkchili/dev-tool/jdk8/Contents/Home/bin/java  Demo
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>随后，我们再打开<code>arthas</code>源码包<code>bin</code>在终端执行如下指令，并选择<code>demo</code>进程的序号连接：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>./as.sh --use-version <span class="token number">3.6</span>.0 --debug-attach
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>最后idea配置远程模式<code>attach</code>到<code>8888</code>端口：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931813.png" alt=""></p> <p>由此我们就可以愉快的调试<code>arthas-core</code>了：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931154.png" alt=""></p> <p>对应调试步骤笔者也是参考这个issue，感兴趣的读者可以看看:<a href="https://github.com/alibaba/arthas/issues/222" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/arthas/issues/222<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h4 id="工作流程介绍"><a href="#工作流程介绍" class="header-anchor">#</a> 工作流程介绍</h4> <p>arthas-core(以下简称为core)的逻辑比较简单，通过上文介绍我们知道arthas-boot在启动core的时候给定了一些参数，定位目标虚拟机pid号，通过agent参数指明的arthas-agent.jar attach到该虚拟机进程下。</p> <p>对应源代码入口位于arhtas-core包的Arthas的main方法，其内部就是创建一个arthas对象，本质就是执行：</p> <ol><li>parse解析获取所有启动core的参数</li> <li>调用attach将参数给定路径的agent attach到目标虚拟机进程(也就是我们的demo)</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code>  <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">new</span> <span class="token class-name">Arthas</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//......</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token class-name">Arthas</span><span class="token punctuation">(</span><span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token function">attachAgent</span><span class="token punctuation">(</span><span class="token function">parse</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>我们直接查看<code>attachAgent</code>可以看到笔者说明的3块核心逻辑：</p> <ol><li>通过<code>VirtualMachine.list()</code>定位所有java进程，遍历匹配到目标进程的虚拟机描述符</li> <li>通过<code>attach</code>连接到目标虚拟机进程</li> <li>基于配置定位<code>arhtas-agent</code>本地路径，通过<code>loadAgent</code>将<code>arthas-agent</code>加载到目标虚拟机上</li></ol> <p>逻辑比较简单，读者可以结合注释理解笔者上面所说的步骤，本质就是基于参数将agent attach到目标虚拟机进程，开始后续最最核心的字节码增强实现各种监控诊断指令：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">attachAgent</span><span class="token punctuation">(</span><span class="token class-name">Configure</span> configure<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">VirtualMachineDescriptor</span> virtualMachineDescriptor <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token comment">//定位到被代理的虚拟机进程号</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">VirtualMachineDescriptor</span> descriptor <span class="token operator">:</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">list</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token class-name">String</span> pid <span class="token operator">=</span> descriptor<span class="token punctuation">.</span><span class="token function">id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>pid<span class="token punctuation">.</span><span class="token function">equals</span><span class="token punctuation">(</span><span class="token class-name">Long</span><span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getJavaPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                virtualMachineDescriptor <span class="token operator">=</span> descriptor<span class="token punctuation">;</span>
                <span class="token keyword">break</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token comment">//将</span>
        <span class="token class-name">VirtualMachine</span> virtualMachine <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">null</span> <span class="token operator">==</span> virtualMachineDescriptor<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">// 使用 attach(String pid) 这种方式</span>
                virtualMachine <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span><span class="token string">&quot;&quot;</span> <span class="token operator">+</span> configure<span class="token punctuation">.</span><span class="token function">getJavaPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                virtualMachine <span class="token operator">=</span> <span class="token class-name">VirtualMachine</span><span class="token punctuation">.</span><span class="token function">attach</span><span class="token punctuation">(</span>virtualMachineDescriptor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">//......</span>
					<span class="token comment">//定位agent绝对路径</span>
            <span class="token class-name">String</span> arthasAgentPath <span class="token operator">=</span> configure<span class="token punctuation">.</span><span class="token function">getArthasAgent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//convert jar path to unicode string</span>
            configure<span class="token punctuation">.</span><span class="token function">setArthasAgent</span><span class="token punctuation">(</span><span class="token function">encodeArg</span><span class="token punctuation">(</span>arthasAgentPath<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            configure<span class="token punctuation">.</span><span class="token function">setArthasCore</span><span class="token punctuation">(</span><span class="token function">encodeArg</span><span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getArthasCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span><span class="token comment">//加载arthas-agent.jar,对当前进程进行增强操作</span>
                virtualMachine<span class="token punctuation">.</span><span class="token function">loadAgent</span><span class="token punctuation">(</span>arthasAgentPath<span class="token punctuation">,</span>
                        configure<span class="token punctuation">.</span><span class="token function">getArthasCore</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot;;&quot;</span> <span class="token operator">+</span> configure<span class="token punctuation">.</span><span class="token function">toString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">//......</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
            <span class="token comment">//......</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br></div></div><h3 id="arthas-agent-增强-重点"><a href="#arthas-agent-增强-重点" class="header-anchor">#</a> arthas agent 增强(重点)</h3> <h4 id="宏观流程介绍"><a href="#宏观流程介绍" class="header-anchor">#</a> 宏观流程介绍</h4> <p>自此我们就可以正式的开始分析arthas最核心的一个部分，即动态增强了，通过上述的步骤我们将artahs-agent attach到指定pid的虚拟机中，接下来我们就要通过源码的分析的方式了解，attach后的agent做了那些事情。</p> <p>当arthas-agent attach目标jvm之后，就需要做到拦截所有类确保在必要时刻能够做到运行时动态增强，这时就需要用到<code>agentmain</code>方法，即通过配置中指定<code>Agent-Class</code>，确保加载到目标虚拟机的agent可以执行对应<code>agentmain</code>方法，执行必要的初始化流程(后文会展开详解)，生成一个arthas服务端监听3658端口，等待客户端连接：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931509.png" alt=""></p> <h4 id="调试环境搭建"><a href="#调试环境搭建" class="header-anchor">#</a> 调试环境搭建</h4> <p>为了更好的了解这个流程，笔者也介绍一下关于arthas-agent attach的详细流程，首先我们需要启动上述的demo并以监听模式运行，因为笔者环境默认jdk为jdk11，所以这里手动的指定了一下jdk版本：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code> /Users/sharkchili/dev-tool/jdk8/Contents/Home/bin/java <span class="token parameter variable">-Xdebug</span> <span class="token parameter variable">-Xrunjdwp:transport</span><span class="token operator">=</span>dt_socket,server<span class="token operator">=</span>y,address<span class="token operator">=</span><span class="token number">8000</span> Demo

</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br></div></div><p>然后arhtas源码通过远程连接的方式连接8000端口：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931688.png" alt=""></p> <p>最后我们启动as脚本，并选择demo进程，执行到arhtas attach环节时，代码就会来到arhtas agent
包下AgentBootstrap的agentMain方法：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931820.png" alt=""></p> <h4 id="attach流程说明"><a href="#attach流程说明" class="header-anchor">#</a> attach流程说明</h4> <p>从上文的调试截图可以看到，其内部本质就是拿着<code>Instrumentation</code>引入动态增强的逻辑，我们步入<code>main</code>方法可以看到，其内部核心逻辑为：</p> <ol><li>拉取<code>core</code>路径获取对应的类加载器</li> <li>调用core包的类加载ArthasBootstrap.class</li> <li>基于ArthasBootstrap.class初始化启动arhtas服务端监听3658端口(默认情况下)</li></ol> <p><img src="https://qiniuyun.sharkchili.com/202512250931115.png" alt=""></p> <p>对应<code>main</code>的源码如下，他会从<code>args</code>中获取agent和core的路径然后拉取加载器启动一个<code>bindingThread</code>启动<code>shellServer</code>也就是<code>arthas</code>服务端：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">main</span><span class="token punctuation">(</span><span class="token class-name">String</span> args<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Instrumentation</span> inst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 尝试判断arthas是否已在运行，如果是的话，直接就退出</span>
       
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            ps<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Arthas server agent start...&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">// 传递的args参数分两个部分:arthasCoreJar路径和agentArgs, 分别是Agent的JAR包路径和期望传递到服务端的参数</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>args <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                args <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            args <span class="token operator">=</span> <span class="token function">decodeArg</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
					<span class="token comment">//获取core包合agent包路径</span>
            <span class="token class-name">String</span> arthasCoreJar<span class="token punctuation">;</span>
            <span class="token keyword">final</span> <span class="token class-name">String</span> agentArgs<span class="token punctuation">;</span>
            <span class="token keyword">int</span> index <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">indexOf</span><span class="token punctuation">(</span><span class="token char">';'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>index <span class="token operator">!=</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            		<span class="token comment">//从参数中获取arhtas core jar 路径</span>
                arthasCoreJar <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> index<span class="token punctuation">)</span><span class="token punctuation">;</span> 
                <span class="token comment">//从参数中获取arthas agent jar路径</span>
                agentArgs <span class="token operator">=</span> args<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                arthasCoreJar <span class="token operator">=</span> <span class="token string">&quot;&quot;</span><span class="token punctuation">;</span>
                agentArgs <span class="token operator">=</span> args<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>


             <span class="token operator">*</span><span class="token operator">/</span>
             <span class="token comment">//获取core jar的类加载器</span>
            <span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> agentLoader <span class="token operator">=</span> <span class="token function">getClassLoader</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> arthasCoreJarFile<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token class-name">Thread</span> bindingThread <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">try</span> <span class="token punctuation">{</span>
                        <span class="token function">bind</span><span class="token punctuation">(</span>inst<span class="token punctuation">,</span> agentLoader<span class="token punctuation">,</span> agentArgs<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//启动arthas服务端</span>
                    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> throwable<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        throwable<span class="token punctuation">.</span><span class="token function">printStackTrace</span><span class="token punctuation">(</span>ps<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">;</span>

            bindingThread<span class="token punctuation">.</span><span class="token function">setName</span><span class="token punctuation">(</span><span class="token string">&quot;arthas-binding-thread&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bindingThread<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            bindingThread<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//......</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br></div></div><p>此时逻辑就到了<code>getInstance</code>的<code>getInstance</code>单例实现，其内部会解析参数完成完成如下工作：</p> <ol><li><code>initFastjson</code>：初始化<code>json</code>工具规则配置</li> <li>initSpy(重点)：将<code>SpyAPI</code>添加到当前<code>bootstrap</code>类加载器中</li> <li><code>initArthasEnvironment</code>：初始化arthas环境变量</li> <li>创建arthas日志输出文件夹arthas-output</li> <li><code>LogUtil</code>初始化日志工具</li> <li>增强<code>ClassLoader</code>：解决解决一些 ClassLoader 加载不到 SpyAPI的问题所以才要增强<code>ClassLoader</code></li> <li>init beans：初始化一些视图窗口消息输入输出解析器和<code>history</code>指令管理器</li> <li>bind：重点启动arthas server</li> <li>初始化<code>executorService</code>线程池执行后监听并处理后续用户的监控诊断指令的异步任务</li> <li>创建一个shutdown线程注册虚拟机钩子监听关闭事件以便及时关闭ArthasBootstrap</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">ArthasBootstrap</span><span class="token punctuation">(</span><span class="token class-name">Instrumentation</span> instrumentation<span class="token punctuation">,</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">String</span><span class="token punctuation">,</span> <span class="token class-name">String</span><span class="token punctuation">&gt;</span></span> args<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>instrumentation <span class="token operator">=</span> instrumentation<span class="token punctuation">;</span>
				<span class="token comment">//初始化json工具规则配置</span>
        <span class="token function">initFastjson</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 2. 将SpyAPI添加到当前bootstrap类加载器中</span>
        <span class="token function">initSpy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 3. 初始化arthas环境变量</span>
        <span class="token function">initArthasEnvironment</span><span class="token punctuation">(</span>args<span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//4. 创建arthas日志输出目录</span>
        <span class="token class-name">String</span> outputPathStr <span class="token operator">=</span> configure<span class="token punctuation">.</span><span class="token function">getOutputPath</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>outputPathStr <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            outputPathStr <span class="token operator">=</span> <span class="token class-name">ArthasConstants</span><span class="token punctuation">.</span><span class="token constant">ARTHAS_OUTPUT</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        outputPath <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>outputPathStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
        outputPath<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 5. 初始化日志工具</span>
        loggerContext <span class="token operator">=</span> <span class="token class-name">LogUtil</span><span class="token punctuation">.</span><span class="token function">initLogger</span><span class="token punctuation">(</span>arthasEnvironment<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 4. 增强ClassLoader</span>
        <span class="token function">enhanceClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 5. 初始化一些视图解析器和history管理bean</span>
        <span class="token function">initBeans</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// 6. 启动agent server</span>
        <span class="token function">bind</span><span class="token punctuation">(</span>configure<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token comment">//初始化命令解析的线程池</span>
        executorService <span class="token operator">=</span> <span class="token class-name">Executors</span><span class="token punctuation">.</span><span class="token function">newScheduledThreadPool</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">ThreadFactory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token class-name">Thread</span> <span class="token function">newThread</span><span class="token punctuation">(</span><span class="token class-name">Runnable</span> r<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">final</span> <span class="token class-name">Thread</span> t <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span>r<span class="token punctuation">,</span> <span class="token string">&quot;arthas-command-execute&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                t<span class="token punctuation">.</span><span class="token function">setDaemon</span><span class="token punctuation">(</span><span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> t<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token comment">//注册虚拟机钩子</span>
        shutdown <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Thread</span><span class="token punctuation">(</span><span class="token string">&quot;as-shutdown-hooker&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>

            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token class-name">ArthasBootstrap</span><span class="token punctuation">.</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">destroy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>

        transformerManager <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TransformerManager</span><span class="token punctuation">(</span>instrumentation<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Runtime</span><span class="token punctuation">.</span><span class="token function">getRuntime</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addShutdownHook</span><span class="token punctuation">(</span>shutdown<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br></div></div><h2 id="详解arthasbootstrap启动核心流程"><a href="#详解arthasbootstrap启动核心流程" class="header-anchor">#</a> 详解ArthasBootstrap启动核心流程</h2> <h3 id="详解spy初始化-重点"><a href="#详解spy初始化-重点" class="header-anchor">#</a> 详解spy初始化(重点)</h3> <p>上文宏观说明了<code>ArthasBootstrap</code>整体流程，因为整体流程实现细节较多，所以笔者打算抽取一个篇幅逐步拆解这块流程，先来说说<code>initSpy</code>，该流程本质就是通过根加载器将搜寻<code>SpyAPI</code>这个<code>class</code>是否存在，若不存在则定位到对应的jar包物理地址将其添加到当前虚拟机(例如我们需要增强的Demo)程序：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931382.png" alt=""></p> <p>这里我们需要了解两个问题：</p> <ol><li>为什么需要加载<code>SpyAPI</code></li> <li>为什么需要通过根加载器进行加载</li></ol> <h4 id="为什么需要加载spyapi"><a href="#为什么需要加载spyapi" class="header-anchor">#</a> 为什么需要加载SpyAPI</h4> <p>我们查看SpyAPI是arthas增强的核心抽象类，它是增强操作逻辑的具体实现者，arhtas在进行增强时本质就是通过SpyAPI的调用实现的，SpyAPI内置了一个spyInstance，当我们针对特定实现类通过stack或者trace指令针对类进行动态增强观察其堆栈或者耗时时，本质就是通过SpyAPI对应atEnter的方法定位到每个指令的监听器执行函数增强。</p> <p>例如我们针对Demo类increment执行watch指令，arhtas的增强操作就是通过增强器在方法前后插入SpyAPI的调用，每当程序执行increment操作时就会调用SpyAPI的atEnter、atExit等方法，而这些方法就会搜寻到watch指令的监听器并执行对应逻辑：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931564.png" alt=""></p> <p>对应我们这里也先给出<code>SpyAPI</code>的源代码，可以看到其内部暴露了<code>setSpy</code>及其atEnter等增强函数，其内部本质都是调用<code>spyInstance</code>通过<code>atEnter</code>获取对应指令的监听器执行前置或者后置的增强逻辑：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">SpyAPI</span> <span class="token punctuation">{</span>
    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">AbstractSpy</span> <span class="token constant">NOPSPY</span> <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NopSpy</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token class-name">AbstractSpy</span> spyInstance <span class="token operator">=</span> <span class="token constant">NOPSPY</span><span class="token punctuation">;</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> <span class="token constant">INITED</span><span class="token punctuation">;</span>

    <span class="token comment">//......</span>
		<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">setSpy</span><span class="token punctuation">(</span><span class="token class-name">AbstractSpy</span> spy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        spyInstance <span class="token operator">=</span> spy<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">atEnter</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">String</span> methodInfo<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        spyInstance<span class="token punctuation">.</span><span class="token function">atEnter</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> methodInfo<span class="token punctuation">,</span> target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h4 id="为什么需要通过根加载器进行加载"><a href="#为什么需要通过根加载器进行加载" class="header-anchor">#</a> 为什么需要通过根加载器进行加载</h4> <p>通常情况下，java类加载器分为如下几种：</p> <ol><li>bootstrap类加载器：由c++实现，是虚拟机自身的一部分，主要负责加载lib目录下存放的类</li> <li>extension类加载器： 主要加载lib目录下ext目录中的类</li> <li>application 应用加载器，主要加载用户类路径下所有的类库</li></ol> <p>按照JVM双亲委派模型的说法，当进行类加载时，所有类都会优先将请求委托给父类，明确父类搜寻范围找不到对应类而无法完成加载后，才会自己尝试加载，由此保证rt.jar等基础核心jar包类加载安全，同理，为了避免加载spy这个核心增强的接口被破坏，arthas就会强制指明用根加载器完成加载，确保所有类都能够准确的加载到这个类：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token comment">// 将Spy添加到BootstrapClassLoader</span>
        <span class="token class-name">ClassLoader</span> parent <span class="token operator">=</span> <span class="token class-name">ClassLoader</span><span class="token punctuation">.</span><span class="token function">getSystemClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">getParent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> spyClass <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>parent <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                spyClass <span class="token operator">=</span>parent<span class="token punctuation">.</span><span class="token function">loadClass</span><span class="token punctuation">(</span><span class="token string">&quot;java.arthas.SpyAPI&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// ignore</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><h3 id="启动arthas-server"><a href="#启动arthas-server" class="header-anchor">#</a> 启动arthas server</h3> <p>我们重点还是关注一下启动<code>arthas server</code>这一步，该步骤由bind方法负责，工作线程在cas成功后上锁后，顺序执行如下步骤：</p> <ol><li>会通过读取启动参数确认启动方式(默认是telnet server对应3658端口)的配置创建<code>shellServer</code></li> <li>初始化创建命令集合对象<code>BuiltinCommandPack</code>，其内部包含例如jad即JadCommand、stack即StackCommand这些命令的抽象实现类</li> <li>基于netty创建workerGroup作为服务端的连接处理工作线程组</li> <li>初始化server对象并添加到<code>termServers</code>容器中</li> <li>变量<code>termServers</code>调用listen开启服务端监听</li></ol> <p>对应完成后的服务端架构图如下所示，可以看到shellServer用termServers维护不同的网络服务端，同时用sessions维护用户会话，而常见的命令抽象也都以类似于BuiltinCommandPack这样的封装集合容器维护到resolvers容器中：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931963.png" alt=""></p> <p>对应我们也给出<code>bind</code>对应实现，正如笔者所说在<code>cas</code>修改状态保证线程互斥后，初始化<code>shellServer</code>完成：</p> <ol><li>服务端初始化</li> <li>命令初始化</li> <li>启动服务端监听</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">Configure</span> configure<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>

        <span class="token keyword">long</span> start <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">.</span><span class="token function">currentTimeMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>isBindRef<span class="token punctuation">.</span><span class="token function">compareAndSet</span><span class="token punctuation">(</span><span class="token boolean">false</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//cas 改变状态</span>
            <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;already bind&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">//......</span>

        <span class="token keyword">try</span> <span class="token punctuation">{</span> <span class="token comment">//初始化shell server 欢迎输出等信息</span>
            <span class="token class-name">ShellServerOptions</span> options <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShellServerOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setInstrumentation</span><span class="token punctuation">(</span>instrumentation<span class="token punctuation">)</span>
                            <span class="token punctuation">.</span><span class="token function">setPid</span><span class="token punctuation">(</span><span class="token class-name">PidUtils</span><span class="token punctuation">.</span><span class="token function">currentLongPid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token comment">//atacch 的pid</span>
                            <span class="token punctuation">.</span><span class="token function">setWelcomeMessage</span><span class="token punctuation">(</span><span class="token class-name">ArthasBanner</span><span class="token punctuation">.</span><span class="token function">welcome</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getSessionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                options<span class="token punctuation">.</span><span class="token function">setSessionTimeout</span><span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getSessionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">*</span> <span class="token number">1000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

			   <span class="token comment">//......</span>
            shellServer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ShellServerImpl</span><span class="token punctuation">(</span>options<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">//......</span>
          <span class="token comment">//初始化BuiltinCommandPack内部包含jad、monitor等执行的抽象</span>
            <span class="token class-name">BuiltinCommandPack</span> builtinCommands <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BuiltinCommandPack</span><span class="token punctuation">(</span>disabledCommands<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//绑定命令</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CommandResolver</span><span class="token punctuation">&gt;</span></span> resolvers <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CommandResolver</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            resolvers<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>builtinCommands<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//worker group</span>
            workerGroup <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NioEventLoopGroup</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">DefaultThreadFactory</span><span class="token punctuation">(</span><span class="token string">&quot;arthas-TermServer&quot;</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// 基于配置创建并注册HttpTelnetTermServer、HttpTermServer等服务端</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getTelnetPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> configure<span class="token punctuation">.</span><span class="token function">getTelnetPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;try to bind telnet server, host: {}, port: {}.&quot;</span><span class="token punctuation">,</span> configure<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configure<span class="token punctuation">.</span><span class="token function">getTelnetPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                shellServer<span class="token punctuation">.</span><span class="token function">registerTermServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpTelnetTermServer</span><span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configure<span class="token punctuation">.</span><span class="token function">getTelnetPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        options<span class="token punctuation">.</span><span class="token function">getConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> workerGroup<span class="token punctuation">,</span> httpSessionManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;telnet port is {}, skip bind telnet server.&quot;</span><span class="token punctuation">,</span> configure<span class="token punctuation">.</span><span class="token function">getTelnetPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getHttpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> configure<span class="token punctuation">.</span><span class="token function">getHttpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;try to bind http server, host: {}, port: {}.&quot;</span><span class="token punctuation">,</span> configure<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configure<span class="token punctuation">.</span><span class="token function">getHttpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                shellServer<span class="token punctuation">.</span><span class="token function">registerTermServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpTermServer</span><span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configure<span class="token punctuation">.</span><span class="token function">getHttpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                        options<span class="token punctuation">.</span><span class="token function">getConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> workerGroup<span class="token punctuation">,</span> httpSessionManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token comment">// listen local address in VM communication</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getTunnelServer</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    shellServer<span class="token punctuation">.</span><span class="token function">registerTermServer</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">HttpTermServer</span><span class="token punctuation">(</span>configure<span class="token punctuation">.</span><span class="token function">getIp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> configure<span class="token punctuation">.</span><span class="token function">getHttpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                            options<span class="token punctuation">.</span><span class="token function">getConnectionTimeout</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> workerGroup<span class="token punctuation">,</span> httpSessionManager<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token function">logger</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">info</span><span class="token punctuation">(</span><span class="token string">&quot;http port is {}, skip bind http server.&quot;</span><span class="token punctuation">,</span> configure<span class="token punctuation">.</span><span class="token function">getHttpPort</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
					<span class="token comment">//遍历resolvers集合中的命令包将其添加到shellServer的命令管理容器中</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">CommandResolver</span> resolver <span class="token operator">:</span> resolvers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                shellServer<span class="token punctuation">.</span><span class="token function">registerCommandResolver</span><span class="token punctuation">(</span>resolver<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
					<span class="token comment">//内部遍历刚刚注册的服务端并启动监听</span>
            shellServer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BindHandler</span><span class="token punctuation">(</span>isBindRef<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//监听</span>
            <span class="token comment">//......</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">//......</span>

        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br></div></div><p>笔者这里也给出对应监听的实现，本质上就是遍历各个<code>server</code>并配置消息处理器<code>TermServerTermHandler</code>执行<code>listen</code>监听并通过<code>TermServerTermHandler</code>处理请求：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">ShellServer</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">Handler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">Void</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> listenHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">final</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TermServer</span><span class="token punctuation">&gt;</span></span> toStart<span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//......</span>
            toStart <span class="token operator">=</span> termServers<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        
      	<span class="token comment">//......</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">TermServer</span> termServer <span class="token operator">:</span> toStart<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//遍历启动创建的对应网络通信方式的server</span>
            termServer<span class="token punctuation">.</span><span class="token function">termHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TermServerTermHandler</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//服务器server绑定 terminal handler</span>
            termServer<span class="token punctuation">.</span><span class="token function">listen</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//监听网络请求，收到的请求就会交由TermServerTermHandler也就是上一步初始化的处理器处理请求</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><h3 id="客户端建立连接"><a href="#客户端建立连接" class="header-anchor">#</a> 客户端建立连接</h3> <p>明确上述服务端建立之后，<code>arthas</code>会为我们分配一个客户端与其建立连接，分别执行：</p> <ol><li>创建会话<code>session</code></li> <li>终端输出欢迎信息</li> <li>将会话保存到服务端缓存<code>sessions</code>中</li> <li>监听客户端输入，并通过<code>ShellLineHandler</code>处理请求</li></ol> <p><img src="https://qiniuyun.sharkchili.com/202512250931239.png" alt=""></p> <p>对应笔者给出<code>HttpTelnetTermServer</code>处理客户端连接处理的入口：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">TermServer</span> <span class="token function">listen</span><span class="token punctuation">(</span><span class="token class-name">Handler</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Future</span><span class="token punctuation">&lt;</span><span class="token class-name">TermServer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> listenHandler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
       <span class="token comment">//初始化bootstrap</span>
        bootstrap <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">NettyHttpTelnetTtyBootstrap</span><span class="token punctuation">(</span>workerGroup<span class="token punctuation">,</span> httpSessionManager<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setHost</span><span class="token punctuation">(</span>hostIp<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">setPort</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            bootstrap<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Consumer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TtyConnection</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token annotation punctuation">@Override</span>
                <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">accept</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">TtyConnection</span> conn<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                		<span class="token comment">//监听TermServerTermHandler收到的请求并调用handle方法处理</span>
                    termHandler<span class="token punctuation">.</span><span class="token function">handle</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">TermImpl</span><span class="token punctuation">(</span><span class="token class-name">Helper</span><span class="token punctuation">.</span><span class="token function">loadKeymap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> conn<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>connectionTimeout<span class="token punctuation">,</span> <span class="token class-name">TimeUnit</span><span class="token punctuation">.</span><span class="token constant">MILLISECONDS</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token comment">//......</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//......</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p><code>TermServerTermHandler</code>最终会执行到<code>ShellServerImpl</code>的<code>handleTerm</code>完成上文所说的<code>session</code>初始化和<code>readline</code>监听命令请求的核心逻辑，逻辑比较直观，读者可以结合注释了解：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handleTerm</span><span class="token punctuation">(</span><span class="token class-name">Term</span> term<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//保证停止后可以及时停止连接</span>
            <span class="token comment">// That might happen with multiple ser</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                term<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
			<span class="token comment">// 创建本地会话session，为其分配命令列表、instrumentation(引入spy的代码插桩实例)</span>
        <span class="token class-name">ShellImpl</span> session <span class="token operator">=</span> <span class="token function">createShell</span><span class="token punctuation">(</span>term<span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token comment">//......</span>
        <span class="token comment">//终端输出欢迎信息</span>
        session<span class="token punctuation">.</span><span class="token function">init</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">//缓存session信息</span>
        sessions<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>session<span class="token punctuation">.</span>id<span class="token punctuation">,</span> session<span class="token punctuation">)</span><span class="token punctuation">;</span> 
        <span class="token comment">//监听用户的输入命令</span>
        session<span class="token punctuation">.</span><span class="token function">readline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><h3 id="基于stack了解arthas设计理念与工作机制"><a href="#基于stack了解arthas设计理念与工作机制" class="header-anchor">#</a> 基于stack了解arthas设计理念与工作机制</h3> <p>在建立服务端之后，对应会话session.readline();监听客户端请求，例如笔者希望通过stack指令了解increment方法的执行堆栈信息：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>stack Demo<span class="token variable">$Counter</span> increment  <span class="token parameter variable">-n</span> <span class="token number">5</span> 
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>其实<code>session</code>收到请求后会通过<code>ShellLineHandler</code>处理该请求，对应<code>ShellLineHandler</code>内部执行核心逻辑为：</p> <ol><li>解析指令<code>token</code>获取指令字符串，对应本次示例就是<code>stack</code>字符串</li> <li>基于指令字符串stack获取对应<code>command</code>对应本例就是<code>StackCommand</code>并封装成<code>ProcessImpl</code></li> <li>基于上述<code>ProcessImpl</code>处理器、<code>session</code>会话等信息构成<code>JobImpl</code></li> <li><code>JobImpl</code>执行<code>run</code>方法将上文的<code>ProcessImpl</code>(包含命令以及命令上下文信息)封装成<code>CommandProcessTask</code>提交到上文初始化好的线程池<code>executorService</code>中</li> <li>重点来了，异步任务运行后<code>StackCommand</code>对应抽象父类<code>EnhancerCommand</code>对应<code>enhance</code>逻辑会针对命令对应的类执行插桩操作，即通过上文说明的<code>ByteKit</code>这个工具封装的而成的<code>InterceptorProcessor</code>针对目标类匹配方法进行字节码增强，本质上就是结合当前指令(例如本例的stack)获取对应监听器，以当前类作为key，监听器列表作为value缓存到全局map中，后续完成插桩后的类执行atEnter调用时就会通过全局监听器定位到当前类的监听器完成执行增强逻辑：</li></ol> <p><img src="https://qiniuyun.sharkchili.com/202512250931015.png" alt=""></p> <p>了解宏观流程后，我们给出<code>ShellLineHandler</code>的<code>handle</code>方法，本质就是解析传入的命令line，然后按照上面说的解析命令等信息封装成<code>process</code>(包含命令抽象和session)从而构建出job，然后调用run方法：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">handle</span><span class="token punctuation">(</span><span class="token class-name">String</span> line<span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//stack Demo$Counter increment</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>line <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// EOF</span>
            <span class="token function">handleExit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">CliToken</span><span class="token punctuation">&gt;</span></span> tokens <span class="token operator">=</span> <span class="token class-name">CliTokens</span><span class="token punctuation">.</span><span class="token function">tokenize</span><span class="token punctuation">(</span>line<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">CliToken</span> first <span class="token operator">=</span> <span class="token class-name">TokenUtils</span><span class="token punctuation">.</span><span class="token function">findFirstTextToken</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//拿到一个 token得到对应的指令</span>
       <span class="token comment">//......</span>

        <span class="token class-name">Job</span> job <span class="token operator">=</span> <span class="token function">createJob</span><span class="token punctuation">(</span>tokens<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>job <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            job<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//提交到线程池</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br></div></div><p>由此来到JobImpl的run方法，由此看到最核心的逻辑，即将<code>process</code>处理器封装到<code>CommandProcessTask</code>提交到线程池中运行：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token class-name">Job</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> foreground<span class="token punctuation">)</span> <span class="token punctuation">{</span>
			<span class="token comment">//......</span>
        process<span class="token punctuation">.</span><span class="token function">setSession</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>session<span class="token punctuation">)</span><span class="token punctuation">;</span>
        process<span class="token punctuation">.</span><span class="token function">run</span><span class="token punctuation">(</span>foreground<span class="token punctuation">)</span><span class="token punctuation">;</span>

				<span class="token comment">//......</span>
        
        <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>


<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token keyword">boolean</span> fg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      		<span class="token comment">//......</span>
        <span class="token class-name">Runnable</span> task <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">CommandProcessTask</span><span class="token punctuation">(</span>process<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//封装成任务</span>
        <span class="token class-name">ArthasBootstrap</span><span class="token punctuation">.</span><span class="token function">getInstance</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span>task<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//丢到无界线程池中</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br></div></div><p>经过层层抽象调用来到执行<code>stackCommand</code>的<code>process</code>，即执行抽象父类的通用增强逻辑：</p> <ol><li>匹配定位要拦截的方法，插入<code>SpyAPI</code>的<code>atEnter</code>等方法完成字节码增强</li> <li>定位子类即<code>stackCommand</code>的监听器以当前目标类为key，监听器为<code>value</code>缓存到全局监听器</li> <li>返回增强后的字节码</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> <span class="token function">transform</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">ClassLoader</span> inClassLoader<span class="token punctuation">,</span> <span class="token class-name">String</span> className<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> classBeingRedefined<span class="token punctuation">,</span>
            <span class="token class-name">ProtectionDomain</span> protectionDomain<span class="token punctuation">,</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> classfileBuffer<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IllegalClassFormatException</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
          	<span class="token comment">//......</span>

          

           <span class="token comment">//拿到原有的代码的字节码</span>
            <span class="token class-name">ClassNode</span> classNode <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ClassNode</span><span class="token punctuation">(</span><span class="token class-name">Opcodes</span><span class="token punctuation">.</span><span class="token constant">ASM9</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ClassReader</span> classReader <span class="token operator">=</span> <span class="token class-name">AsmUtils</span><span class="token punctuation">.</span><span class="token function">toClassNode</span><span class="token punctuation">(</span>classfileBuffer<span class="token punctuation">,</span> classNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
           
            <span class="token comment">// 生成增强字节码</span>
            <span class="token class-name">DefaultInterceptorClassParser</span> defaultInterceptorClassParser <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultInterceptorClassParser</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">//......</span>

					<span class="token comment">//过滤匹配需要增强的目标方法</span>
            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodNode</span><span class="token punctuation">&gt;</span></span> matchedMethods <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">MethodNode</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodNode</span> methodNode <span class="token operator">:</span> classNode<span class="token punctuation">.</span>methods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">isIgnore</span><span class="token punctuation">(</span>methodNode<span class="token punctuation">,</span> methodNameMatcher<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    matchedMethods<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>methodNode<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>

              <span class="token comment">//......</span>

           

            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">MethodNode</span> methodNode <span class="token operator">:</span> matchedMethods<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                
                <span class="token comment">// 先查找是否有 atBeforeInvoke 函数，如果有，则说明已经有trace了，则直接不再尝试增强，直接插入 listener</span>
                <span class="token keyword">if</span><span class="token punctuation">(</span><span class="token class-name">AsmUtils</span><span class="token punctuation">.</span><span class="token function">containsMethodInsnNode</span><span class="token punctuation">(</span>methodNode<span class="token punctuation">,</span> <span class="token class-name">Type</span><span class="token punctuation">.</span><span class="token function">getInternalName</span><span class="token punctuation">(</span><span class="token class-name">SpyAPI</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;atBeforeInvoke&quot;</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                     <span class="token comment">//......</span>
                <span class="token punctuation">}</span><span class="token keyword">else</span> <span class="token punctuation">{</span>
                    <span class="token class-name">MethodProcessor</span> methodProcessor <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MethodProcessor</span><span class="token punctuation">(</span>classNode<span class="token punctuation">,</span> methodNode<span class="token punctuation">,</span> groupLocationFilter<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//遍历所有interceptor针对匹配的目标方法进行增强操作</span>
                    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">InterceptorProcessor</span> interceptor <span class="token operator">:</span> interceptorProcessors<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">try</span> <span class="token punctuation">{</span>
                            <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Location</span><span class="token punctuation">&gt;</span></span> locations <span class="token operator">=</span> interceptor<span class="token punctuation">.</span><span class="token function">process</span><span class="token punctuation">(</span>methodProcessor<span class="token punctuation">)</span><span class="token punctuation">;</span>
                            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Location</span> location <span class="token operator">:</span> locations<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                <span class="token keyword">if</span> <span class="token punctuation">(</span>location <span class="token keyword">instanceof</span> <span class="token class-name">MethodInsnNodeWare</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                                    <span class="token class-name">MethodInsnNodeWare</span> methodInsnNodeWare <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">MethodInsnNodeWare</span><span class="token punctuation">)</span> location<span class="token punctuation">;</span>
                                    <span class="token class-name">MethodInsnNode</span> methodInsnNode <span class="token operator">=</span> methodInsnNodeWare<span class="token punctuation">.</span><span class="token function">methodInsnNode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//针对当前类注册监听器，对应该方法底层就会以当前类作为key，添加一个相关指令的监听器(例如stack就是StackAdviceListener)等待执行增强逻辑执行时执行栈帧调用追踪</span>
        	                            <span class="token class-name">AdviceListenerManager</span><span class="token punctuation">.</span><span class="token function">registerTraceAdviceListener</span><span class="token punctuation">(</span>inClassLoader<span class="token punctuation">,</span> className<span class="token punctuation">,</span>
                                            methodInsnNode<span class="token punctuation">.</span>owner<span class="token punctuation">,</span> methodInsnNode<span class="token punctuation">.</span>name<span class="token punctuation">,</span> methodInsnNode<span class="token punctuation">.</span>desc<span class="token punctuation">,</span> listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
                                <span class="token punctuation">}</span>
                            <span class="token punctuation">}</span>

                        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                           <span class="token comment">//......</span>
                        <span class="token punctuation">}</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>

 <span class="token comment">//针对当前类注册监听器，例如本次用stack指令对Demo类的Counter内部类的increment做调用追踪，对应该方法底层就会以当前类作为key，添加一个StackAdviceListener等待执行增强逻辑执行时执行栈帧调用追踪</span>
                <span class="token class-name">AdviceListenerManager</span><span class="token punctuation">.</span><span class="token function">registerAdviceListener</span><span class="token punctuation">(</span>inClassLoader<span class="token punctuation">,</span> className<span class="token punctuation">,</span> methodNode<span class="token punctuation">.</span>name<span class="token punctuation">,</span> methodNode<span class="token punctuation">.</span>desc<span class="token punctuation">,</span>
                        listener<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//......</span>
            <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> enhanceClassByteArray <span class="token operator">=</span> <span class="token class-name">AsmUtils</span><span class="token punctuation">.</span><span class="token function">toBytes</span><span class="token punctuation">(</span>classNode<span class="token punctuation">,</span> inClassLoader<span class="token punctuation">,</span> classReader<span class="token punctuation">)</span><span class="token punctuation">;</span>

          <span class="token comment">//......</span>
				<span class="token comment">//返回增强后的字节码</span>

            <span class="token keyword">return</span> enhanceClassByteArray<span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span><span class="token string">&quot;transform loader[{}]:class[{}] failed.&quot;</span><span class="token punctuation">,</span> inClassLoader<span class="token punctuation">,</span> className<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
            affect<span class="token punctuation">.</span><span class="token function">setThrowable</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token keyword">return</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br></div></div><h3 id="解耦化拦截类方法执行增强逻辑"><a href="#解耦化拦截类方法执行增强逻辑" class="header-anchor">#</a> 解耦化拦截类方法执行增强逻辑</h3> <p>后续对于该类即<code>Demo.Counter</code>的调用，就会执行到<code>SpyAPI</code>的<code>atEnter</code>方法，本质上就是对应<code>spyInstance</code>(也就是<code>SpyImpl</code>)的调用：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">atEnter</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">String</span> methodInfo<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        spyInstance<span class="token punctuation">.</span><span class="token function">atEnter</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> methodInfo<span class="token punctuation">,</span> target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>步入<code>SpyImpl</code>源代码可以看到，其底层就会通过全局监听器定位到这个类的监听器完成具体的增强逻辑，显见<code>arthas</code>作者对于解耦思想的见解：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">atEnter</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">String</span> methodInfo<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">ClassLoader</span> classLoader <span class="token operator">=</span> clazz<span class="token punctuation">.</span><span class="token function">getClassLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token class-name">String</span><span class="token punctuation">[</span><span class="token punctuation">]</span> info <span class="token operator">=</span> <span class="token class-name">StringUtils</span><span class="token punctuation">.</span><span class="token function">splitMethodInfo</span><span class="token punctuation">(</span>methodInfo<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> methodName <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> methodDesc <span class="token operator">=</span> info<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
       <span class="token comment">//基于当前类到全局缓存获取所有监听器</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">AdviceListener</span><span class="token punctuation">&gt;</span></span> listeners <span class="token operator">=</span> <span class="token class-name">AdviceListenerManager</span><span class="token punctuation">.</span><span class="token function">queryAdviceListeners</span><span class="token punctuation">(</span>classLoader<span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
                methodName<span class="token punctuation">,</span> methodDesc<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>listeners <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">AdviceListener</span> adviceListener <span class="token operator">:</span> listeners<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">skipAdviceListener</span><span class="token punctuation">(</span>adviceListener<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        <span class="token keyword">continue</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token comment">//执行匹配的监听器逻辑</span>
                    adviceListener<span class="token punctuation">.</span><span class="token function">before</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> methodDesc<span class="token punctuation">,</span> target<span class="token punctuation">,</span> args<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;class: {}, methodInfo: {}&quot;</span><span class="token punctuation">,</span> clazz<span class="token punctuation">.</span><span class="token function">getName</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> methodInfo<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br></div></div><p>以本次的<code>stack</code>为例也就是在调用前在当前线程内部维护一个开始时间，这里笔者考虑到<code>stack</code>指令介绍的完整性也将<code>atExit</code>注解对应执行的afterReturning方法，可以看到stack本质要做的就是：</p> <ol><li>before记录其实时间</li> <li>afterReturning通过finishing提取线程中的调用堆栈信息和线程信息封装成StackModel输出</li></ol> <div class="language-java line-numbers-mode"><pre class="language-java"><code> <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">before</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">ArthasMethod</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
            <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token comment">// 开始计算本次方法调用耗时</span>
        threadLocalWatch<span class="token punctuation">.</span><span class="token function">start</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

<span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">afterReturning</span><span class="token punctuation">(</span><span class="token class-name">ClassLoader</span> loader<span class="token punctuation">,</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">,</span> <span class="token class-name">ArthasMethod</span> method<span class="token punctuation">,</span> <span class="token class-name">Object</span> target<span class="token punctuation">,</span> <span class="token class-name">Object</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">,</span>
                               <span class="token class-name">Object</span> returnObject<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Throwable</span> <span class="token punctuation">{</span>
        <span class="token class-name">Advice</span> advice <span class="token operator">=</span> <span class="token class-name">Advice</span><span class="token punctuation">.</span><span class="token function">newForAfterRetuning</span><span class="token punctuation">(</span>loader<span class="token punctuation">,</span> clazz<span class="token punctuation">,</span> method<span class="token punctuation">,</span> target<span class="token punctuation">,</span> args<span class="token punctuation">,</span> returnObject<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//获取类信息 入参 出参信息</span>
        <span class="token function">finishing</span><span class="token punctuation">(</span>advice<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">finishing</span><span class="token punctuation">(</span><span class="token class-name">Advice</span> advice<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// 本次调用的耗时</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token keyword">double</span> cost <span class="token operator">=</span> threadLocalWatch<span class="token punctuation">.</span><span class="token function">costInMillis</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//判断条件是否满足要输出的结果</span>
            <span class="token keyword">boolean</span> conditionResult <span class="token operator">=</span> <span class="token function">isConditionMet</span><span class="token punctuation">(</span>command<span class="token punctuation">.</span><span class="token function">getConditionExpress</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> advice<span class="token punctuation">,</span> cost<span class="token punctuation">)</span><span class="token punctuation">;</span>
         <span class="token comment">//......</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>conditionResult<span class="token punctuation">)</span> <span class="token punctuation">{</span>
               	<span class="token comment">//提取当前线程内部维护的stacktrace构成调用链以及各种线程信息构成StackModel返回</span>
                <span class="token class-name">StackModel</span> stackModel <span class="token operator">=</span> <span class="token class-name">ThreadUtil</span><span class="token punctuation">.</span><span class="token function">getThreadStackModel</span><span class="token punctuation">(</span>advice<span class="token punctuation">.</span><span class="token function">getLoader</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token class-name">Thread</span><span class="token punctuation">.</span><span class="token function">currentThread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                stackModel<span class="token punctuation">.</span><span class="token function">setTs</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Date</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                process<span class="token punctuation">.</span><span class="token function">appendResult</span><span class="token punctuation">(</span>stackModel<span class="token punctuation">)</span><span class="token punctuation">;</span>
              <span class="token comment">//......</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">//......</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br></div></div><p>最终我们就可以看到类似下面这样的输出结果：</p> <p><img src="https://qiniuyun.sharkchili.com/202512250931126.png" alt=""></p> <h2 id="关于arthas性能问题的探讨"><a href="#关于arthas性能问题的探讨" class="header-anchor">#</a> 关于arthas性能问题的探讨</h2> <p>在笔者了解arthas这本技术的时候，看到github有这样一个话题：</p> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>arthas进行增强时，对于程序执行性能是否有影响
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br></div></div><p>参考大部分答案结合笔者的经验，针对那些被JIT优化且生成机器码的字节码进行增强时，这就会使得原有的缓存失效，使得被增强的类经历：</p> <ol><li>字节码修改</li> <li>原有JIT优化后的代码失效</li> <li>高并发的函数调用会调起抖动</li> <li>再次经历解释执行、JIT编译再优化为编译版本的机器码执行</li></ol> <p>从使用的表现来看，attach因为增强所有的classloader的那一瞬间CPU使用率确实会短暂飙升，出现服务抖动，所以在高并发的生产环境还是慎用。</p> <p>感兴趣的读者可以移步了解该问题:Arthas attach 之后对原进程性能有多大的影响:<a href="https://github.com/alibaba/arthas/issues/44" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/arthas/issues/44<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>本文基于arthas 3.6.0源码针对arthas运行时增强技术进行深入分析，可以看到这个监控诊断工具利用了agent的attach进行运行时通过字节码进行通用的字节码修改增强，然后根据用户键入的指令获取对应监听器缓存到全局，在执行通用字节码即SpyAPI调用时就会定位到指定监听器完成响应的逻辑增强。</p> <p>你好，我是 <strong>SharkChili</strong> ，禅与计算机程序设计艺术布道者，希望我的理念对您有所启发。</p> <p><strong>📝 我的公众号：写代码的SharkChili</strong><br>
在这里，我会分享技术干货、编程思考与开源项目实践。</p> <p><strong>🚀 我的开源项目：mini-redis</strong><br>
一个用于教学理解的 Redis 精简实现，欢迎 Star &amp; Contribute：<br> <a href="https://github.com/shark-ctrl/mini-redis" target="_blank" rel="noopener noreferrer">https://github.com/shark-ctrl/mini-redis<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p><strong>👥 欢迎加入读者群</strong><br>
关注公众号，回复 <strong>【加群】</strong> 即可获取联系方式，期待与你交流技术、共同成长！</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p>Arthas技术原理-源码调试环境搭建:<a href="https://wanglikang.github.io/2024/08/03/Arthas%E6%8A%80%E6%9C%AF%E5%8E%9F%E7%90%86-%E6%BA%90%E7%A0%81%E8%B0%83%E8%AF%95%E7%8E%AF%E5%A2%83%E6%90%AD%E5%BB%BA/" target="_blank" rel="noopener noreferrer">https://wanglikang.github.io/2024/08/03/Arthas技术原理-源码调试环境搭建/<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>深入剖析Arthas源码:<a href="https://www.cnblogs.com/bigcoder84/p/18147350" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/bigcoder84/p/18147350<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Debug Arthas In IDEA :<a href="https://github.com/alibaba/arthas/issues/222" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/arthas/issues/222<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>指定版本启动arthas:<a href="https://github.com/alibaba/arthas/blob/master/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer">https://github.com/alibaba/arthas/blob/master/CONTRIBUTING.md<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>开源诊断利器Arthas ByteKit 深度解读(1)：基本原理介绍:<a href="https://blog.csdn.net/hengyunabc/article/details/107398983" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/hengyunabc/article/details/107398983<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Java agent-05-Bytecode Kit-00-bytekit 入门介绍:<a href="https://zhuanlan.zhihu.com/p/12979796066" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/12979796066<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Java 程序的运行原理:<a href="https://www.cnblogs.com/luojw/p/18112110" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/luojw/p/18112110<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Class VirtualMachine API官方文档:<a href="https://docs.oracle.com/javase/8/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html" target="_blank" rel="noopener noreferrer">https://docs.oracle.com/javase/8/docs/jdk/api/attach/spec/com/sun/tools/attach/VirtualMachine.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
         <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="1126101170"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/sharkchili/vuepress-theme-vdoing/edit/master/docs/01.Java核心技术/50.JVM相关/17.深入剖析arthas技术原理.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025/12/25, 09:33:35</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/fca4af/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">基于arthas量化监控诊断java应用方法论与实践</div></a> <!----></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/fca4af/" class="prev">基于arthas量化监控诊断java应用方法论与实践</a></span> <!----></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/5b74d3/"><div>
            告别AI无效对话：资深工程师的提示词设计最佳实践
            <!----></div></a> <span class="date">02-07</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/745def/"><div>
            基于Vibe Coding的Redis分页查询实现
            <!----></div></a> <span class="date">01-29</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/609690/"><div>
            IDEA配置详解与高效使用指南
            <!----></div></a> <span class="date">01-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/shkctl" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2025-2026
    <span>Evan Xu | <a href="https://github.com/shkctl/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a> | <a href="http://beian.miit.gov.cn/" target="_blank">桂ICP备2024034950号</a> | <img src="/img/beian.png" style="width: 15px; margin-bottom: -3px;" /> <a href="https://beian.mps.gov.cn/#/query/webSearch?code=45142202000030" rel="noreferrer" target="_blank">桂公网安备45142202000030</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <div class="custom-html-window custom-html-window-lb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定200*200px -->
         <script async src="https:pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
         <ins class="adsbygoogle"
             style="display:inline-block;width:200px;height:200px"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="8486534683"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script></div></div></div> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定160*160px -->
         <ins class="adsbygoogle"
             style="display:inline-block;max-width:160px;max-height:160px"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="8350803313"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script>
         </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.e893bc68.js" defer></script><script src="/assets/js/2.0f2864c1.js" defer></script><script src="/assets/js/40.6eebc32d.js" defer></script>
  </body>
</html>
