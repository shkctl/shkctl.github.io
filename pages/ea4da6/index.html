<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>深入源码解析synchronized关键字 | The Complete Backend Engineer</title>
    <meta name="generator" content="VuePress 1.9.9">
    <link rel="icon" href="/img/favicon.ico">
    <script data-ad-client="ca-pub-6948347885301434" async="async" src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
    <meta name="description" content="禅与计算机程序设计的艺术">
    <meta name="keywords" content="前端博客,个人技术博客,前端,前端开发,前端框架,web前端,前端面试题,技术文档,学习,面试,JavaScript,js,ES6,TypeScript,vue,python,css3,html5,Node,git,github,markdown">
    <meta name="baidu-site-verification" content="7F55weZDDc">
    <meta name="theme-color" content="#11a8cd">
    
    <link rel="preload" href="/assets/css/0.styles.fd8a955e.css" as="style"><link rel="preload" href="/assets/js/app.e893bc68.js" as="script"><link rel="preload" href="/assets/js/2.0f2864c1.js" as="script"><link rel="preload" href="/assets/js/26.e02e9bae.js" as="script"><link rel="prefetch" href="/assets/js/10.44e0ca78.js"><link rel="prefetch" href="/assets/js/100.0ed371f6.js"><link rel="prefetch" href="/assets/js/101.7f722fd7.js"><link rel="prefetch" href="/assets/js/102.30c89284.js"><link rel="prefetch" href="/assets/js/103.3ed92c68.js"><link rel="prefetch" href="/assets/js/104.90df8f47.js"><link rel="prefetch" href="/assets/js/105.68247c1d.js"><link rel="prefetch" href="/assets/js/106.7c9f10c1.js"><link rel="prefetch" href="/assets/js/107.a515064a.js"><link rel="prefetch" href="/assets/js/108.80b5fa66.js"><link rel="prefetch" href="/assets/js/109.02b1ee2e.js"><link rel="prefetch" href="/assets/js/11.c76d3e56.js"><link rel="prefetch" href="/assets/js/110.1dccb364.js"><link rel="prefetch" href="/assets/js/111.464698db.js"><link rel="prefetch" href="/assets/js/112.857e923f.js"><link rel="prefetch" href="/assets/js/113.68e5c6a3.js"><link rel="prefetch" href="/assets/js/114.f6ffbf1a.js"><link rel="prefetch" href="/assets/js/115.e217114c.js"><link rel="prefetch" href="/assets/js/116.b65b8e0b.js"><link rel="prefetch" href="/assets/js/117.f6f15ef6.js"><link rel="prefetch" href="/assets/js/118.21180219.js"><link rel="prefetch" href="/assets/js/119.0a50382f.js"><link rel="prefetch" href="/assets/js/12.116d6a17.js"><link rel="prefetch" href="/assets/js/120.c76f2e28.js"><link rel="prefetch" href="/assets/js/121.c77bd4d8.js"><link rel="prefetch" href="/assets/js/122.753a4628.js"><link rel="prefetch" href="/assets/js/123.7d9268b9.js"><link rel="prefetch" href="/assets/js/124.23413b75.js"><link rel="prefetch" href="/assets/js/125.8d808d11.js"><link rel="prefetch" href="/assets/js/126.5c328cd4.js"><link rel="prefetch" href="/assets/js/127.be8eb4c7.js"><link rel="prefetch" href="/assets/js/128.14eaf4c6.js"><link rel="prefetch" href="/assets/js/129.037cada8.js"><link rel="prefetch" href="/assets/js/13.86ee0ee4.js"><link rel="prefetch" href="/assets/js/130.3f4b81a3.js"><link rel="prefetch" href="/assets/js/131.0a8a91be.js"><link rel="prefetch" href="/assets/js/132.d5865515.js"><link rel="prefetch" href="/assets/js/133.334e4ec7.js"><link rel="prefetch" href="/assets/js/134.074fbb0c.js"><link rel="prefetch" href="/assets/js/135.4c1d75b4.js"><link rel="prefetch" href="/assets/js/136.3e122b41.js"><link rel="prefetch" href="/assets/js/137.fe10b09a.js"><link rel="prefetch" href="/assets/js/138.54b4b2ef.js"><link rel="prefetch" href="/assets/js/139.3883fff5.js"><link rel="prefetch" href="/assets/js/14.e34688a7.js"><link rel="prefetch" href="/assets/js/140.078eff15.js"><link rel="prefetch" href="/assets/js/141.949d876b.js"><link rel="prefetch" href="/assets/js/142.54e6ed21.js"><link rel="prefetch" href="/assets/js/143.ff73dde5.js"><link rel="prefetch" href="/assets/js/144.cf979a70.js"><link rel="prefetch" href="/assets/js/145.b217db72.js"><link rel="prefetch" href="/assets/js/146.c9872ef2.js"><link rel="prefetch" href="/assets/js/147.32147c50.js"><link rel="prefetch" href="/assets/js/148.411a0638.js"><link rel="prefetch" href="/assets/js/149.ed899419.js"><link rel="prefetch" href="/assets/js/15.03c300fc.js"><link rel="prefetch" href="/assets/js/150.4c278e80.js"><link rel="prefetch" href="/assets/js/151.73bd004f.js"><link rel="prefetch" href="/assets/js/152.5716ffe7.js"><link rel="prefetch" href="/assets/js/153.33575577.js"><link rel="prefetch" href="/assets/js/154.6e0c3807.js"><link rel="prefetch" href="/assets/js/155.79acad7a.js"><link rel="prefetch" href="/assets/js/156.1ca46e9e.js"><link rel="prefetch" href="/assets/js/157.b8e1cb13.js"><link rel="prefetch" href="/assets/js/158.047ce40d.js"><link rel="prefetch" href="/assets/js/159.564cb107.js"><link rel="prefetch" href="/assets/js/16.76d8d610.js"><link rel="prefetch" href="/assets/js/160.0b4be4c9.js"><link rel="prefetch" href="/assets/js/161.2d0b6a29.js"><link rel="prefetch" href="/assets/js/162.7b7cddf9.js"><link rel="prefetch" href="/assets/js/163.9c1d2ab4.js"><link rel="prefetch" href="/assets/js/164.9a7309b6.js"><link rel="prefetch" href="/assets/js/165.11d81960.js"><link rel="prefetch" href="/assets/js/166.266c02dd.js"><link rel="prefetch" href="/assets/js/167.6d4d9953.js"><link rel="prefetch" href="/assets/js/168.aa4ee3b8.js"><link rel="prefetch" href="/assets/js/169.0d3373fb.js"><link rel="prefetch" href="/assets/js/17.453cb3dd.js"><link rel="prefetch" href="/assets/js/170.ce20f019.js"><link rel="prefetch" href="/assets/js/171.b4f20fc0.js"><link rel="prefetch" href="/assets/js/172.75742b66.js"><link rel="prefetch" href="/assets/js/173.8daa037e.js"><link rel="prefetch" href="/assets/js/174.5243dead.js"><link rel="prefetch" href="/assets/js/175.9a313498.js"><link rel="prefetch" href="/assets/js/176.4c2b81b0.js"><link rel="prefetch" href="/assets/js/177.dad18ef5.js"><link rel="prefetch" href="/assets/js/178.f3fa8d3b.js"><link rel="prefetch" href="/assets/js/179.589b3e1b.js"><link rel="prefetch" href="/assets/js/18.4de1c5f4.js"><link rel="prefetch" href="/assets/js/180.ea36098d.js"><link rel="prefetch" href="/assets/js/181.92cdb1c7.js"><link rel="prefetch" href="/assets/js/182.c0b21f1f.js"><link rel="prefetch" href="/assets/js/183.a0eb2e49.js"><link rel="prefetch" href="/assets/js/184.b5aa56e6.js"><link rel="prefetch" href="/assets/js/185.81cb4cac.js"><link rel="prefetch" href="/assets/js/186.53b06c41.js"><link rel="prefetch" href="/assets/js/187.dfae4e44.js"><link rel="prefetch" href="/assets/js/188.b0cb81de.js"><link rel="prefetch" href="/assets/js/189.3678f44d.js"><link rel="prefetch" href="/assets/js/19.3e76d54a.js"><link rel="prefetch" href="/assets/js/190.83946875.js"><link rel="prefetch" href="/assets/js/191.3ff7b14d.js"><link rel="prefetch" href="/assets/js/192.701461bb.js"><link rel="prefetch" href="/assets/js/193.559260cc.js"><link rel="prefetch" href="/assets/js/194.be81abc2.js"><link rel="prefetch" href="/assets/js/195.9b8d270a.js"><link rel="prefetch" href="/assets/js/196.bec3303f.js"><link rel="prefetch" href="/assets/js/197.63dafd74.js"><link rel="prefetch" href="/assets/js/198.605f2efc.js"><link rel="prefetch" href="/assets/js/199.edfd56ac.js"><link rel="prefetch" href="/assets/js/20.6e6b3fc4.js"><link rel="prefetch" href="/assets/js/200.3e48ab94.js"><link rel="prefetch" href="/assets/js/201.233d8a2d.js"><link rel="prefetch" href="/assets/js/202.91a5ef9c.js"><link rel="prefetch" href="/assets/js/203.bc0fabe9.js"><link rel="prefetch" href="/assets/js/204.8bc8880b.js"><link rel="prefetch" href="/assets/js/205.0f5a3300.js"><link rel="prefetch" href="/assets/js/206.b3505d50.js"><link rel="prefetch" href="/assets/js/207.a394ee4c.js"><link rel="prefetch" href="/assets/js/208.837b0596.js"><link rel="prefetch" href="/assets/js/209.e9d3bceb.js"><link rel="prefetch" href="/assets/js/21.69f77bb4.js"><link rel="prefetch" href="/assets/js/210.edb571f9.js"><link rel="prefetch" href="/assets/js/211.fc30ee35.js"><link rel="prefetch" href="/assets/js/212.0c76fd95.js"><link rel="prefetch" href="/assets/js/213.4c91febb.js"><link rel="prefetch" href="/assets/js/214.0a2395e5.js"><link rel="prefetch" href="/assets/js/215.d4637411.js"><link rel="prefetch" href="/assets/js/216.c1454bb1.js"><link rel="prefetch" href="/assets/js/217.0c0e6f55.js"><link rel="prefetch" href="/assets/js/218.1451ab92.js"><link rel="prefetch" href="/assets/js/219.0f96b0c8.js"><link rel="prefetch" href="/assets/js/22.201d31e2.js"><link rel="prefetch" href="/assets/js/220.8f6313e8.js"><link rel="prefetch" href="/assets/js/221.11a00bef.js"><link rel="prefetch" href="/assets/js/222.8649b716.js"><link rel="prefetch" href="/assets/js/223.d8939fd6.js"><link rel="prefetch" href="/assets/js/224.f7a5a821.js"><link rel="prefetch" href="/assets/js/225.0c642b7c.js"><link rel="prefetch" href="/assets/js/226.5860464c.js"><link rel="prefetch" href="/assets/js/227.079d5421.js"><link rel="prefetch" href="/assets/js/228.d433e6e5.js"><link rel="prefetch" href="/assets/js/229.5068c386.js"><link rel="prefetch" href="/assets/js/23.10bf4243.js"><link rel="prefetch" href="/assets/js/230.20571aa5.js"><link rel="prefetch" href="/assets/js/231.a2977032.js"><link rel="prefetch" href="/assets/js/232.2c809bc8.js"><link rel="prefetch" href="/assets/js/233.443b82b0.js"><link rel="prefetch" href="/assets/js/234.800cdff1.js"><link rel="prefetch" href="/assets/js/235.fb8d4938.js"><link rel="prefetch" href="/assets/js/236.36863586.js"><link rel="prefetch" href="/assets/js/237.ad86391f.js"><link rel="prefetch" href="/assets/js/238.be050d3f.js"><link rel="prefetch" href="/assets/js/239.12a16a50.js"><link rel="prefetch" href="/assets/js/24.824afdae.js"><link rel="prefetch" href="/assets/js/25.35475e70.js"><link rel="prefetch" href="/assets/js/27.271f5ef4.js"><link rel="prefetch" href="/assets/js/28.a3385896.js"><link rel="prefetch" href="/assets/js/29.b0f185f2.js"><link rel="prefetch" href="/assets/js/3.a5b363ab.js"><link rel="prefetch" href="/assets/js/30.e3ccdef2.js"><link rel="prefetch" href="/assets/js/31.f96d307d.js"><link rel="prefetch" href="/assets/js/32.c0b9fe86.js"><link rel="prefetch" href="/assets/js/33.200a99d3.js"><link rel="prefetch" href="/assets/js/34.2b031524.js"><link rel="prefetch" href="/assets/js/35.9cf4ce52.js"><link rel="prefetch" href="/assets/js/36.1d78bdc4.js"><link rel="prefetch" href="/assets/js/37.080c4136.js"><link rel="prefetch" href="/assets/js/38.a96300bf.js"><link rel="prefetch" href="/assets/js/39.fcf7d628.js"><link rel="prefetch" href="/assets/js/4.373178a6.js"><link rel="prefetch" href="/assets/js/40.6eebc32d.js"><link rel="prefetch" href="/assets/js/41.3ad4146c.js"><link rel="prefetch" href="/assets/js/42.c1beb08d.js"><link rel="prefetch" href="/assets/js/43.76cd763e.js"><link rel="prefetch" href="/assets/js/44.6b1fdcd3.js"><link rel="prefetch" href="/assets/js/45.51579c3c.js"><link rel="prefetch" href="/assets/js/46.52741878.js"><link rel="prefetch" href="/assets/js/47.cd93b2de.js"><link rel="prefetch" href="/assets/js/48.773c188b.js"><link rel="prefetch" href="/assets/js/49.44412d53.js"><link rel="prefetch" href="/assets/js/5.6a44f71a.js"><link rel="prefetch" href="/assets/js/50.b4bbbbea.js"><link rel="prefetch" href="/assets/js/51.e8ef0c3a.js"><link rel="prefetch" href="/assets/js/52.4a55bbf5.js"><link rel="prefetch" href="/assets/js/53.c1087a52.js"><link rel="prefetch" href="/assets/js/54.c8e13749.js"><link rel="prefetch" href="/assets/js/55.cc84db26.js"><link rel="prefetch" href="/assets/js/56.f454b553.js"><link rel="prefetch" href="/assets/js/57.918eb2e9.js"><link rel="prefetch" href="/assets/js/58.d1a59570.js"><link rel="prefetch" href="/assets/js/59.044ec60b.js"><link rel="prefetch" href="/assets/js/6.6a62d9f9.js"><link rel="prefetch" href="/assets/js/60.81e16e70.js"><link rel="prefetch" href="/assets/js/61.ed5542f5.js"><link rel="prefetch" href="/assets/js/62.72b114ed.js"><link rel="prefetch" href="/assets/js/63.3e421524.js"><link rel="prefetch" href="/assets/js/64.1e3fb052.js"><link rel="prefetch" href="/assets/js/65.e1ed1c12.js"><link rel="prefetch" href="/assets/js/66.07753887.js"><link rel="prefetch" href="/assets/js/67.36f77f4b.js"><link rel="prefetch" href="/assets/js/68.5ddddae3.js"><link rel="prefetch" href="/assets/js/69.31b6a988.js"><link rel="prefetch" href="/assets/js/7.2f58813b.js"><link rel="prefetch" href="/assets/js/70.a04b238e.js"><link rel="prefetch" href="/assets/js/71.5ccef793.js"><link rel="prefetch" href="/assets/js/72.b1127849.js"><link rel="prefetch" href="/assets/js/73.7749f2a0.js"><link rel="prefetch" href="/assets/js/74.2fe0cec9.js"><link rel="prefetch" href="/assets/js/75.962eca85.js"><link rel="prefetch" href="/assets/js/76.ea97d2ca.js"><link rel="prefetch" href="/assets/js/77.182bb4ac.js"><link rel="prefetch" href="/assets/js/78.b9d2abaa.js"><link rel="prefetch" href="/assets/js/79.d6901320.js"><link rel="prefetch" href="/assets/js/8.779d1361.js"><link rel="prefetch" href="/assets/js/80.13663490.js"><link rel="prefetch" href="/assets/js/81.b09db84b.js"><link rel="prefetch" href="/assets/js/82.2bcbd31f.js"><link rel="prefetch" href="/assets/js/83.344d67cf.js"><link rel="prefetch" href="/assets/js/84.45bc9110.js"><link rel="prefetch" href="/assets/js/85.84a31255.js"><link rel="prefetch" href="/assets/js/86.fe802e40.js"><link rel="prefetch" href="/assets/js/87.be2bb441.js"><link rel="prefetch" href="/assets/js/88.3d367f79.js"><link rel="prefetch" href="/assets/js/89.87678ad0.js"><link rel="prefetch" href="/assets/js/9.87ad8bb5.js"><link rel="prefetch" href="/assets/js/90.f0b552b5.js"><link rel="prefetch" href="/assets/js/91.ab54ea37.js"><link rel="prefetch" href="/assets/js/92.f5490bfc.js"><link rel="prefetch" href="/assets/js/93.5cbe8d45.js"><link rel="prefetch" href="/assets/js/94.681b3734.js"><link rel="prefetch" href="/assets/js/95.f3017fa5.js"><link rel="prefetch" href="/assets/js/96.52ebd59a.js"><link rel="prefetch" href="/assets/js/97.e28a6ef9.js"><link rel="prefetch" href="/assets/js/98.84e88e28.js"><link rel="prefetch" href="/assets/js/99.9f1258fc.js">
    <link rel="stylesheet" href="/assets/css/0.styles.fd8a955e.css">
  </head>
  <body class="theme-mode-light">
    <div id="app" data-server-rendered="true"><div class="theme-container sidebar-open have-rightmenu"><header class="navbar blur"><div title="目录" class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/img/logo.png" alt="The Complete Backend Engineer" class="logo"> <span class="site-name can-hide">The Complete Backend Engineer</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java核心技术" class="dropdown-title"><a href="/java-core/" class="link-title">Java核心技术</a> <span class="title" style="display:none;">Java核心技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>Java并发编程</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/pages/7e6285/" class="nav-link">浅谈Java并发安全发布技术</a></li><li class="dropdown-subitem"><a href="/pages/bb708f/" class="nav-link">浅谈Java线程池中拒绝策略与流控的艺术</a></li><li class="dropdown-subitem"><a href="/pages/ea4da6/" aria-current="page" class="nav-link router-link-exact-active router-link-active">深入源码解析synchronized关键字</a></li><li class="dropdown-subitem"><a href="/pages/a62174/" class="nav-link">浅谈Java并发编程中断的哲学</a></li><li class="dropdown-subitem"><a href="/pages/54f168/" class="nav-link">深入理解Java中的final关键字</a></li><li class="dropdown-subitem"><a href="/pages/d9feaf/" class="nav-link">深入剖析Java并发编程中的死锁问题</a></li><li class="dropdown-subitem"><a href="/pages/e171b0/" class="nav-link">浅谈池化技术的优雅关闭</a></li><li class="dropdown-subitem"><a href="/pages/96493d/" class="nav-link">synchronized关键字使用指南</a></li><li class="dropdown-subitem"><a href="/pages/17210f/" class="nav-link">浅谈并发编程等待通知模型</a></li><li class="dropdown-subitem"><a href="/pages/d2df46/" class="nav-link">浅谈传统并发编程的优化思路</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li><li class="dropdown-item"><h4>JVM相关</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/78918f/" class="nav-link">从零开始理解JVM的JIT编译机制</a></li><li class="dropdown-subitem"><a href="/pages/8e1e94/" class="nav-link">简明的Arthas配置及基础运维教程</a></li><li class="dropdown-subitem"><a href="/pages/1ac322/" class="nav-link">基于Arthas Idea的JVM故障排查与指令生成</a></li><li class="dropdown-subitem"><a href="/pages/fca4af/" class="nav-link">基于arthas量化监控诊断java应用方法论与实践</a></li><li class="dropdown-subitem"><a href="/pages/78439b/" class="nav-link">深入剖析arthas技术原理</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><a href="/cs/" class="link-title">计算机基础</a> <span class="title" style="display:none;">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>计算机组成原理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/aa591a/" class="nav-link">浅谈CPU流水线的艺术</a></li></ul></li><li class="dropdown-item"><h4>操作系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/a32bff/" class="nav-link">Linux性能问题排查最佳实践</a></li><li class="dropdown-subitem"><a href="/pages/8902d5/" class="nav-link">Linux上IO性能问题的故障排除实践</a></li><li class="dropdown-subitem"><a href="/pages/09184d/" class="nav-link">浅谈Linux权限管理</a></li><li class="dropdown-subitem"><a href="/pages/29f9e1/" class="nav-link">从操作系统底层浅谈程序栈的高效性</a></li></ul></li><li class="dropdown-item"><h4>编码最佳实践</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/968465/" class="nav-link">浅谈现代软件工程TDD最佳实践</a></li><li class="dropdown-subitem"><a href="/pages/2b73d8/" class="nav-link">浅谈TDD模式下并发程序设计与实现</a></li><li class="dropdown-subitem"><a href="/pages/50d82f/" class="nav-link">面向AI编程新范式Trae后端开发环境搭建与实践</a></li><li class="dropdown-subitem"><a href="/pages/3d2b25/" class="nav-link">基于提示词工程的Redis签到功能开发实践</a></li><li class="dropdown-subitem"><a href="/pages/745def/" class="nav-link">基于Vibe Coding的Redis分页查询实现</a></li><li class="dropdown-subitem"><a href="/pages/5b74d3/" class="nav-link">告别AI无效对话：资深工程师的提示词设计最佳实践</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="程序员日常" class="dropdown-title"><a href="/coder-life/" class="link-title">程序员日常</a> <span class="title" style="display:none;">程序员日常</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>实用技巧与配置</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/9dae72/" class="nav-link">Mac常用快捷键与效率插件指南</a></li></ul></li><li class="dropdown-item"><h4>写作</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/38a0f7/" class="nav-link">写好技术博客的5大核心原则：从认知科学到AI工具的全流程指南</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程工具" class="dropdown-title"><a href="/technology/" class="link-title">编程工具</a> <span class="title" style="display:none;">编程工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>开发工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/609690/" class="nav-link">IDEA配置详解与高效使用指南</a></li></ul></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/sharkchili/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav></div></header> <div class="sidebar-mask"></div> <div class="sidebar-hover-trigger"></div> <aside class="sidebar" style="display:none;"><div class="blogger"><img src="https://jsd.cdn.zzko.cn/gh/sharkchili/image_store/blog/20200103123203.jpg"> <div class="blogger-info"><h3>sharkchili</h3> <span>计算机禅修者</span></div></div> <nav class="nav-links"><div class="nav-item"><a href="/" class="nav-link">首页</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="Java核心技术" class="dropdown-title"><a href="/java-core/" class="link-title">Java核心技术</a> <span class="title" style="display:none;">Java核心技术</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>Java基础</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/8143cc480faf9a11/" class="nav-link">JavaScript</a></li></ul></li><li class="dropdown-item"><h4>Java并发编程</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/note/javascript/" class="nav-link">《JavaScript教程》</a></li><li class="dropdown-subitem"><a href="/pages/7e6285/" class="nav-link">浅谈Java并发安全发布技术</a></li><li class="dropdown-subitem"><a href="/pages/bb708f/" class="nav-link">浅谈Java线程池中拒绝策略与流控的艺术</a></li><li class="dropdown-subitem"><a href="/pages/ea4da6/" aria-current="page" class="nav-link router-link-exact-active router-link-active">深入源码解析synchronized关键字</a></li><li class="dropdown-subitem"><a href="/pages/a62174/" class="nav-link">浅谈Java并发编程中断的哲学</a></li><li class="dropdown-subitem"><a href="/pages/54f168/" class="nav-link">深入理解Java中的final关键字</a></li><li class="dropdown-subitem"><a href="/pages/d9feaf/" class="nav-link">深入剖析Java并发编程中的死锁问题</a></li><li class="dropdown-subitem"><a href="/pages/e171b0/" class="nav-link">浅谈池化技术的优雅关闭</a></li><li class="dropdown-subitem"><a href="/pages/96493d/" class="nav-link">synchronized关键字使用指南</a></li><li class="dropdown-subitem"><a href="/pages/17210f/" class="nav-link">浅谈并发编程等待通知模型</a></li><li class="dropdown-subitem"><a href="/pages/d2df46/" class="nav-link">浅谈传统并发编程的优化思路</a></li><li class="dropdown-subitem"><a href="/pages/4643cd/" class="nav-link">JS设计模式总结</a></li></ul></li><li class="dropdown-item"><h4>JVM相关</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/78918f/" class="nav-link">从零开始理解JVM的JIT编译机制</a></li><li class="dropdown-subitem"><a href="/pages/8e1e94/" class="nav-link">简明的Arthas配置及基础运维教程</a></li><li class="dropdown-subitem"><a href="/pages/1ac322/" class="nav-link">基于Arthas Idea的JVM故障排查与指令生成</a></li><li class="dropdown-subitem"><a href="/pages/fca4af/" class="nav-link">基于arthas量化监控诊断java应用方法论与实践</a></li><li class="dropdown-subitem"><a href="/pages/78439b/" class="nav-link">深入剖析arthas技术原理</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="计算机基础" class="dropdown-title"><a href="/cs/" class="link-title">计算机基础</a> <span class="title" style="display:none;">计算机基础</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>计算机组成原理</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/aa591a/" class="nav-link">浅谈CPU流水线的艺术</a></li></ul></li><li class="dropdown-item"><h4>操作系统</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/a32bff/" class="nav-link">Linux性能问题排查最佳实践</a></li><li class="dropdown-subitem"><a href="/pages/8902d5/" class="nav-link">Linux上IO性能问题的故障排除实践</a></li><li class="dropdown-subitem"><a href="/pages/09184d/" class="nav-link">浅谈Linux权限管理</a></li><li class="dropdown-subitem"><a href="/pages/29f9e1/" class="nav-link">从操作系统底层浅谈程序栈的高效性</a></li></ul></li><li class="dropdown-item"><h4>编码最佳实践</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/968465/" class="nav-link">浅谈现代软件工程TDD最佳实践</a></li><li class="dropdown-subitem"><a href="/pages/2b73d8/" class="nav-link">浅谈TDD模式下并发程序设计与实现</a></li><li class="dropdown-subitem"><a href="/pages/50d82f/" class="nav-link">面向AI编程新范式Trae后端开发环境搭建与实践</a></li><li class="dropdown-subitem"><a href="/pages/3d2b25/" class="nav-link">基于提示词工程的Redis签到功能开发实践</a></li><li class="dropdown-subitem"><a href="/pages/745def/" class="nav-link">基于Vibe Coding的Redis分页查询实现</a></li><li class="dropdown-subitem"><a href="/pages/5b74d3/" class="nav-link">告别AI无效对话：资深工程师的提示词设计最佳实践</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="程序员日常" class="dropdown-title"><a href="/coder-life/" class="link-title">程序员日常</a> <span class="title" style="display:none;">程序员日常</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>实用技巧与配置</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/9dae72/" class="nav-link">Mac常用快捷键与效率插件指南</a></li></ul></li><li class="dropdown-item"><h4>写作</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/38a0f7/" class="nav-link">写好技术博客的5大核心原则：从认知科学到AI工具的全流程指南</a></li></ul></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="编程工具" class="dropdown-title"><a href="/technology/" class="link-title">编程工具</a> <span class="title" style="display:none;">编程工具</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><h4>开发工具</h4> <ul class="dropdown-subitem-wrapper"><li class="dropdown-subitem"><a href="/pages/609690/" class="nav-link">IDEA配置详解与高效使用指南</a></li></ul></li><li class="dropdown-item"><!----> <a href="/pages/117708e0af7f0bd9/" class="nav-link">Nodejs</a></li><li class="dropdown-item"><!----> <a href="/pages/41f87d890d0a02af/" class="nav-link">博客搭建</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="更多" class="dropdown-title"><a href="/more/" class="link-title">更多</a> <span class="title" style="display:none;">更多</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/pages/f2a556/" class="nav-link">学习</a></li><li class="dropdown-item"><!----> <a href="/pages/aea6571b7a8bae86/" class="nav-link">面试</a></li><li class="dropdown-item"><!----> <a href="/pages/2d615df9a36a98ed/" class="nav-link">心情杂货</a></li><li class="dropdown-item"><!----> <a href="/pages/baaa02/" class="nav-link">实用技巧</a></li><li class="dropdown-item"><!----> <a href="/friends/" class="nav-link">友情链接</a></li></ul></div></div><div class="nav-item"><a href="/about/" class="nav-link">关于</a></div><div class="nav-item"><a href="/pages/beb6c0bd8a66cea6/" class="nav-link">收藏</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="索引" class="dropdown-title"><a href="/archives/" class="link-title">索引</a> <span class="title" style="display:none;">索引</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/categories/" class="nav-link">分类</a></li><li class="dropdown-item"><!----> <a href="/tags/" class="nav-link">标签</a></li><li class="dropdown-item"><!----> <a href="/archives/" class="nav-link">归档</a></li></ul></div></div> <a href="https://github.com/sharkchili/vuepress-theme-vdoing" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></nav> <div class="sidebar-slot sidebar-slot-top"><!--  固定100% * 150px可显示，max-height:150px 未见显示-->
       <ins class="adsbygoogle"
             style="display:inline-block;width:100%;max-height:150px"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="8819267679"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script>

</div> <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Java基础</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>并发编程</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/note/javascript/" class="sidebar-link">《JavaScript教程》笔记</a></li><li><a href="/pages/54f168/" class="sidebar-link">深入理解Java中的final关键字</a></li><li><a href="/pages/7e6285/" class="sidebar-link">浅谈Java并发安全发布技术</a></li><li><a href="/pages/bb708f/" class="sidebar-link">浅谈Java线程池中拒绝策略与流控的艺术</a></li><li><a href="/pages/ea4da6/" aria-current="page" class="active sidebar-link">深入源码解析synchronized关键字</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level2"><a href="/pages/ea4da6/#写在文章开头" class="sidebar-link">写在文章开头</a></li><li class="sidebar-sub-header level2"><a href="/pages/ea4da6/#基于objectmonitor深入剖析synchronized关键字" class="sidebar-link">基于objectMonitor深入剖析synchronized关键字</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/ea4da6/#宏观了解synchronized同步机制" class="sidebar-link">宏观了解synchronized同步机制</a></li><li class="sidebar-sub-header level3"><a href="/pages/ea4da6/#详解并发锁资源竞争" class="sidebar-link">详解并发锁资源竞争</a></li><li class="sidebar-sub-header level3"><a href="/pages/ea4da6/#锁释放流程解析" class="sidebar-link">锁释放流程解析</a></li><li class="sidebar-sub-header level3"><a href="/pages/ea4da6/#挂起等待的wait调用" class="sidebar-link">挂起等待的wait调用</a></li><li class="sidebar-sub-header level3"><a href="/pages/ea4da6/#通知唤醒的notify操作" class="sidebar-link">通知唤醒的notify操作</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/ea4da6/#关于synchronized更进一步的理解" class="sidebar-link">关于synchronized更进一步的理解</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header level3"><a href="/pages/ea4da6/#为什么锁释放之后还要进行一次cas上锁" class="sidebar-link">为什么锁释放之后还要进行一次cas上锁</a></li><li class="sidebar-sub-header level3"><a href="/pages/ea4da6/#自旋重试的性能压榨" class="sidebar-link">自旋重试的性能压榨</a></li><li class="sidebar-sub-header level3"><a href="/pages/ea4da6/#不同唤醒策略的设计理念" class="sidebar-link">不同唤醒策略的设计理念</a></li><li class="sidebar-sub-header level3"><a href="/pages/ea4da6/#为什么wait获取锁采用自旋而非重量级锁" class="sidebar-link">为什么wait获取锁采用自旋而非重量级锁</a></li></ul></li><li class="sidebar-sub-header level2"><a href="/pages/ea4da6/#小结" class="sidebar-link">小结</a></li><li class="sidebar-sub-header level2"><a href="/pages/ea4da6/#参考" class="sidebar-link">参考</a></li></ul></li><li><a href="/pages/a62174/" class="sidebar-link">浅谈Java并发编程中断的哲学</a></li><li><a href="/pages/d9feaf/" class="sidebar-link">深入剖析Java并发编程中的死锁问题</a></li><li><a href="/pages/e171b0/" class="sidebar-link">浅谈池化技术的优雅关闭</a></li><li><a href="/pages/96493d/" class="sidebar-link">synchronized关键字使用指南</a></li><li><a href="/pages/17210f/" class="sidebar-link">浅谈并发编程等待通知模型</a></li><li><a href="/pages/d2df46/" class="sidebar-link">浅谈传统并发编程的优化思路</a></li><li><a href="/pages/1e61c2/" class="sidebar-link">CompletableFuture异步IO密集型任务最佳实践</a></li><li><a href="/note/wx-miniprogram/" class="sidebar-link">小程序笔记</a></li><li><a href="/pages/4643cd/" class="sidebar-link">JS设计模式总结笔记</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>JVM相关</span> <span class="arrow right"></span></p> <!----></section></li></ul> <div class="sidebar-slot sidebar-slot-bottom"><!-- 正方形 -->
         <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="8723616095"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script></div></aside> <div><main class="page"><div class="theme-vdoing-wrapper "><div class="articleInfo-wrap" data-v-06225672><div class="articleInfo" data-v-06225672><ul class="breadcrumbs" data-v-06225672><li data-v-06225672><a href="/" title="首页" class="iconfont icon-home router-link-active" data-v-06225672></a></li> <li data-v-06225672><a href="/categories/?category=Java%E6%A0%B8%E5%BF%83%E6%8A%80%E6%9C%AF" title="分类" data-v-06225672>Java核心技术</a></li><li data-v-06225672><a href="/categories/?category=%E5%B9%B6%E5%8F%91%E7%BC%96%E7%A8%8B" title="分类" data-v-06225672>并发编程</a></li></ul> <div class="info" data-v-06225672><div title="作者" class="author iconfont icon-touxiang" data-v-06225672><a href="https://github.com/shkctl" target="_blank" title="作者" class="beLink" data-v-06225672>sharkchili</a></div> <div title="创建时间" class="date iconfont icon-riqi" data-v-06225672><a href="javascript:;" data-v-06225672>2025-11-25</a></div> <!----></div></div></div> <!----> <div class="content-wrapper"><div class="right-menu-wrapper"><div class="right-menu-margin"><div class="right-menu-title">目录</div> <div class="right-menu-content"></div></div></div> <h1><img src="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB4AAAAeCAYAAAA7MK6iAAAAAXNSR0IArs4c6QAABKFJREFUSA3tVl1oFVcQnrMbrak3QUgkya1akpJYcrUtIqW1JvFBE9LiQ5v6JmJpolbMg32rVrhgoYK0QiMY6i9Y6EMaW5D+xFJaTYItIuK2Kr3+BJNwkxBj05sQY3b3nM6cs2dv9t7NT/vQJw/sndk5M/PNzJkzewGerP+pAmy+ON8lLzUJgA8ZYxYIYZmGYRnctDaWvJJAmTtfP1pvXsBCCPP8QFcCaRkZYACgDZFO4stNIcBCajEOlmmC9XpJ9bAGCaPaPmzPl32dvLSVu3BWCTQs0XQQ6g0DYgwLIoAZbBCdW/i+781o1VVlm/410mw4h06Y7bIPHNyWDyL4FHkX03Q8SrzNhZTZriieckWt7cL6MM85YcLpsi/7O9/iXFT6MswI0DmmpkSaJ0qLxFIm3+i1THHB3zmBH3PYx9CcykcLOeQVVa7QtdxTgQgEleX2AjHYfwA+2ddV77ruGoJUbhGDI09YSNXyMpUt5ylOzxgbUmtOp7NmbNt8v3arjTBfYELmLUV+M+nSawNNAUqpT3ClJWg5I3BLT+cGW/DXNGCa6tx1aakCGEigArTn4TDIPdrXXYKCZNrHLMCOEPvHBlLQ99s9eHB7EB6NTki73CVPQ2F5MSx/uRQixfmq7rK0wYD8w8E905bnPDfwoWs/rfv93NWN/ZfvwsLIU7A09gxECyISeGJkHAau98L97tuw7NXnoPyNF8FcYGLGKsOs0mN3OEyec9esGW/ZEl945dTP34wlR2FZVQWU1q0Cw8Tr7p+hgLLNL0FPxx/Q35mA8aEUrH6nCgwEl0tn7wUiZYJnNRh6DK4UH/k0lfyrsBKdPVv/AriGIQcEDQZ65LBAGe2Rzui9Ybjz7XUppz1/uKBbyVPGkN3ZAeC6hr0x7Nr38N5+EqkoOm17xpoqR9ohQF55ERSvr4Dkr3chNfC3DMzGJlNBElW8w9nsGQvhNGIzDkXzCg8cLK951xHsFBlTJspJNi3ZFIMF2AeDV3q8DNOB+YHi6QTrChDIWDBRi5U5f+ZMfJLu3ccrqxtdxk4SKH336LFxSmkqefwU5T8fhdSdQf9IVKD6aNiwI/hnmcAZ91isYMJIaCUCx9W098+LgruikeTqzqqxKPUwqJyCPJiyemVVZBOijDGjD38Os0jOiSPL1z3SPjXNANbiNPXAdzTfukjjuknNBbyz3nwgTd3AVFqUJ5hpHlq9MveLnWwttUfoygBmvVjuikxND3znrhsELnZk7k+OjIGxeNEkomyLVta0xxn+HZhjBc4YZ/AFjHjz9u3xRZl2BN4aq9nFwWh16IrQ1aHHEd3j1+4/dB9OtH4e29A2H1DyHQRmOSfQZ1Fy7MHBTGB6J/Djq6p3OxyO2cB+4Car7v/o3GXgfAkj23+x9ID1Teoamo/SXcbvSf2PX7Vc8DdCmE1vN9di+32P9/5YR3vLnhCVGUWBjEkr3yh4H8v9CzmsbdhzOKzsJKM90iFdaTMjRPhGVsakRvOaRidljo6H6G7j+ctrJpsP+4COhDIl0La2+FS4+5mlocBaXY5QnGZysIBYoeSsl5qQzrSj/cgNrfuEzlWBfwA+EjrZyWUvpAAAAABJRU5ErkJggg==">深入源码解析synchronized关键字<!----></h1> <div class="page-slot page-slot-top"><!-- 固定100% * 90px可显示，max-height:90px未见显示-->
        <ins class="adsbygoogle"
             style="display:inline-block;width:100%;max-height:90px"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="8542375009"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script></div> <div class="theme-vdoing-content content__default"><h2 id="写在文章开头"><a href="#写在文章开头" class="header-anchor">#</a> 写在文章开头</h2> <p>因为之前关于<code>synchronized</code>关键字底层工作机制理解有所偏差，简单查阅了一下其底层的实现，遂以此文简单记录一下<code>jdk8</code>版本<code>synchronized</code>关键字的设计理念和实现，希望对你有所帮助。</p> <p>我是 <strong>sharkchili</strong> ，<strong>CSDN Java 领域博客专家</strong>，<strong>mini-redis</strong>的作者，我想写一些有意思的东西，希望对你有帮助，如果你想实时收到我写的硬核的文章也欢迎你关注我的公众号： <strong>写代码的SharkChili</strong> 。</p> <p>同时也非常欢迎你star我的开源项目mini-redis:https://github.com/shark-ctrl/mini-redis</p> <h2 id="基于objectmonitor深入剖析synchronized关键字"><a href="#基于objectmonitor深入剖析synchronized关键字" class="header-anchor">#</a> 基于objectMonitor深入剖析synchronized关键字</h2> <h3 id="宏观了解synchronized同步机制"><a href="#宏观了解synchronized同步机制" class="header-anchor">#</a> 宏观了解synchronized同步机制</h3> <p>我们先从全局的维度了解一下<code>synchronized</code>关键字的实现，假设我们现在有三个线程尝试争抢对象锁，此时线程0最先通过<code>CAS</code>机制将锁的持有者标识为自己并成功获取锁，对应的线程1和线程2则CAS失败。此阶段线程0就可以操作锁内部对应的临界资源，即<code>synchronized</code>底层锁持有者标识就是<code>_owner</code>字段指向线程0：</p> <p><img src="https://qiniuyun.sharkchili.com/202511251013504.png" alt=""></p> <p>线程1和线程2在竞争失败后，会先尝试自旋获取锁，如果自旋失败则会进入阻塞队列中等待，直到锁释放，而这个队列可以是<code>_cxq</code>或者<code>_EntryList</code>。这里笔者为了简单直观地展现这一过程，将竞争失败的线程直接放入<code>_EntryList</code>队列来演示这一过程：</p> <p><img src="https://qiniuyun.sharkchili.com/202511251013581.png" alt=""></p> <p>我们再聊聊锁重入的情况，例如我们线程0之前上锁调用<code>synchronized</code>修饰的是<code>function1</code>，内部又调用<code>function2</code>，对应关键字底层也就是<code>objectMonitor</code>对象，也就是通过一个<code>_recursions</code>字段对重入次数进行累加，这也就意味着线程0进行锁释放时必须释放两次：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Example1</span> <span class="token punctuation">{</span>

    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">function1</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;function1&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">function2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">public</span> <span class="token keyword">synchronized</span> <span class="token keyword">void</span> <span class="token function">function2</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token class-name">Console</span><span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">&quot;function2&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      
    <span class="token punctuation">}</span>
  
   
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>然后就是挂起锁释放的场景，线程0期间因为特定原因，主动挂起调用<code>wait</code>方法，此时就需要完成锁释放操作，对应底层操作则是将其存入等待队列<code>_WaitSet</code>中，并将<code>_EntryList</code>中等待的线程唤醒尝试竞争锁(注意，不一定完全是<code>_EntryList</code>，这里更多是为了举例做一个普适的说明)：</p> <p><img src="https://qiniuyun.sharkchili.com/202511251013729.png" alt="sync-source-code-3.drawio"></p> <p>后续线程0被<code>notify</code>或者<code>notifyall</code>唤醒之后，还会再次回到<code>_EntryList</code>竞争锁。</p> <p>自此我们从宏观的角度了解了<code>synchronized</code>底层的工作机制，对应的我们也通过源码的角度给出了上述概念中的几个成员字段，整体和上述表述类似</p> <ol><li><code>_count</code>：等待获取该锁的线程数，通常为<code>_cxq</code>和_EntryList队列中的线程数总和</li> <li><code>_waiters</code>：调用wait方法进入等待状态的线程数</li> <li><code>_owner</code>：指向当前持有锁的线程</li> <li><code>_recursions</code>：线程重入次数，用于记录当前线程对同一把锁的重入次数</li></ol> <p>对应我们也给出<code>ObjectMonitor</code>结构体定义：</p> <div class="language-java line-numbers-mode"><pre class="language-java"><code><span class="token class-name">ObjectMonitor</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    _header       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    _count        <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//抢占该锁的线程数即 _cxq.size + EntryList.size</span>
    _waiters      <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">,</span><span class="token comment">//处于等待状态的线程数</span>
    _recursions   <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span><span class="token comment">//线程重入次数</span>
    _object       <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span>
    _owner        <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//当前锁即ObjectMonitor的拥有者</span>
    _WaitSet      <span class="token operator">=</span> <span class="token constant">NULL</span><span class="token punctuation">;</span><span class="token comment">//处于wait状态的线程会存入到该队列中</span>
    _WaitSetLock  <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    _Responsible  <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    _succ         <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    _cxq          <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span><span class="token comment">//多线程竞争时会进入该队列中</span>
    <span class="token class-name">FreeNext</span>      <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
    _EntryList    <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span><span class="token comment">//处于block等待锁状态的线程会进入该队列</span>
    _SpinFreq     <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    _SpinClock    <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    <span class="token class-name">OwnerIsThread</span> <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
    _previous_owner_tid <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br></div></div><p>上述说明我们也可以在源码<code>objectMonitor.cpp</code>中的注释中查阅到，感兴趣的读者可以翻阅这段注释了解具体的实现细节，其大体意思与上述描述基本一致。对应的，笔者简单概括如下：</p> <ol><li>线程必须通过<code>cas</code>将<code>owner</code>从<code>null</code>变为自己才算成功获得锁</li> <li>任意时刻线程因阻塞等待必须处于<code>cxq</code>或<code>EntryList</code>队列中，或者因<code>wait</code>调用进入<code>WaitSet</code>队列</li> <li>持有锁线程释放后，其必须唤醒<code>EntryList</code>一个候选线程争抢锁</li> <li>......</li></ol> <p><img src="https://qiniuyun.sharkchili.com/202511251013942.png" alt=""></p> <h3 id="详解并发锁资源竞争"><a href="#详解并发锁资源竞争" class="header-anchor">#</a> 详解并发锁资源竞争</h3> <p>线程基于<code>synchronized</code>关键字争抢锁资源的本质实现就是<code>objectMonitor.cpp</code>的<code>enter</code>方法，其上锁步骤严格：</p> <ol><li>尝试<code>cas</code>将<code>null</code>设置为当前线程的指针，如果<code>cas</code>方法返回null则说明自己获取锁成功直接返回，反之进入步骤2</li> <li>如果非空但返回指针地址是自己，说明当前线程之前已经获取过一个这把锁，本次为锁重入，直接累加重入次数<code>_recursions</code>后返回，反之进入步骤3</li> <li>判断当前持有锁的线程是否是这把锁的轻量级锁持有者，如果是，则执行一次锁升级将其升级为重量级锁，并将<code>owner</code>对象中栈上<code>BasicLockObject</code>地址转为完整的<code>thread</code>指针，反之进入步骤4</li> <li>上述步骤都不成功，则说明当前锁被其他线程持有，尝试自旋几次获取这把锁如果成功则直接返回，反之进入步骤5</li> <li>为了避免非必要的<code>CPU</code>自旋开销，累加<code>count</code>表示当前获取锁失败的线程数加一，再次自旋尝试几次</li> <li>几次尝试还是无果，将当前线程封装为等待节点存入等待队列，直到被唤醒拿到锁后退出</li> <li>通过步骤6的方式拿到锁的线程，会通过<code>cas</code>的方式完成等待线程数<code>count</code>值扣减并退出</li></ol> <p>对应的我们给出了这段代码的流程图，读者可参考上述说明理解：</p> <p><img src="https://qiniuyun.sharkchili.com/202511251013246.png" alt=""></p> <p>有了上述的基础之后，我们就可以查阅<code>objectMonitor.cpp</code>上锁逻辑enter的实现，逻辑和上述说明基本一致，我们也不难看出对应jdk8版本的<code>synchronized</code>关键字内置的优化，即核心理念就是尽可能利用<code>cas</code>竞争锁资源，明确感知到竞争激烈之后主动将其挂起，再利用等待通知模型唤醒线程竞争资源：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> ATTR ObjectMonitor<span class="token operator">::</span><span class="token function">enter</span><span class="token punctuation">(</span>TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
 <span class="token comment">//获取到当前线程的指针</span>
  Thread <span class="token operator">*</span> <span class="token keyword">const</span> Self <span class="token operator">=</span> THREAD <span class="token punctuation">;</span>
  <span class="token keyword">void</span> <span class="token operator">*</span> cur <span class="token punctuation">;</span>
  <span class="token comment">//尝试CAS的方式将owner从null设置为当前线程</span>
  cur <span class="token operator">=</span> Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>Self<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_owner<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">//如果返回null，说明当前线程是第一个获取到这把锁的，直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//......</span>
     <span class="token keyword">return</span> <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//非null且指针就是自己说明是重入，直接累加重入次数_recursions后返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>cur <span class="token operator">==</span> Self<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">//......</span>
     _recursions <span class="token operator">++</span> <span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//如果当前线程是轻量级锁的持有则，则进入该逻辑进行锁升级</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Self<span class="token operator">-&gt;</span><span class="token function">is_lock_owned</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span>cur<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">//......</span>
    <span class="token comment">//将owner从线程栈上的BasicLockObject地址转换为完整的Thread指针</span>
    _owner <span class="token operator">=</span> Self <span class="token punctuation">;</span>
    OwnerIsThread <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token comment">// We've encountered genuine contention.</span>
  <span class="token comment">//当前锁被其他线程占有，需要抢占</span>
  <span class="token function">assert</span> <span class="token punctuation">(</span>Self<span class="token operator">-&gt;</span>_Stalled <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">//记录需要抢占的线程monitor指针</span>
  Self<span class="token operator">-&gt;</span>_Stalled <span class="token operator">=</span> <span class="token class-name">intptr_t</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span> <span class="token punctuation">;</span>


  <span class="token comment">//尝试自旋获取锁，成功后返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>Knob_SpinEarly <span class="token operator">&amp;&amp;</span> <span class="token function">TrySpin</span> <span class="token punctuation">(</span>Self<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">//......</span>
     <span class="token keyword">return</span> <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token comment">//......</span>
  <span class="token comment">//经过上述步骤还是没有抢到锁，原子累加count值，即增加一个等待获取锁的线程</span>
  Atomic<span class="token operator">::</span><span class="token function">inc_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_count<span class="token punctuation">)</span><span class="token punctuation">;</span>

  EventJavaMonitorEnter event<span class="token punctuation">;</span>

		<span class="token comment">//......</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      jt<span class="token operator">-&gt;</span><span class="token function">set_suspend_equivalent</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token comment">// cleared by handle_special_suspend_equivalent_condition()</span>
      <span class="token comment">// or java_suspend_self()</span>
      <span class="token comment">//尝试CAS或者自旋等方式获取锁，若失败则通过头插法将线程存入cxq队列中，等待后续通知唤醒</span>
      <span class="token function">EnterI</span> <span class="token punctuation">(</span>THREAD<span class="token punctuation">)</span> <span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">ExitSuspendEquivalent</span><span class="token punctuation">(</span>jt<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>

      <span class="token comment">//......</span>
      <span class="token comment">//完成操作后，锁释放通知其他线程上锁</span>
      <span class="token function">exit</span> <span class="token punctuation">(</span>false<span class="token punctuation">,</span> Self<span class="token punctuation">)</span> <span class="token punctuation">;</span>

      jt<span class="token operator">-&gt;</span><span class="token function">java_suspend_self</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    Self<span class="token operator">-&gt;</span><span class="token function">set_current_pending_monitor</span><span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

   
    <span class="token comment">// acquire it.</span>
  <span class="token punctuation">}</span>
  <span class="token comment">//原子扣减count告知等待锁的线程少一个</span>
  Atomic<span class="token operator">::</span><span class="token function">dec_ptr</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>_count<span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br></div></div><h3 id="锁释放流程解析"><a href="#锁释放流程解析" class="header-anchor">#</a> 锁释放流程解析</h3> <p>对于锁释放流程，整体逻辑比较简单，对应的执行步骤为：</p> <ol><li>查看当前线程是否是<code>owner</code>指针指向的线程，如果不是，则存在锁升级但是当前线程是这把锁轻量级时期持有者的情况，则进一步判断线程是否是轻量级锁持有者，如果是则进入步骤2</li> <li>查看<code>_recursions</code>是否不为0，若不为0则说明是重入，扣减<code>_recursions</code>后返回</li> <li>上述检查无误，将锁直接释放，然后进入步骤4</li> <li>当前线程进行<code>cas</code>尝试将<code>owner</code>从<code>null</code>设置为自己以查看是否存在其他线程竞争，如果失败则说明锁被其他线程持有，不需要执行后续唤醒线程的任务直接返回，反之进入步骤5</li> <li>来到步骤5，这也就意味着当前监视锁没有被其它线程获取，当前线程需要执行唤醒等待线程的任务，唤醒线程不一定是从<code>EntryList</code>也可能从<code>cxq</code>队列，对应的唤醒策略由<code>QMode</code>决定，具体规则如下：</li></ol> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token number">1.</span> QMode为<span class="token number">2</span>直接唤醒cxq队列首元素线程，让其竞争监视锁
<span class="token number">2.</span> QMode为<span class="token number">3</span>，则查看cxq队列是否非空，若明确非空则将其追加到EntryList中，若EntryList为空则直接将cxq队列设置为EntryList，然后将首元素唤醒
<span class="token number">3.</span> QMode为<span class="token number">4</span>，则将EntryList追加到cxq队列后，然后让cxq队列作为EntryList首元素，将首个线程唤醒竞争监视锁


<span class="token comment">/************************* 执行到步骤4和5，说明代码中的逻辑判断明确EntryList为空，对应不同的QMode规则为**************/</span>


<span class="token number">4.</span> QMode为<span class="token number">1</span>，将cxq队列倒叙排列后作为EntryList，并将首元素唤醒
<span class="token number">5.</span> QMode为<span class="token number">0</span>或<span class="token number">2</span>，将cxq直接封装为ObjectWaiter作为EntryList，并将首元素唤醒
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><ol start="7"><li>特殊步骤：如果发现<code>w</code>为空则说明<code>cxq</code>和<code>EntryList</code>队列都为空，则重新从循环头开始执行正确的退出协议</li></ol> <p>对应如下是笔者整理的流程图，读者可以基于上述说明进行梳理归纳：</p> <p><img src="https://qiniuyun.sharkchili.com/202511251013565.png" alt=""></p> <p>对应位于<code>objectMonitor.cpp</code>的<code>exit</code>函数就是我们释放锁的逻辑，这里笔者整理出核心的代码段，读者可结合注释更进一步理解：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> ATTR ObjectMonitor<span class="token operator">::</span><span class="token function">exit</span><span class="token punctuation">(</span>bool not_suspended<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
   Thread <span class="token operator">*</span> Self <span class="token operator">=</span> THREAD <span class="token punctuation">;</span>
   <span class="token comment">//如果当前线程不等于_owner则进入当前逻辑</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>THREAD <span class="token operator">!=</span> _owner<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>THREAD<span class="token operator">-&gt;</span><span class="token function">is_lock_owned</span><span class="token punctuation">(</span><span class="token punctuation">(</span>address<span class="token punctuation">)</span> _owner<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果当前线程持有这把锁的轻量级锁，则将其设置为重量级锁并让_owner指向完整的线程地址，然后执行后续的锁释放逻辑</span>
      <span class="token comment">//......</span>
       <span class="token function">assert</span> <span class="token punctuation">(</span>_recursions <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
       _owner <span class="token operator">=</span> THREAD <span class="token punctuation">;</span>
       _recursions <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
       OwnerIsThread <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
     <span class="token comment">//......</span>
       <span class="token comment">/*
     
       JNI（Java Native Interface）本地代码中可能出现的监视器（即 synchronized 锁）使用不平衡的情况，
       比如进入 monitor 但没有正确退出，或者退出没有对应的进入。当检测到这种异常情况时，应该抛出 Java 的
       IllegalMonitorStateException 异常来通知开发者。
       */</span>
       <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Exit <span class="token operator">-</span> Throw IMSX<span class="token punctuation">)</span> <span class="token punctuation">;</span>
       <span class="token function">assert</span><span class="token punctuation">(</span>false<span class="token punctuation">,</span> <span class="token string">&quot;Non-balanced monitor enter/exit!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>false<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">THROW</span><span class="token punctuation">(</span>vmSymbols<span class="token operator">::</span><span class="token function">java_lang_IllegalMonitorStateException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
       <span class="token punctuation">}</span>
       <span class="token keyword">return</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//_recursions不为0，说明此前线程重入过，完成_recursions扣减后返回，不重置owner指针</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>_recursions <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     _recursions<span class="token operator">--</span><span class="token punctuation">;</span>        <span class="token comment">// this is simple recursive enter</span>
     <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Inflated exit <span class="token operator">-</span> recursive<span class="token punctuation">)</span> <span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

   <span class="token comment">//......</span>

   <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">assert</span> <span class="token punctuation">(</span>THREAD <span class="token operator">==</span> _owner<span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>


      <span class="token keyword">if</span> <span class="token punctuation">(</span>Knob_ExitPolicy <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//......</span>

         <span class="token comment">//将ownder设置为null，即释放锁</span>
         OrderAccess<span class="token operator">::</span><span class="token function">release_store_ptr</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_owner<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>   <span class="token comment">// drop the lock</span>
         OrderAccess<span class="token operator">::</span><span class="token function">storeload</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>                         <span class="token comment">// See if we need to wake a successor</span>
        <span class="token comment">//......</span>
         <span class="token comment">//cas尝试一下线程从null设置为自己，如果非空则说明锁被其他线程持有，不执行后续唤醒其他线程的逻辑</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>THREAD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_owner<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Exit <span class="token operator">-</span> Reacquired<span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">intptr_t</span><span class="token punctuation">(</span>_EntryList<span class="token punctuation">)</span><span class="token operator">|</span><span class="token class-name">intptr_t</span><span class="token punctuation">(</span>_cxq<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span> <span class="token operator">||</span> _succ <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token comment">//释放锁</span>
            OrderAccess<span class="token operator">::</span><span class="token function">release_store_ptr</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_owner<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>   <span class="token comment">// drop the lock</span>
           <span class="token comment">//......</span>
            <span class="token comment">//尝试cas上锁，如果不成功则说明当前锁被其他线程持有，则当前线程不负责后续唤醒等待线程的职责，直接返回</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>THREAD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_owner<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
               <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Inflated exit <span class="token operator">-</span> reacquired succeeded<span class="token punctuation">)</span> <span class="token punctuation">;</span>
               <span class="token keyword">return</span> <span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Inflated exit <span class="token operator">-</span> reacquired failed<span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Inflated exit <span class="token operator">-</span> complex egress<span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

    <span class="token comment">//......</span>

      ObjectWaiter <span class="token operator">*</span> w <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
      <span class="token keyword">int</span> QMode <span class="token operator">=</span> Knob_QMode <span class="token punctuation">;</span>
	
      <span class="token keyword">if</span> <span class="token punctuation">(</span>QMode <span class="token operator">==</span> <span class="token number">2</span> <span class="token operator">&amp;&amp;</span> _cxq <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//QMode为2且cxq队列非空，直接唤醒cxq队列首元素直接返回</span>
        
          w <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
          <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token function">assert</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQ<span class="token punctuation">,</span> <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token comment">//传入_cxq队列首元素地址，唤醒对应线程去竞争锁资源</span>
          <span class="token function">ExitEpilog</span> <span class="token punctuation">(</span>Self<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>QMode <span class="token operator">==</span> <span class="token number">3</span> <span class="token operator">&amp;&amp;</span> _cxq <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
       
        <span class="token comment">//</span>
          <span class="token comment">// 通过CAS将_cxq设置为空</span>
          <span class="token comment">// 将w（即原有的cxq队列）转换为双向链表的waiter</span>
          <span class="token comment">// 将最近到达的线程（RATs）追加到EntryList</span>
          <span class="token comment">// TODO：将EntryList组织为循环双向链表（CDLL），这样我们就能在常量时间内定位到尾部。</span>
          <span class="token comment">// 把cxq挂到_EntryList队列上，后续从_EntryList中唤醒</span>
          <span class="token comment">// 查找EntryList的尾部</span>
          <span class="token comment">// 如果EntryList为空，则将w设为EntryList</span>
          <span class="token comment">// 否则将w链接到EntryList尾部</span>
          w <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
             <span class="token comment">//通过cas把cxq设置为空</span>
             ObjectWaiter <span class="token operator">*</span> u <span class="token operator">=</span> <span class="token punctuation">(</span>ObjectWaiter <span class="token operator">*</span><span class="token punctuation">)</span> Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>_cxq<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">==</span> w<span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>
             w <span class="token operator">=</span> u <span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
      

          ObjectWaiter <span class="token operator">*</span> q <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
          ObjectWaiter <span class="token operator">*</span> p <span class="token punctuation">;</span>
          <span class="token comment">//将w即原有cxq队列转为一个双向链表的waiter</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> w <span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">guarantee</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQ<span class="token punctuation">,</span> <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
              p<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER <span class="token punctuation">;</span>
              p<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> q <span class="token punctuation">;</span>
              q <span class="token operator">=</span> p <span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

     
          <span class="token comment">//如果_EntryList非空的话直接将其追加到cxq队列，反之cxq队列直接作为_EntryList</span>
          ObjectWaiter <span class="token operator">*</span> Tail <span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>Tail <span class="token operator">=</span> _EntryList <span class="token punctuation">;</span> Tail <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> Tail<span class="token operator">-&gt;</span>_next <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span> Tail <span class="token operator">=</span> Tail<span class="token operator">-&gt;</span>_next<span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>Tail <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              _EntryList <span class="token operator">=</span> w <span class="token punctuation">;</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
              Tail<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> w <span class="token punctuation">;</span>
              w<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> Tail <span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
        

          <span class="token comment">// Fall thru into code that tries to wake a successor from EntryList</span>
      <span class="token punctuation">}</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span>QMode <span class="token operator">==</span> <span class="token number">4</span> <span class="token operator">&amp;&amp;</span> _cxq <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//如果QMode且_cxq非空，则把_EntryList挂到cxq上</span>
          <span class="token comment">// Aggressively drain cxq into EntryList at the first opportunity.</span>
     
          <span class="token comment">//w指针指向cxq队列后，通过cas将cxq指针置空</span>
          w <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
             ObjectWaiter <span class="token operator">*</span> u <span class="token operator">=</span> <span class="token punctuation">(</span>ObjectWaiter <span class="token operator">*</span><span class="token punctuation">)</span> Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>_cxq<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
             <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">==</span> w<span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>
             w <span class="token operator">=</span> u <span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span>              <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token comment">//将w(原cxq队列封装为等待队列)</span>
          ObjectWaiter <span class="token operator">*</span> q <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
          ObjectWaiter <span class="token operator">*</span> p <span class="token punctuation">;</span>
          <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> w <span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">guarantee</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQ<span class="token punctuation">,</span> <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
              p<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER <span class="token punctuation">;</span>
              p<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> q <span class="token punctuation">;</span>
              q <span class="token operator">=</span> p <span class="token punctuation">;</span>
          <span class="token punctuation">}</span>

          <span class="token comment">// Prepend the RATs to the EntryList</span>
          <span class="token comment">//将_EntryList追加到w(原cxq队列)</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>_EntryList <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
              q<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> _EntryList <span class="token punctuation">;</span>
              _EntryList<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> q <span class="token punctuation">;</span>
          <span class="token punctuation">}</span>
          _EntryList <span class="token operator">=</span> w <span class="token punctuation">;</span>

          <span class="token comment">// Fall thru into code that tries to wake a successor from EntryList</span>
      <span class="token punctuation">}</span>

      w <span class="token operator">=</span> _EntryList  <span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span><span class="token comment">//从_EntryList找到节点唤醒指定线程返回</span>
      
          <span class="token function">assert</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER<span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token function">ExitEpilog</span> <span class="token punctuation">(</span>Self<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">;</span>
      <span class="token punctuation">}</span>

   
      w <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
      <span class="token comment">//如果发现w为空则说明cxq和entrylist队列都为空，则重新从循环头开始执行正确的退出协议</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token keyword">continue</span> <span class="token punctuation">;</span>

   
      <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">assert</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
          ObjectWaiter <span class="token operator">*</span> u <span class="token operator">=</span> <span class="token punctuation">(</span>ObjectWaiter <span class="token operator">*</span><span class="token punctuation">)</span> Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span><span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token operator">&amp;</span>_cxq<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token keyword">if</span> <span class="token punctuation">(</span>u <span class="token operator">==</span> w<span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>
          w <span class="token operator">=</span> u <span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
  

      <span class="token keyword">if</span> <span class="token punctuation">(</span>QMode <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token comment">// QMode == 1 : drain cxq to EntryList, reversing order</span>
         <span class="token comment">// We also reverse the order of the list.</span>
         <span class="token comment">//当 QMode 设置为 1 时，</span>
         <span class="token comment">//ObjectMonitor 会将 cxq（竞争队列）中的所有等待线程移动到 EntryList（入口列表）中，</span>
         <span class="token comment">// 但在这个过程中会将线程的顺序颠倒。这种设计可能是为了实现某种调度策略，比如让最后到达的线程优先获得锁（LIFO - 后进先出）</span>
         ObjectWaiter <span class="token operator">*</span> s <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
         ObjectWaiter <span class="token operator">*</span> t <span class="token operator">=</span> w <span class="token punctuation">;</span>
         ObjectWaiter <span class="token operator">*</span> u <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
         <span class="token keyword">while</span> <span class="token punctuation">(</span>t <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token comment">//将cxq队列元素倒叙排列一下</span>
             <span class="token function">guarantee</span> <span class="token punctuation">(</span>t<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQ<span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
             t<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER <span class="token punctuation">;</span>
             u <span class="token operator">=</span> t<span class="token operator">-&gt;</span>_next <span class="token punctuation">;</span>
             t<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> u <span class="token punctuation">;</span>
             t<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> s <span class="token punctuation">;</span>
             s <span class="token operator">=</span> t<span class="token punctuation">;</span>
             t <span class="token operator">=</span> u <span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         _EntryList  <span class="token operator">=</span> s <span class="token punctuation">;</span>
         <span class="token function">assert</span> <span class="token punctuation">(</span>s <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token comment">// QMode == 0 or QMode == 2 直接顺序生成等待节点</span>
         _EntryList <span class="token operator">=</span> w <span class="token punctuation">;</span>
         ObjectWaiter <span class="token operator">*</span> q <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
         ObjectWaiter <span class="token operator">*</span> p <span class="token punctuation">;</span>
         <span class="token keyword">for</span> <span class="token punctuation">(</span>p <span class="token operator">=</span> w <span class="token punctuation">;</span> p <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span> p <span class="token operator">=</span> p<span class="token operator">-&gt;</span>_next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
             <span class="token function">guarantee</span> <span class="token punctuation">(</span>p<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQ<span class="token punctuation">,</span> <span class="token string">&quot;Invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
             p<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER <span class="token punctuation">;</span>
             p<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> q <span class="token punctuation">;</span>
             q <span class="token operator">=</span> p <span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>

   
      <span class="token comment">//拿到首元素唤醒，让其尝试竞争监视锁资源</span>
      w <span class="token operator">=</span> _EntryList  <span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>w <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">guarantee</span> <span class="token punctuation">(</span>w<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER<span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token function">ExitEpilog</span> <span class="token punctuation">(</span>Self<span class="token punctuation">,</span> w<span class="token punctuation">)</span> <span class="token punctuation">;</span>
          <span class="token keyword">return</span> <span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
   <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br><span class="line-number">137</span><br><span class="line-number">138</span><br><span class="line-number">139</span><br><span class="line-number">140</span><br><span class="line-number">141</span><br><span class="line-number">142</span><br><span class="line-number">143</span><br><span class="line-number">144</span><br><span class="line-number">145</span><br><span class="line-number">146</span><br><span class="line-number">147</span><br><span class="line-number">148</span><br><span class="line-number">149</span><br><span class="line-number">150</span><br><span class="line-number">151</span><br><span class="line-number">152</span><br><span class="line-number">153</span><br><span class="line-number">154</span><br><span class="line-number">155</span><br><span class="line-number">156</span><br><span class="line-number">157</span><br><span class="line-number">158</span><br><span class="line-number">159</span><br><span class="line-number">160</span><br><span class="line-number">161</span><br><span class="line-number">162</span><br><span class="line-number">163</span><br><span class="line-number">164</span><br><span class="line-number">165</span><br><span class="line-number">166</span><br><span class="line-number">167</span><br><span class="line-number">168</span><br><span class="line-number">169</span><br><span class="line-number">170</span><br><span class="line-number">171</span><br><span class="line-number">172</span><br><span class="line-number">173</span><br><span class="line-number">174</span><br><span class="line-number">175</span><br><span class="line-number">176</span><br><span class="line-number">177</span><br><span class="line-number">178</span><br><span class="line-number">179</span><br><span class="line-number">180</span><br><span class="line-number">181</span><br><span class="line-number">182</span><br><span class="line-number">183</span><br><span class="line-number">184</span><br><span class="line-number">185</span><br><span class="line-number">186</span><br><span class="line-number">187</span><br><span class="line-number">188</span><br><span class="line-number">189</span><br><span class="line-number">190</span><br><span class="line-number">191</span><br><span class="line-number">192</span><br><span class="line-number">193</span><br><span class="line-number">194</span><br><span class="line-number">195</span><br><span class="line-number">196</span><br><span class="line-number">197</span><br><span class="line-number">198</span><br><span class="line-number">199</span><br><span class="line-number">200</span><br><span class="line-number">201</span><br><span class="line-number">202</span><br><span class="line-number">203</span><br><span class="line-number">204</span><br><span class="line-number">205</span><br><span class="line-number">206</span><br><span class="line-number">207</span><br><span class="line-number">208</span><br><span class="line-number">209</span><br><span class="line-number">210</span><br><span class="line-number">211</span><br><span class="line-number">212</span><br><span class="line-number">213</span><br><span class="line-number">214</span><br><span class="line-number">215</span><br><span class="line-number">216</span><br><span class="line-number">217</span><br><span class="line-number">218</span><br><span class="line-number">219</span><br><span class="line-number">220</span><br><span class="line-number">221</span><br><span class="line-number">222</span><br><span class="line-number">223</span><br><span class="line-number">224</span><br><span class="line-number">225</span><br><span class="line-number">226</span><br></div></div><h3 id="挂起等待的wait调用"><a href="#挂起等待的wait调用" class="header-anchor">#</a> 挂起等待的wait调用</h3> <p>线程调用<code>wait</code>方法时就会释放锁进入等待队列，等待超时<code>this.wait(5000L);</code>或者被唤醒后重新竞争监视锁资源，对应的处理步骤为：</p> <ol><li>进行必要的中断检查，如果发现调用<code>wait</code>时线程正在处理中断，则直接抛出中断异常，反之进入步骤2</li> <li>将节点封装为等待节点</li> <li>自旋获取等待队列的锁，将线程存入等待队列</li> <li>保存好当前线程的<code>_recursions</code>重入次数后(便于后续线程再次持有锁之后重入和释放锁次数一致性)，将锁的<code>_recursions</code>重置，调用<code>exit</code>退出监视锁</li> <li>按照<code>wait</code>传参进行有限或者无限时间的等待，直到被唤醒</li> <li>唤醒后，查看自己当前状态如果处于<code>TS_RUN</code>则直接尝试竞争锁，如果是<code>TS_ENTER</code>或者<code>TS_CXQ</code>则进行必要的自旋尝试竞争锁后挂起等待</li> <li>上锁成功后，恢复锁重入次数，扣减<code>_waiters</code>告知等待线程减少一个</li> <li>操作临界资源</li></ol> <p>这段逻辑比较简单，读者可直接基于上述说明查看<code>wait</code>代码的底层实现：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> ObjectMonitor<span class="token operator">::</span><span class="token function">wait</span><span class="token punctuation">(</span>jlong millis<span class="token punctuation">,</span> bool interruptible<span class="token punctuation">,</span> TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">//Self指向当前线程的指针</span>
   Thread <span class="token operator">*</span> <span class="token keyword">const</span> Self <span class="token operator">=</span> THREAD <span class="token punctuation">;</span>
   <span class="token comment">//......</span>

   <span class="token comment">// check for a pending interrupt</span>
   <span class="token comment">// 检查是否存在待处理的中断，若明确处理中断则直接抛出中断异常</span>
   <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptible <span class="token operator">&amp;&amp;</span> Thread<span class="token operator">::</span><span class="token function">is_interrupted</span><span class="token punctuation">(</span>Self<span class="token punctuation">,</span> true<span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>HAS_PENDING_EXCEPTION<span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token comment">//......</span>
     <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Wait <span class="token operator">-</span> Throw IEX<span class="token punctuation">)</span> <span class="token punctuation">;</span>
     <span class="token function">THROW</span><span class="token punctuation">(</span>vmSymbols<span class="token operator">::</span><span class="token function">java_lang_InterruptedException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token keyword">return</span> <span class="token punctuation">;</span>
   <span class="token punctuation">}</span>

	 <span class="token comment">//......</span>
   <span class="token comment">//将当前节点封装为wait</span>
   ObjectWaiter <span class="token function">node</span><span class="token punctuation">(</span>Self<span class="token punctuation">)</span><span class="token punctuation">;</span>
   node<span class="token punctuation">.</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_WAIT <span class="token punctuation">;</span>
   Self<span class="token operator">-&gt;</span>_ParkEvent<span class="token operator">-&gt;</span><span class="token function">reset</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
   <span class="token comment">//......</span>
   <span class="token comment">//自旋获取waitSet锁将节点存入waiterSet然后释放锁</span>
   Thread<span class="token operator">::</span><span class="token function">SpinAcquire</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_WaitSetLock<span class="token punctuation">,</span> <span class="token string">&quot;WaitSet - add&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
   <span class="token function">AddWaiter</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">)</span> <span class="token punctuation">;</span>
   Thread<span class="token operator">::</span><span class="token function">SpinRelease</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_WaitSetLock<span class="token punctuation">)</span> <span class="token punctuation">;</span>

  
   <span class="token class-name">intptr_t</span> save <span class="token operator">=</span> _recursions<span class="token punctuation">;</span> <span class="token comment">// record the old recursion count 保存旧的递归计数，便于后续唤醒恢复</span>
   _waiters<span class="token operator">++</span><span class="token punctuation">;</span>                  <span class="token comment">// increment the number of waiters 增加等待者数量</span>
   _recursions <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>             <span class="token comment">// set the recursion level to be 1 将递归级别设置为1</span>
   
   <span class="token function">exit</span> <span class="token punctuation">(</span>true<span class="token punctuation">,</span> Self<span class="token punctuation">)</span> <span class="token punctuation">;</span>                    <span class="token comment">// exit the monitor 退出监视器</span>
 

   <span class="token comment">//......</span>

   <span class="token keyword">int</span> ret <span class="token operator">=</span> OS_OK <span class="token punctuation">;</span>
   <span class="token keyword">int</span> WasNotified <span class="token operator">=</span> <span class="token number">0</span> <span class="token punctuation">;</span>
   <span class="token comment">//获取当前线程的park挂起</span>
   <span class="token punctuation">{</span> <span class="token comment">// State transition wrappers</span>
     OSThread<span class="token operator">*</span> osthread <span class="token operator">=</span> Self<span class="token operator">-&gt;</span><span class="token function">osthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     OSThreadWaitState <span class="token function">osts</span><span class="token punctuation">(</span>osthread<span class="token punctuation">,</span> true<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">{</span>
      <span class="token comment">//......</span>

       <span class="token keyword">if</span> <span class="token punctuation">(</span>interruptible <span class="token operator">&amp;&amp;</span> <span class="token punctuation">(</span>Thread<span class="token operator">::</span><span class="token function">is_interrupted</span><span class="token punctuation">(</span>THREAD<span class="token punctuation">,</span> false<span class="token punctuation">)</span> <span class="token operator">||</span> HAS_PENDING_EXCEPTION<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
           <span class="token comment">// Intentionally empty</span>
           <span class="token comment">// 故意为空</span>
       <span class="token punctuation">}</span> <span class="token keyword">else</span>
       <span class="token comment">//按照指定的传入等待时间参数等待，若没设置时间则无限期挂起等待直到唤醒</span>
       <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>_notified <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>millis <span class="token operator">&lt;=</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            Self<span class="token operator">-&gt;</span>_ParkEvent<span class="token operator">-&gt;</span><span class="token function">park</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            ret <span class="token operator">=</span> Self<span class="token operator">-&gt;</span>_ParkEvent<span class="token operator">-&gt;</span><span class="token function">park</span> <span class="token punctuation">(</span>millis<span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
       <span class="token punctuation">}</span>

      <span class="token comment">//......</span>

     <span class="token punctuation">}</span> <span class="token comment">// Exit thread safepoint: transition _thread_blocked -&gt; _thread_in_vm</span>
     <span class="token comment">//......</span>


   

     <span class="token comment">//自旋获取锁将线程中等待节点移除，并将其状态设置为TS_RUN，尝试争抢锁</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_WAIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         Thread<span class="token operator">::</span><span class="token function">SpinAcquire</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_WaitSetLock<span class="token punctuation">,</span> <span class="token string">&quot;WaitSet - unlink&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>node<span class="token punctuation">.</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_WAIT<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">DequeueSpecificWaiter</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">)</span> <span class="token punctuation">;</span>       <span class="token comment">// unlink from WaitSet</span>
            <span class="token comment">// 从WaitSet中解除链接</span>
            <span class="token function">assert</span><span class="token punctuation">(</span>node<span class="token punctuation">.</span>_notified <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            node<span class="token punctuation">.</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_RUN <span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
         Thread<span class="token operator">::</span><span class="token function">SpinRelease</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_WaitSetLock<span class="token punctuation">)</span> <span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

   

     <span class="token comment">//......</span>
     ObjectWaiter<span class="token operator">::</span>TStates v <span class="token operator">=</span> node<span class="token punctuation">.</span>TState <span class="token punctuation">;</span>
     <span class="token comment">//查看被唤醒的线程当前处于什么状态，如果状态为TS_RUN则调用enter直接去竞争锁，反之说明节点在等待队列中，进行必要的自旋竞争后进入cxq或者entrylist中等待唤醒</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_RUN<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token function">enter</span> <span class="token punctuation">(</span>Self<span class="token punctuation">)</span> <span class="token punctuation">;</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
         <span class="token function">guarantee</span> <span class="token punctuation">(</span>v <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER <span class="token operator">||</span> v <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_CXQ<span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
         <span class="token function">ReenterI</span> <span class="token punctuation">(</span>Self<span class="token punctuation">,</span> <span class="token operator">&amp;</span>node<span class="token punctuation">)</span> <span class="token punctuation">;</span>
         node<span class="token punctuation">.</span><span class="token function">wait_reenter_end</span><span class="token punctuation">(</span>this<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token comment">//......</span>
   <span class="token punctuation">}</span> 
	 <span class="token comment">//......</span>
   _recursions <span class="token operator">=</span> save<span class="token punctuation">;</span>     <span class="token comment">// restore the old recursion count 恢复旧的递归计数</span>

   _waiters<span class="token operator">--</span><span class="token punctuation">;</span>             <span class="token comment">// decrement the number of waiters 减少等待者数量</span>



  <span class="token comment">//......</span>

  
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br></div></div><h3 id="通知唤醒的notify操作"><a href="#通知唤醒的notify操作" class="header-anchor">#</a> 通知唤醒的notify操作</h3> <p>在分析wait源码的时候，笔者提及wait唤醒的队列可能在cxq或者在entryList队列中，本质上是notify操作的等待队列处理策略，当线程通过notify操作尝试通知处于waitset中的线程时，其底层的notify调用整体执行步骤为：</p> <ol><li>判断<code>_WaitSet</code>是否非空，若非空执行步骤2</li> <li>通过自旋获取<code>_WaitSet</code>的锁，着手处理<code>_WaitSet</code>中的线程</li> <li>上锁成功后，按照配置的策略处理<code>_WaitSet</code>中的元素，具体策略为：</li></ol> <div class="language-bash line-numbers-mode"><pre class="language-bash"><code>策略0：如果EntryList非空的话，则将等待者添加到EntryList的头部
策略1：将等待者添加到EntryList的尾部
策略2：将等待者添加到cxq的头部
策略3：将等待者添加到cxq的尾部
其他:  直接唤醒WaitSet中的首个线程，让其竞争监视锁
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br></div></div><ol start="4"><li>释放<code>WaitSet</code>锁</li></ol> <p><code>notify</code>源码逻辑比较清晰简单，读者可结合笔者的注释自行阅读了解一下细节，并串联上述的说明完成逻辑闭环：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">void</span> ObjectMonitor<span class="token operator">::</span><span class="token function">notify</span><span class="token punctuation">(</span>TRAPS<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token function">CHECK_OWNER</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">//_WaitSet为空直接返回</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>_WaitSet <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Empty<span class="token operator">-</span>Notify<span class="token punctuation">)</span> <span class="token punctuation">;</span>
     <span class="token comment">// 记录空通知事件</span>
     <span class="token keyword">return</span> <span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token function">DTRACE_MONITOR_PROBE</span><span class="token punctuation">(</span>notify<span class="token punctuation">,</span> this<span class="token punctuation">,</span> <span class="token function">object</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> THREAD<span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token keyword">int</span> Policy <span class="token operator">=</span> Knob_MoveNotifyee <span class="token punctuation">;</span>

  <span class="token comment">//通过自旋获取等待队列的锁</span>
  Thread<span class="token operator">::</span><span class="token function">SpinAcquire</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_WaitSetLock<span class="token punctuation">,</span> <span class="token string">&quot;WaitSet - notify&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">//拿到waitSet</span>
  ObjectWaiter <span class="token operator">*</span> iterator <span class="token operator">=</span> <span class="token function">DequeueWaiter</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
  <span class="token comment">// 从等待队列中取出一个等待者</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>iterator <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
     <span class="token function">TEVENT</span> <span class="token punctuation">(</span>Notify1 <span class="token operator">-</span> Transfer<span class="token punctuation">)</span> <span class="token punctuation">;</span>
     <span class="token function">guarantee</span> <span class="token punctuation">(</span>iterator<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_WAIT<span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
     <span class="token function">guarantee</span> <span class="token punctuation">(</span>iterator<span class="token operator">-&gt;</span>_notified <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>Policy <span class="token operator">!=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        iterator<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER <span class="token punctuation">;</span>
        <span class="token comment">// 将等待者状态设置为进入状态</span>
     <span class="token punctuation">}</span>
     iterator<span class="token operator">-&gt;</span>_notified <span class="token operator">=</span> <span class="token number">1</span> <span class="token punctuation">;</span>

     Thread <span class="token operator">*</span> Self <span class="token operator">=</span> THREAD<span class="token punctuation">;</span>
     iterator<span class="token operator">-&gt;</span>_notifier_tid <span class="token operator">=</span> Self<span class="token operator">-&gt;</span><span class="token function">osthread</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">-&gt;</span><span class="token function">thread_id</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
   
     <span class="token comment">//定位到等待队列</span>
     ObjectWaiter <span class="token operator">*</span> List <span class="token operator">=</span> _EntryList <span class="token punctuation">;</span>
     <span class="token comment">// 获取EntryList</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>List <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>List<span class="token operator">-&gt;</span>_prev <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>List<span class="token operator">-&gt;</span>TState <span class="token operator">==</span> ObjectWaiter<span class="token operator">::</span>TS_ENTER<span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token function">assert</span> <span class="token punctuation">(</span>List <span class="token operator">!=</span> iterator<span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token comment">// 策略0：如果EntryList非空的话，则将等待者添加到EntryList的头部</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>Policy <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>       <span class="token comment">// prepend to EntryList</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>List <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             iterator<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> iterator<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
             _EntryList <span class="token operator">=</span> iterator <span class="token punctuation">;</span>
           
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
             List<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> iterator <span class="token punctuation">;</span>
             iterator<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> List <span class="token punctuation">;</span>
             iterator<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
             _EntryList <span class="token operator">=</span> iterator <span class="token punctuation">;</span>
           
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>Policy <span class="token operator">==</span> <span class="token number">1</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// append to EntryList</span>
         <span class="token comment">// 策略1：将等待者添加到EntryList的尾部</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>List <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             iterator<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> iterator<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
             _EntryList <span class="token operator">=</span> iterator <span class="token punctuation">;</span>
             <span class="token comment">// 如果EntryList为空，则直接将等待者设为EntryList</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
       
            ObjectWaiter <span class="token operator">*</span> Tail <span class="token punctuation">;</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>Tail <span class="token operator">=</span> List <span class="token punctuation">;</span> Tail<span class="token operator">-&gt;</span>_next <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span> Tail <span class="token operator">=</span> Tail<span class="token operator">-&gt;</span>_next<span class="token punctuation">)</span> <span class="token punctuation">;</span>
            <span class="token comment">// 查找EntryList的尾部</span>
            <span class="token function">assert</span> <span class="token punctuation">(</span>Tail <span class="token operator">!=</span> <span class="token constant">NULL</span> <span class="token operator">&amp;&amp;</span> Tail<span class="token operator">-&gt;</span>_next <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
            <span class="token comment">// 断言：尾部不为NULL且下一个元素为NULL</span>
            Tail<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> iterator <span class="token punctuation">;</span>
            iterator<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> Tail <span class="token punctuation">;</span>
            iterator<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
            <span class="token comment">// 将等待者添加到EntryList的尾部</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span>
     <span class="token comment">//策略2：将等待者添加到cxq的头部</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>Policy <span class="token operator">==</span> <span class="token number">2</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// prepend to cxq</span>
       
         <span class="token comment">// prepend to cxq</span>
         <span class="token keyword">if</span> <span class="token punctuation">(</span>List <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
             iterator<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> iterator<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
             _EntryList <span class="token operator">=</span> iterator <span class="token punctuation">;</span>
             <span class="token comment">// 如果EntryList为空，则直接将等待者设为EntryList</span>
         <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            iterator<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_CXQ <span class="token punctuation">;</span>
            <span class="token comment">// 将等待者状态设置为CXQ状态</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                ObjectWaiter <span class="token operator">*</span> Front <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
                iterator<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> Front <span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_cxq<span class="token punctuation">,</span> Front<span class="token punctuation">)</span> <span class="token operator">==</span> Front<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">break</span> <span class="token punctuation">;</span>
                    <span class="token comment">// 原子性地将等待者添加到cxq的头部</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
         <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span>
     <span class="token comment">//策略3：将等待者添加到cxq的尾部</span>
     <span class="token keyword">if</span> <span class="token punctuation">(</span>Policy <span class="token operator">==</span> <span class="token number">3</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>      <span class="token comment">// append to cxq</span>
      
        iterator<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_CXQ <span class="token punctuation">;</span>
        <span class="token comment">// 将等待者状态设置为CXQ状态</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            ObjectWaiter <span class="token operator">*</span> Tail <span class="token punctuation">;</span>
            Tail <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>Tail <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                iterator<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>iterator<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_cxq<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                   <span class="token keyword">break</span> <span class="token punctuation">;</span>
                   <span class="token comment">// 如果cxq为空，则原子性地将等待者设为cxq</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>Tail<span class="token operator">-&gt;</span>_next <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> Tail <span class="token operator">=</span> Tail<span class="token operator">-&gt;</span>_next <span class="token punctuation">;</span>
                <span class="token comment">// 查找cxq的尾部</span>
                Tail<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> iterator <span class="token punctuation">;</span>
                iterator<span class="token operator">-&gt;</span>_prev <span class="token operator">=</span> Tail <span class="token punctuation">;</span>
                iterator<span class="token operator">-&gt;</span>_next <span class="token operator">=</span> <span class="token constant">NULL</span> <span class="token punctuation">;</span>
                <span class="token keyword">break</span> <span class="token punctuation">;</span>
                <span class="token comment">// 将等待者添加到cxq的尾部</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
     <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        ParkEvent <span class="token operator">*</span> ev <span class="token operator">=</span> iterator<span class="token operator">-&gt;</span>_event <span class="token punctuation">;</span>
        <span class="token comment">// 获取等待者的事件</span>
        iterator<span class="token operator">-&gt;</span>TState <span class="token operator">=</span> ObjectWaiter<span class="token operator">::</span>TS_RUN <span class="token punctuation">;</span>
        <span class="token comment">// 将等待者状态设置为运行状态</span>
        OrderAccess<span class="token operator">::</span><span class="token function">fence</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token comment">// 内存屏障</span>
        ev<span class="token operator">-&gt;</span><span class="token function">unpark</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
        <span class="token comment">// 直接唤醒等待者</span>
     <span class="token punctuation">}</span>

   
  <span class="token punctuation">}</span>
  <span class="token comment">// 释放WaitSet锁</span>
  Thread<span class="token operator">::</span><span class="token function">SpinRelease</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_WaitSetLock<span class="token punctuation">)</span> <span class="token punctuation">;</span>
  

  <span class="token comment">//......</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br><span class="line-number">17</span><br><span class="line-number">18</span><br><span class="line-number">19</span><br><span class="line-number">20</span><br><span class="line-number">21</span><br><span class="line-number">22</span><br><span class="line-number">23</span><br><span class="line-number">24</span><br><span class="line-number">25</span><br><span class="line-number">26</span><br><span class="line-number">27</span><br><span class="line-number">28</span><br><span class="line-number">29</span><br><span class="line-number">30</span><br><span class="line-number">31</span><br><span class="line-number">32</span><br><span class="line-number">33</span><br><span class="line-number">34</span><br><span class="line-number">35</span><br><span class="line-number">36</span><br><span class="line-number">37</span><br><span class="line-number">38</span><br><span class="line-number">39</span><br><span class="line-number">40</span><br><span class="line-number">41</span><br><span class="line-number">42</span><br><span class="line-number">43</span><br><span class="line-number">44</span><br><span class="line-number">45</span><br><span class="line-number">46</span><br><span class="line-number">47</span><br><span class="line-number">48</span><br><span class="line-number">49</span><br><span class="line-number">50</span><br><span class="line-number">51</span><br><span class="line-number">52</span><br><span class="line-number">53</span><br><span class="line-number">54</span><br><span class="line-number">55</span><br><span class="line-number">56</span><br><span class="line-number">57</span><br><span class="line-number">58</span><br><span class="line-number">59</span><br><span class="line-number">60</span><br><span class="line-number">61</span><br><span class="line-number">62</span><br><span class="line-number">63</span><br><span class="line-number">64</span><br><span class="line-number">65</span><br><span class="line-number">66</span><br><span class="line-number">67</span><br><span class="line-number">68</span><br><span class="line-number">69</span><br><span class="line-number">70</span><br><span class="line-number">71</span><br><span class="line-number">72</span><br><span class="line-number">73</span><br><span class="line-number">74</span><br><span class="line-number">75</span><br><span class="line-number">76</span><br><span class="line-number">77</span><br><span class="line-number">78</span><br><span class="line-number">79</span><br><span class="line-number">80</span><br><span class="line-number">81</span><br><span class="line-number">82</span><br><span class="line-number">83</span><br><span class="line-number">84</span><br><span class="line-number">85</span><br><span class="line-number">86</span><br><span class="line-number">87</span><br><span class="line-number">88</span><br><span class="line-number">89</span><br><span class="line-number">90</span><br><span class="line-number">91</span><br><span class="line-number">92</span><br><span class="line-number">93</span><br><span class="line-number">94</span><br><span class="line-number">95</span><br><span class="line-number">96</span><br><span class="line-number">97</span><br><span class="line-number">98</span><br><span class="line-number">99</span><br><span class="line-number">100</span><br><span class="line-number">101</span><br><span class="line-number">102</span><br><span class="line-number">103</span><br><span class="line-number">104</span><br><span class="line-number">105</span><br><span class="line-number">106</span><br><span class="line-number">107</span><br><span class="line-number">108</span><br><span class="line-number">109</span><br><span class="line-number">110</span><br><span class="line-number">111</span><br><span class="line-number">112</span><br><span class="line-number">113</span><br><span class="line-number">114</span><br><span class="line-number">115</span><br><span class="line-number">116</span><br><span class="line-number">117</span><br><span class="line-number">118</span><br><span class="line-number">119</span><br><span class="line-number">120</span><br><span class="line-number">121</span><br><span class="line-number">122</span><br><span class="line-number">123</span><br><span class="line-number">124</span><br><span class="line-number">125</span><br><span class="line-number">126</span><br><span class="line-number">127</span><br><span class="line-number">128</span><br><span class="line-number">129</span><br><span class="line-number">130</span><br><span class="line-number">131</span><br><span class="line-number">132</span><br><span class="line-number">133</span><br><span class="line-number">134</span><br><span class="line-number">135</span><br><span class="line-number">136</span><br></div></div><h2 id="关于synchronized更进一步的理解"><a href="#关于synchronized更进一步的理解" class="header-anchor">#</a> 关于synchronized更进一步的理解</h2> <h3 id="为什么锁释放之后还要进行一次cas上锁"><a href="#为什么锁释放之后还要进行一次cas上锁" class="header-anchor">#</a> 为什么锁释放之后还要进行一次cas上锁</h3> <p>上文提到执行exit方法时，线程通过release_store_ptr完成锁释放之后，会尝试cas再次尝试将锁的owner指向自己，这样做的目的是什么呢？</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token comment">//释放锁</span>
OrderAccess<span class="token operator">::</span><span class="token function">release_store_ptr</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_owner<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>   <span class="token comment">// drop the lock</span>
<span class="token comment">//......</span>
<span class="token comment">//cas上锁</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span>Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span>THREAD<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_owner<span class="token punctuation">,</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token constant">NULL</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token comment">//执行后续唤醒逻辑</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p>这本质上是针对cpu时间片的利用和调度效率上的一种优化，即当前线程完成锁释放后，尽可能利用当前线程还在使用时间片的时刻，尝试<code>cas</code>上锁，如果上锁成功则说明当前锁没有人获取，则执行后续唤醒等待线程的逻辑，由此尽可能利用<code>cpu</code>时间片避免搁浅问题(锁释放了所有线程还是处于<code>park</code>状态)：</p> <p><img src="https://qiniuyun.sharkchili.com/202511251013687.png" alt=""></p> <h3 id="自旋重试的性能压榨"><a href="#自旋重试的性能压榨" class="header-anchor">#</a> 自旋重试的性能压榨</h3> <p>竞争锁资源的<code>enter</code>方法在明确几次<code>cas</code>和自旋失败后，会将其添加到<code>cxq</code>队列中，但设计者并不会直接添加，而是尽可能利用每一次机会，利用我们将线程封装为等待节点会通过<code>cas</code>存入等待队列，为了尽可能利用每一次<code>cpu</code>时间片，再进行<code>cas</code>自旋入队时，设计者会利用每次<code>cas</code>失败的时机再次尝试自旋上锁，这本质就是对于入队激烈竞争的一种临时规避，尽可能利用这个间隙再次获取锁资源：</p> <p><img src="https://qiniuyun.sharkchili.com/202511251013880.png" alt=""></p> <p>对应笔者也贴出这段核心代码段：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token punctuation">;</span><span class="token punctuation">;</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">//当前节点指向cxq队列的首元素</span>
        node<span class="token punctuation">.</span>_next <span class="token operator">=</span> nxt <span class="token operator">=</span> _cxq <span class="token punctuation">;</span>
        <span class="token comment">//通过cas将当前元素设置为cxq队列的首元素，若成功则退出循环</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>Atomic<span class="token operator">::</span><span class="token function">cmpxchg_ptr</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">,</span> <span class="token operator">&amp;</span>_cxq<span class="token punctuation">,</span> nxt<span class="token punctuation">)</span> <span class="token operator">==</span> nxt<span class="token punctuation">)</span> <span class="token keyword">break</span> <span class="token punctuation">;</span>

        <span class="token comment">// Interference - the CAS failed because _cxq changed.  Just retry.</span>
        <span class="token comment">// As an optional optimization we retry the lock.</span>
        <span class="token comment">//若cas失败则再次尝试自旋上锁，尽可能利用cpu执行开销</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">TryLock</span> <span class="token punctuation">(</span>Self<span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">assert</span> <span class="token punctuation">(</span>_succ <span class="token operator">!=</span> Self         <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
            <span class="token function">assert</span> <span class="token punctuation">(</span>_owner <span class="token operator">==</span> Self        <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
            <span class="token function">assert</span> <span class="token punctuation">(</span>_Responsible <span class="token operator">!=</span> Self  <span class="token punctuation">,</span> <span class="token string">&quot;invariant&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br><span class="line-number">16</span><br></div></div><h3 id="不同唤醒策略的设计理念"><a href="#不同唤醒策略的设计理念" class="header-anchor">#</a> 不同唤醒策略的设计理念</h3> <p>锁释放时，源码中对于线程的唤醒策略给出了大体5种策略，实际上这也是对系统资源规律的把握和不同场景效率的优化，对应的笔者结合之前整理的几种策略进行说明：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code><span class="token number">1.</span> QMode为<span class="token number">2</span>直接唤醒cxq队列首元素线程，让其竞争监视锁，这种方式避免cxq转移到EntryList的开销，直接让cxq队列元素唤醒，适用于追求高并发和极致的场景，不需要考虑公平性
<span class="token number">2.</span> QMode为<span class="token number">3</span>，则查看cxq队列是否非空，若明确非空则将其追加到EntryList尾部，若EntryList为空则直接将cxq队列设置为EntryList，然后将首元素唤醒，因为线程竞争不到锁资源之后是采用头插法存入cxq队列，所以为了避免cxq反序追加到EntryList这个开销，该策略是直接将cxq队列追加到EntryList上，这本质上就是一种公平性和性能的折中
<span class="token number">3.</span> QMode为<span class="token number">4</span>，则将EntryList追加到cxq队列后，然后让cxq队列作为EntryList首元素，将首个线程唤醒竞争监视锁，这种方案是考虑到最新的线程会位于cxq队列队首，所以cpu缓存中可能存有这个线程的缓存数据，因此优先唤醒该线程保证高效完成计算
<span class="token comment">/************************* 执行到步骤4和5，说明代码中的逻辑判断明确EntryList为空，对应不同的QMode规则为**************/</span>
<span class="token number">4.</span> QMode为<span class="token number">1</span>，将cxq队列倒序排列后作为EntryList，并将首元素唤醒，这种就是将头插法的cxq队列顺序排列追加到EntryList，严格保证调度的公平性，避免线程饥饿
<span class="token number">5.</span> QMode为<span class="token number">0</span>（默认策略），将cxq直接封装为ObjectWaiter作为EntryList，绕过两个列表关联直接将首元素唤醒，适用于高并发和高性能的场景
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><h3 id="为什么wait获取锁采用自旋而非重量级锁"><a href="#为什么wait获取锁采用自旋而非重量级锁" class="header-anchor">#</a> 为什么wait获取锁采用自旋而非重量级锁</h3> <p>_WaitSetLock保护的等待队列本质上基本只有监视器所有者进行访问，个别情况由于超时中断返回操作队列的情况，所以竞争不算激烈，所以在操作等待队列时上锁的方式是采用自旋而非重量级锁：</p> <div class="language-c line-numbers-mode"><pre class="language-c"><code>   Thread<span class="token operator">::</span><span class="token function">SpinAcquire</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_WaitSetLock<span class="token punctuation">,</span> <span class="token string">&quot;WaitSet - add&quot;</span><span class="token punctuation">)</span> <span class="token punctuation">;</span>
   <span class="token function">AddWaiter</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>node<span class="token punctuation">)</span> <span class="token punctuation">;</span>
   Thread<span class="token operator">::</span><span class="token function">SpinRelease</span> <span class="token punctuation">(</span><span class="token operator">&amp;</span>_WaitSetLock<span class="token punctuation">)</span> <span class="token punctuation">;</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><h2 id="小结"><a href="#小结" class="header-anchor">#</a> 小结</h2> <p>本文针对synchronized关键字上锁、释放锁、等待通知等操作的底层机制和优化理念进行了深入分析和讲解，希望对你有所启发。</p> <p>我是 <strong>sharkchili</strong> ，<strong>CSDN Java 领域博客专家</strong>，<strong>mini-redis</strong>的作者，我想写一些有意思的东西，希望对你有帮助，如果你想实时收到我写的硬核的文章也欢迎你关注我的公众号： <strong>写代码的SharkChili</strong> 。</p> <p>同时也非常欢迎你star我的开源项目mini-redis:https://github.com/shark-ctrl/mini-redis</p> <p>因为近期收到很多读者的私信，所以也专门创建了一个交流群，感兴趣的读者可以通过上方的公众号获取笔者的联系方式完成好友添加，点击备注  <strong>“加群”</strong> 即可和笔者和笔者的朋友们进行深入交流。</p> <h2 id="参考"><a href="#参考" class="header-anchor">#</a> 参考</h2> <p>内置锁(ObjectMonitor):<a href="https://www.cnblogs.com/hongdada/p/14513036.html" target="_blank" rel="noopener noreferrer">https://www.cnblogs.com/hongdada/p/14513036.html<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Java面试常见问题：Monitor对象是什么？:<a href="https://zhuanlan.zhihu.com/p/356010805" target="_blank" rel="noopener noreferrer">https://zhuanlan.zhihu.com/p/356010805<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Java并发基石——所谓&quot;阻塞&quot;：Object Monitor和AQS（1）:<a href="https://blog.csdn.net/yinwenjie/article/details/84922958" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/yinwenjie/article/details/84922958<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Java多线程：objectMonitor源码解读（3）:<a href="https://juejin.cn/post/7255230505409527863" target="_blank" rel="noopener noreferrer">https://juejin.cn/post/7255230505409527863<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>ObjectMonitor:<a href="https://www.jianshu.com/p/c0854b241c2d" target="_blank" rel="noopener noreferrer">https://www.jianshu.com/p/c0854b241c2d<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p> <p>Java Synchronized 重量级锁原理深入剖析上(互斥篇)
:<a href="https://blog.csdn.net/wekajava/article/details/120306478" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/wekajava/article/details/120306478<span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></p></div></div> <div class="page-slot page-slot-bottom"><!-- 横向自适应 -->
         <ins class="adsbygoogle"
             style="display:block"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="1126101170"
             data-ad-format="auto"
             data-full-width-responsive="true"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script></div> <div class="page-edit"><div class="edit-link"><a href="https://github.com/sharkchili/vuepress-theme-vdoing/edit/master/docs/01.Java核心技术/40.并发编程/04.深入源码解析synchronized关键字.md" target="_blank" rel="noopener noreferrer">编辑</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">2025/11/29, 15:32:48</span></div></div> <div class="page-nav-wapper"><div class="page-nav-centre-wrap"><a href="/pages/bb708f/" class="page-nav-centre page-nav-centre-prev"><div class="tooltip">浅谈Java线程池中拒绝策略与流控的艺术</div></a> <a href="/pages/a62174/" class="page-nav-centre page-nav-centre-next"><div class="tooltip">浅谈Java并发编程中断的哲学</div></a></div> <div class="page-nav"><p class="inner"><span class="prev">
        ←
        <a href="/pages/bb708f/" class="prev">浅谈Java线程池中拒绝策略与流控的艺术</a></span> <span class="next"><a href="/pages/a62174/">浅谈Java并发编程中断的哲学</a>→
      </span></p></div></div></div> <div class="article-list"><div class="article-title"><a href="/archives/" class="iconfont icon-bi">最近更新</a></div> <div class="article-wrapper"><dl><dd>01</dd> <dt><a href="/pages/5b74d3/"><div>
            告别AI无效对话：资深工程师的提示词设计最佳实践
            <!----></div></a> <span class="date">02-07</span></dt></dl><dl><dd>02</dd> <dt><a href="/pages/745def/"><div>
            基于Vibe Coding的Redis分页查询实现
            <!----></div></a> <span class="date">01-29</span></dt></dl><dl><dd>03</dd> <dt><a href="/pages/609690/"><div>
            IDEA配置详解与高效使用指南
            <!----></div></a> <span class="date">01-27</span></dt></dl> <dl><dd></dd> <dt><a href="/archives/" class="more">更多文章&gt;</a></dt></dl></div></div></main></div> <div class="footer"><div class="icons"><a href="mailto:894072666@qq.com" title="发邮件" target="_blank" class="iconfont icon-youjian"></a><a href="https://github.com/shkctl" title="GitHub" target="_blank" class="iconfont icon-github"></a><a href="https://music.163.com/#/playlist?id=755597173" title="听音乐" target="_blank" class="iconfont icon-erji"></a></div> 
  Theme by
  <a href="https://github.com/xugaoyi/vuepress-theme-vdoing" target="_blank" title="本站主题">Vdoing</a> 
    | Copyright © 2025-2026
    <span>Evan Xu | <a href="https://github.com/shkctl/vuepress-theme-vdoing/blob/master/LICENSE" target="_blank">MIT License</a> | <a href="http://beian.miit.gov.cn/" target="_blank">桂ICP备2024034950号</a> | <img src="/img/beian.png" style="width: 15px; margin-bottom: -3px;" /> <a href="https://beian.mps.gov.cn/#/query/webSearch?code=45142202000030" rel="noreferrer" target="_blank">桂公网安备45142202000030</a></span></div> <div class="buttons"><div title="返回顶部" class="button blur go-to-top iconfont icon-fanhuidingbu" style="display:none;"></div> <div title="去评论" class="button blur go-to-comment iconfont icon-pinglun" style="display:none;"></div> <div title="主题模式" class="button blur theme-mode-but iconfont icon-zhuti"><ul class="select-box" style="display:none;"><li class="iconfont icon-zidong">
          跟随系统
        </li><li class="iconfont icon-rijianmoshi">
          浅色模式
        </li><li class="iconfont icon-yejianmoshi">
          深色模式
        </li><li class="iconfont icon-yuedu">
          阅读模式
        </li></ul></div></div> <!----> <div class="custom-html-window custom-html-window-lb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定200*200px -->
         <script async src="https:pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
         <ins class="adsbygoogle"
             style="display:inline-block;width:200px;height:200px"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="8486534683"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script></div></div></div> <div class="custom-html-window custom-html-window-rb" style="display:;"><div class="custom-wrapper"><span class="close-but">×</span> <div><!-- 固定160*160px -->
         <ins class="adsbygoogle"
             style="display:inline-block;max-width:160px;max-height:160px"
             data-ad-client="ca-pub-6948347885301434"
             data-ad-slot="8350803313"></ins>
         <script>
             (adsbygoogle = window.adsbygoogle || []).push({});
         </script>
         </div></div></div></div><div class="global-ui"><div></div></div></div>
    <script src="/assets/js/app.e893bc68.js" defer></script><script src="/assets/js/2.0f2864c1.js" defer></script><script src="/assets/js/26.e02e9bae.js" defer></script>
  </body>
</html>
