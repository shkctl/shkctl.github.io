(window.webpackJsonp=window.webpackJsonp||[]).push([[47],{401:function(s,a,t){"use strict";t.r(a);var n=t(8),e=Object(n.a)({},(function(){var s=this,a=s._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h2",{attrs:{id:"引言"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#引言"}},[s._v("#")]),s._v(" 引言")]),s._v(" "),a("p",[s._v("在诸如"),a("code",[s._v("grafana")]),s._v("、"),a("code",[s._v("Nightingale")]),s._v("等监控工具盛行的今天，软件开发工程师仍然需要具备面向操作系统维度的性能指标以及终端排查的思想沉淀，确保在日常工程开发和极端环境下都具备足够力道的系统调优能力。而本文将从一个经典的并发IO读写性能引发的用户应用延迟升高的故障深入演示一下传统性能瓶颈分析和排查的手段，希望对你有所启发。")]),s._v(" "),a("p",[s._v("我是 "),a("strong",[s._v("SharkChili")]),s._v(" ，Java 开发者，"),a("strong",[s._v("Java Guide")]),s._v(" 开源项目维护者。欢迎关注我的公众号："),a("strong",[s._v("写代码的SharkChili")]),s._v("，也欢迎您了解我的开源项目 mini-redis："),a("a",{attrs:{href:"https://github.com/shark-ctrl/mini-redis",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/shark-ctrl/mini-redis"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("p",[s._v("为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注"),a("strong",[s._v("加群")]),s._v("即可加入。")]),s._v(" "),a("p",[s._v("我是 "),a("code",[s._v("SharkChili")]),s._v(" ，"),a("code",[s._v("Java")]),s._v(" 开发者，"),a("code",[s._v("Java Guide 开源项目维护者")]),s._v("。欢迎关注我的公众号：写代码的SharkChili，也欢迎您了解我的开源项目 mini-redis：https://github.com/shark-ctrl/mini-redis。")]),s._v(" "),a("p",[s._v("为方便与读者交流，现已创建读者群。关注上方公众号获取我的联系方式，添加时备注加群即可加入。")]),s._v(" "),a("h2",{attrs:{id:"背景说明"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#背景说明"}},[s._v("#")]),s._v(" 背景说明")]),s._v(" "),a("p",[s._v("为了更好地复现本次故障，笔者也用"),a("code",[s._v("Java")]),s._v("写了一个多线程执行文件数据读写的程序，对应入口核心代码段如下：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * 启动磁盘I/O操作以模拟高I/O负载\n * 通过创建多个I/O任务线程来模拟高磁盘I/O负载\n */")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("startDiskIOOperations")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"开始高I/O磁盘操作..."')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v("\"在另一个终端中运行 'iostat -x 1' 来监控磁盘利用率。\"")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 创建固定线程数的线程池")]),s._v("\n    executor "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Executors")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("newFixedThreadPool")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NUM_THREADS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 提交多个任务以连续写入磁盘")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("for")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NUM_THREADS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" i"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("++")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        executor"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("submit")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOTask")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("i"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"磁盘I/O操作已启动，使用 {} 个线程"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NUM_THREADS")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br")])]),a("p",[s._v("与之对应IOTask的逻辑也非常简单频繁大批量读写文件，完成后再清空，模拟并发场景下频繁的大文件读写操作：")]),s._v(" "),a("div",{staticClass:"language-java line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-java"}},[a("code",[a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * 执行连续写入操作以模拟高I/O的任务\n * 该类负责执行磁盘I/O操作，通过不断写入和清空文件来模拟高I/O负载\n */")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("class")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOTask")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("implements")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Runnable")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("final")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" taskId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOTask")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" taskId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("this")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("taskId "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" taskId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token annotation punctuation"}},[s._v("@Override")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("run")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 每个线程写入自己的临时文件")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),s._v(" filename "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"/tmp/disk_io_test_"')]),s._v(" "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" taskId "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('".tmp"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n        "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("try")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FileOutputStream")]),s._v(" fos "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("new")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FileOutputStream")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"线程-{} 正在写入 {}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" taskId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" filename"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n            "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 连续将数据写入文件并在每次写入后清空文件")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("Thread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentThread")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("isInterrupted")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("performDiskIOOperation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("fos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" taskId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ThreadUtil")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sleep")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("500")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("catch")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")]),s._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("error")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"线程-{} 发生错误: {}"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" taskId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" e"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getMessage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n"),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/**\n * 执行磁盘I/O操作：写入指定大小的数据然后清空文件\n * 该方法会连续写入数据到文件，然后清空文件内容，用于模拟高I/O负载\n * @param fos 文件输出流\n * @param taskId 任务ID\n * @throws IOException IO异常\n */")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("private")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("performDiskIOOperation")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("FileOutputStream")]),s._v(" fos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" taskId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("throws")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("IOException")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" startTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentTimeMillis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 写入数据（分块写入）")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" bytesWritten "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("while")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("bytesWritten "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("WRITE_SIZE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        fos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("write")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DATA")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        bytesWritten "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token constant"}},[s._v("DATA")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("length"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    fos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("flush")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 强制写入磁盘")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 清空文件内容")]),s._v("\n    fos"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("getChannel")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("truncate")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),a("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),s._v(" endTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("System")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("currentTimeMillis")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n    "),a("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 打印本次操作的耗时")]),s._v("\n    log"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("info")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),a("span",{pre:!0,attrs:{class:"token string"}},[s._v('"线程-{} 完成一次写入和清空操作，耗时: {} ms"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" taskId"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("endTime "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v(" startTime"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br"),a("span",{staticClass:"line-number"},[s._v("12")]),a("br"),a("span",{staticClass:"line-number"},[s._v("13")]),a("br"),a("span",{staticClass:"line-number"},[s._v("14")]),a("br"),a("span",{staticClass:"line-number"},[s._v("15")]),a("br"),a("span",{staticClass:"line-number"},[s._v("16")]),a("br"),a("span",{staticClass:"line-number"},[s._v("17")]),a("br"),a("span",{staticClass:"line-number"},[s._v("18")]),a("br"),a("span",{staticClass:"line-number"},[s._v("19")]),a("br"),a("span",{staticClass:"line-number"},[s._v("20")]),a("br"),a("span",{staticClass:"line-number"},[s._v("21")]),a("br"),a("span",{staticClass:"line-number"},[s._v("22")]),a("br"),a("span",{staticClass:"line-number"},[s._v("23")]),a("br"),a("span",{staticClass:"line-number"},[s._v("24")]),a("br"),a("span",{staticClass:"line-number"},[s._v("25")]),a("br"),a("span",{staticClass:"line-number"},[s._v("26")]),a("br"),a("span",{staticClass:"line-number"},[s._v("27")]),a("br"),a("span",{staticClass:"line-number"},[s._v("28")]),a("br"),a("span",{staticClass:"line-number"},[s._v("29")]),a("br"),a("span",{staticClass:"line-number"},[s._v("30")]),a("br"),a("span",{staticClass:"line-number"},[s._v("31")]),a("br"),a("span",{staticClass:"line-number"},[s._v("32")]),a("br"),a("span",{staticClass:"line-number"},[s._v("33")]),a("br"),a("span",{staticClass:"line-number"},[s._v("34")]),a("br"),a("span",{staticClass:"line-number"},[s._v("35")]),a("br"),a("span",{staticClass:"line-number"},[s._v("36")]),a("br"),a("span",{staticClass:"line-number"},[s._v("37")]),a("br"),a("span",{staticClass:"line-number"},[s._v("38")]),a("br"),a("span",{staticClass:"line-number"},[s._v("39")]),a("br"),a("span",{staticClass:"line-number"},[s._v("40")]),a("br"),a("span",{staticClass:"line-number"},[s._v("41")]),a("br"),a("span",{staticClass:"line-number"},[s._v("42")]),a("br"),a("span",{staticClass:"line-number"},[s._v("43")]),a("br"),a("span",{staticClass:"line-number"},[s._v("44")]),a("br"),a("span",{staticClass:"line-number"},[s._v("45")]),a("br"),a("span",{staticClass:"line-number"},[s._v("46")]),a("br"),a("span",{staticClass:"line-number"},[s._v("47")]),a("br"),a("span",{staticClass:"line-number"},[s._v("48")]),a("br"),a("span",{staticClass:"line-number"},[s._v("49")]),a("br"),a("span",{staticClass:"line-number"},[s._v("50")]),a("br"),a("span",{staticClass:"line-number"},[s._v("51")]),a("br"),a("span",{staticClass:"line-number"},[s._v("52")]),a("br"),a("span",{staticClass:"line-number"},[s._v("53")]),a("br"),a("span",{staticClass:"line-number"},[s._v("54")]),a("br"),a("span",{staticClass:"line-number"},[s._v("55")]),a("br")])]),a("h2",{attrs:{id:"详解linux系统io性能问题排查通用步骤"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#详解linux系统io性能问题排查通用步骤"}},[s._v("#")]),s._v(" 详解Linux系统IO性能问题排查通用步骤")]),s._v(" "),a("h3",{attrs:{id:"检查服务器负载"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#检查服务器负载"}},[s._v("#")]),s._v(" 检查服务器负载")]),s._v(" "),a("p",[s._v("当我们认为存在IO瓶颈时，首先要做的就是基于top指令查看当前服务器wa即CPU等待IO任务完成的占比，一般情况下"),a("code",[s._v("20%")]),s._v("以下算是一个比较合理的正常阈值，超过"),a("code",[s._v("30%-40%")]),s._v("则表明系统可能存在严重的IO瓶颈。以笔者的服务器为例，可以看到wa的值远大于正常范围，说明当前CPU基本处于等待IO任务完成的情况：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Tasks:  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),s._v(" total,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" running,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("33")]),s._v(" sleeping,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" stopped,   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" zombie\n%Cpu0  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.5")]),s._v(" us,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.6")]),s._v(" sy,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" ni,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("5.3")]),s._v(" id, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("90.5")]),s._v(" wa,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" hi,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),s._v(" si,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" st \n%Cpu1  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" us,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.2")]),s._v(" sy,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" ni, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("24.9")]),s._v(" id, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("72.4")]),s._v(" wa,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" hi,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.5")]),s._v(" si,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" st \n%Cpu2  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.1")]),s._v(" us,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.6")]),s._v(" sy,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" ni,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.6")]),s._v(" id, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("97.7")]),s._v(" wa,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" hi,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" si,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" st \n%Cpu3  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.5")]),s._v(" us,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("2.7")]),s._v(" sy,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" ni, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.8")]),s._v(" id, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("80.0")]),s._v(" wa,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" hi,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" si,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" st \n%Cpu4  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.6")]),s._v(" us,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.7")]),s._v(" sy,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" ni,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" id, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("97.8")]),s._v(" wa,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" hi,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" si,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" st \n%Cpu5  "),a("span",{pre:!0,attrs:{class:"token builtin class-name"}},[s._v(":")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" us,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3.9")]),s._v(" sy,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" ni, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18.8")]),s._v(" id, "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("77.3")]),s._v(" wa,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" hi,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" si,  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v(" st\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br")])]),a("h3",{attrs:{id:"查看io使用率"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#查看io使用率"}},[s._v("#")]),s._v(" 查看IO使用率")]),s._v(" "),a("p",[s._v("明确系统存在IO性能瓶颈的情况下，我们就需要更进一步定位问题，以笔者为例，一般会执行iostat指令，如下所示，大意为：")]),s._v(" "),a("ol",[a("li",[s._v("-x：显示更多扩展信息（包括设备利用率、等待时间等）")]),s._v(" "),a("li",[s._v("每1秒输出1次，持续输出")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("iostat "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-x")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("输出结果如下，对应的比这也针对这些指标的阈值进行一些简单的说明：")]),s._v(" "),a("p",[s._v("关键指标解读：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("%util")]),s._v("：设备利用率，接近100%表示设备繁忙，可能存在IO瓶颈")]),s._v(" "),a("li",[a("code",[s._v("r_await")]),s._v(" 和 "),a("code",[s._v("w_await")]),s._v("：平均读写请求等待时间，数值越高说明IO响应越慢")]),s._v(" "),a("li",[a("code",[s._v("aqu-sz")]),s._v("：平均请求队列大小，数值较大说明IO请求堆积严重")]),s._v(" "),a("li",[a("code",[s._v("await")]),s._v("：平均服务时间（读写等待时间之和）")])]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("avg-cpu:  %user   %nice %system %iowait  %steal   %idle\n           "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("%    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("%    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.0")]),s._v("%   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("78.2")]),s._v("%    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.0")]),s._v("%   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("20.8")]),s._v("%\n\nDevice            r/s     rMB/s   rrqm/s  %rrqm r_await rareq-sz    w/s     wMB/s   wrqm/s  %wrqm w_await wareq-sz    d/s     dMB/s   drqm/s  %drqm d_await dareq-sz  f_await  aqu-sz  %util\nsda            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("\nsdb            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("\nsdc            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("\nsdd            "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("4.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.04")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("122.25")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("10.24")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("171.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("190.81")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.58")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3884.17")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1.12")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v("  "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("664.68")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("100.00")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br")])]),a("p",[s._v("结合我们实际监控到的指标来看，对应sdd盘使用率"),a("code",[s._v("%util（IO利用率）")]),s._v("飙到"),a("code",[s._v("100%")]),s._v("且"),a("code",[s._v("iowait")]),s._v("达到了"),a("code",[s._v("78.2%")]),s._v("，很明显这块磁盘存在一些异常IO读写任务：")]),s._v(" "),a("h3",{attrs:{id:"明确定位io进程"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#明确定位io进程"}},[s._v("#")]),s._v(" 明确定位IO进程")]),s._v(" "),a("p",[s._v("基于上述过程我们已经明确sdd盘存在IO异常，此时我们就可以通过iotop来查看具体进程了，需要补充的是iotop默认是没有安装的，读者可以参考网上教程自行安装，以笔者的Ubuntu系统为例，对应的安装指令为：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[a("span",{pre:!0,attrs:{class:"token function"}},[s._v("sudo")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("apt")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v(" iotop\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br")])]),a("p",[s._v("最后键入"),a("code",[s._v("sudo iotop -o")]),s._v("查看正在执行IO操作的进程，对应输出结果如下，对应字段含义分别是：")]),s._v(" "),a("ul",[a("li",[a("code",[s._v("Total DISK READ")]),s._v(": 总磁盘读")]),s._v(" "),a("li",[a("code",[s._v("Total DISK WRITE")]),s._v(": 总磁盘写")]),s._v(" "),a("li",[a("code",[s._v("Current DISK READ")]),s._v(":  瞬时磁盘读")]),s._v(" "),a("li",[a("code",[s._v("Current DISK WRITE")]),s._v(":  瞬时磁盘写")]),s._v(" "),a("li",[a("code",[s._v("TID")]),s._v("：线程号")]),s._v(" "),a("li",[a("code",[s._v("PRIO")]),s._v("：io进程优先级")]),s._v(" "),a("li",[a("code",[s._v("USER")]),s._v("：进程所属用户")]),s._v(" "),a("li",[a("code",[s._v("DISK READ")]),s._v(" ：该线程读取速率")]),s._v(" "),a("li",[a("code",[s._v("DISK WRITE")]),s._v("：该线程写入速率")]),s._v(" "),a("li",[a("code",[s._v("COMMAND")]),s._v("：执行线程的命令(对应java进程启动指令)")])]),s._v(" "),a("p",[s._v("此时就可以非常明确地看到笔者Java进程对应执行异常IO操作的线程和读写速率了，可以看到笔者的大量进程都存在写入操作，占用大量磁盘写入带宽：")]),s._v(" "),a("div",{staticClass:"language-bash line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[s._v("Total DISK READ:         "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" B/s "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Total DISK WRITE:       "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("142.99")]),s._v(" M/s\nCurrent DISK READ:      "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("11.92")]),s._v(" K/s "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("|")]),s._v(" Current DISK WRITE:     "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("336.21")]),s._v(" M/s\n    TID  PRIO  "),a("span",{pre:!0,attrs:{class:"token environment constant"}},[s._v("USER")]),s._v("     DISK READ DISK WRITE"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("    COMMAND                                                                                              \n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3253712")]),s._v(" be/4 sharkchi    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" B/s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18.26")]),s._v(" M/s "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-jar")]),s._v(" web-cache-1.0.jar "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--app.startup.method")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pool-2-thread-3"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3253713")]),s._v(" be/4 sharkchi    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" B/s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18.26")]),s._v(" M/s "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-jar")]),s._v(" web-cache-1.0.jar "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--app.startup.method")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pool-2-thread-4"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3253711")]),s._v(" be/4 sharkchi    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" B/s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18.25")]),s._v(" M/s "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-jar")]),s._v(" web-cache-1.0.jar "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--app.startup.method")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pool-2-thread-2"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3253715")]),s._v(" be/4 sharkchi    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" B/s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18.25")]),s._v(" M/s "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-jar")]),s._v(" web-cache-1.0.jar "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--app.startup.method")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pool-2-thread-6"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3253714")]),s._v(" be/4 sharkchi    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" B/s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("18.24")]),s._v(" M/s "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-jar")]),s._v(" web-cache-1.0.jar "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--app.startup.method")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pool-2-thread-5"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3253710")]),s._v(" be/4 sharkchi    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" B/s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17.50")]),s._v(" M/s "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-jar")]),s._v(" web-cache-1.0.jar "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--app.startup.method")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pool-2-thread-1"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3253717")]),s._v(" be/4 sharkchi    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" B/s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("17.50")]),s._v(" M/s "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-jar")]),s._v(" web-cache-1.0.jar "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--app.startup.method")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pool-2-thread-8"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n"),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("3253716")]),s._v(" be/4 sharkchi    "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0.00")]),s._v(" B/s   "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("16.74")]),s._v(" M/s "),a("span",{pre:!0,attrs:{class:"token function"}},[s._v("java")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("-jar")]),s._v(" web-cache-1.0.jar "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[s._v("--app.startup.method")]),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("pool-2-thread-7"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\n")])]),s._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[s._v("1")]),a("br"),a("span",{staticClass:"line-number"},[s._v("2")]),a("br"),a("span",{staticClass:"line-number"},[s._v("3")]),a("br"),a("span",{staticClass:"line-number"},[s._v("4")]),a("br"),a("span",{staticClass:"line-number"},[s._v("5")]),a("br"),a("span",{staticClass:"line-number"},[s._v("6")]),a("br"),a("span",{staticClass:"line-number"},[s._v("7")]),a("br"),a("span",{staticClass:"line-number"},[s._v("8")]),a("br"),a("span",{staticClass:"line-number"},[s._v("9")]),a("br"),a("span",{staticClass:"line-number"},[s._v("10")]),a("br"),a("span",{staticClass:"line-number"},[s._v("11")]),a("br")])]),a("h2",{attrs:{id:"小结"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),a("p",[s._v("我们来简单小结一下IO性能瓶颈的排查套路：")]),s._v(" "),a("ol",[a("li",[s._v("通过"),a("code",[s._v("top")]),s._v("命令查看"),a("code",[s._v("%wa")]),s._v("（iowait）指标，判断CPU是否存在异常等待IO的情况")]),s._v(" "),a("li",[s._v("使用"),a("code",[s._v("iostat -x 1")]),s._v("查看IO使用率和响应时间等详细指标，定位具体磁盘设备")]),s._v(" "),a("li",[s._v("使用"),a("code",[s._v("iotop")]),s._v("显示正在执行IO任务的进程和线程，明确问题程序")])]),s._v(" "),a("p",[s._v("简而言之无论是面向shell终端的性能排查还是基于时序库采集到的监控图表，我们从性能优化方法论的角度出发，整体步骤也都是严格遵循：")]),s._v(" "),a("ol",[a("li",[s._v("结合问题表象推测故障性质，是CPU活跃性问题还是IO性质的瓶颈")]),s._v(" "),a("li",[s._v("结合推断查看指定指标，例如CPU利用率或者网络带宽、磁盘利用率、io等待时长等")]),s._v(" "),a("li",[s._v("明确问题根因后，定位目标进程")]),s._v(" "),a("li",[s._v("结合程序类型采用相应故障诊断工具定位问题代码段")])]),s._v(" "),a("p",[s._v("当然，对于有足够经验的工程师而言，可能大部分都会在top指令完成后，明确存在io性能瓶颈且当前服务器是java进程专用后，就会直接通过iotop定位问题了，而这就是所谓的经验。")]),s._v(" "),a("p",[s._v("我是 "),a("strong",[s._v("SharkChili")]),s._v(" ，Java 开发者，"),a("strong",[s._v("Java Guide")]),s._v(" 开源项目维护者。欢迎关注我的公众号："),a("strong",[s._v("写代码的SharkChili")]),s._v("，也欢迎您了解我的开源项目 mini-redis："),a("a",{attrs:{href:"https://github.com/shark-ctrl/mini-redis",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/shark-ctrl/mini-redis"),a("OutboundLink")],1),s._v("。")]),s._v(" "),a("p",[s._v("为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注"),a("strong",[s._v("加群")]),s._v("即可加入。")]),s._v(" "),a("p",[s._v("我是 SharkChili ，Java 开发者，Java Guide 开源项目维护者。欢迎关注我的公众号：写代码的SharkChili，也欢迎您了解我的开源项目 mini-redis：https://github.com/shark-ctrl/mini-redis。")]),s._v(" "),a("p",[s._v("为方便与读者交流，现已创建读者群。关注上方公众号获取我的联系方式，添加时备注加群即可加入。")]),s._v(" "),a("h2",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),a("p",[s._v("【双语视界】Linux上IO性能问题的故障排除:"),a("a",{attrs:{href:"https://www.bilibili.com/video/BV14d35zhEjs/?from_spmid=united.player-video-detail.drama-float.0&plat_id=411&share_from=season&share_medium=iphone&share_plat=ios&share_session_id=2A52FF3A-393E-4D48-98A0-712F961E6C3A&share_source=WEIXIN&share_tag=s_i&spmid=united.player-video-detail.0.0&timestamp=1758040810&unique_k=gAzBCJY&vd_source=bf04f9a485aa892c0242fbfdfca25589",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.bilibili.com/video/BV14d35zhEjs/?from_spmid=united.player-video-detail.drama-float.0&plat_id=411&share_from=season&share_medium=iphone&share_plat=ios&share_session_id=2A52FF3A-393E-4D48-98A0-712F961E6C3A&share_source=WEIXIN&share_tag=s_i&spmid=united.player-video-detail.0.0&timestamp=1758040810&unique_k=gAzBCJY&vd_source=bf04f9a485aa892c0242fbfdfca25589"),a("OutboundLink")],1)])])}),[],!1,null,null,null);a.default=e.exports}}]);