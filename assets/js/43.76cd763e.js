(window.webpackJsonp=window.webpackJsonp||[]).push([[43],{402:function(s,t,a){"use strict";a.r(t);var n=a(8),e=Object(n.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h2",{attrs:{id:"引言"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#引言"}},[s._v("#")]),s._v(" 引言")]),s._v(" "),t("p",[s._v("任何编程语言日常都会遇到各种各样的异常，而本文将从操作系统的角度来聊聊操作系统是如何处理进程中断和异常的。")]),s._v(" "),t("p",[s._v("我是 "),t("strong",[s._v("SharkChili")]),s._v(" ，Java 开发者，"),t("strong",[s._v("Java Guide")]),s._v(" 开源项目维护者。欢迎关注我的公众号："),t("strong",[s._v("写代码的SharkChili")]),s._v("，也欢迎您了解我的开源项目 mini-redis："),t("a",{attrs:{href:"https://github.com/shark-ctrl/mini-redis",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/shark-ctrl/mini-redis"),t("OutboundLink")],1),s._v("。")]),s._v(" "),t("p",[s._v("为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注"),t("strong",[s._v("加群")]),s._v("即可加入。")]),s._v(" "),t("h2",{attrs:{id:"详解异常与中断过程"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#详解异常与中断过程"}},[s._v("#")]),s._v(" 详解异常与中断过程")]),s._v(" "),t("h3",{attrs:{id:"从一个算数运算错误开始"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#从一个算数运算错误开始"}},[s._v("#")]),s._v(" 从一个算数运算错误开始")]),s._v(" "),t("p",[s._v("假设我们现在有一个"),t("code",[s._v("java")]),s._v("程序，对应的除数是0：")]),s._v(" "),t("div",{staticClass:"language-java line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-java"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("public")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("String")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v(" args"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" num "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("执行后就会抛出如下提示：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[s._v("Exception "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("in")]),s._v(" thread "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v('"main"')]),s._v(" java.lang.ArithmeticException: / by zero\n\tat com.sharkchili.Main.main"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("Main.java:23"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br")])]),t("p",[s._v("而同理"),t("code",[s._v("go语言")]),s._v("执行类似的算数异常也会抛出类似的错误：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("main")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\tnum "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("/")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//./main.go:6:13: invalid operation: division by zero")]),s._v("\n\tfmt"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Println")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("num"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br")])]),t("p",[s._v("那么问题来了，操作系统是如何处理不同编程语言中相同的异常呢？")]),s._v(" "),t("p",[s._v("答案是中断描述符表即"),t("code",[s._v("Interrupt Descriptor Table")]),s._v("(以下简称IDT)，以本例说明，因为算数异常引发异常，于是触发内核调用来到操作系统内核中，由"),t("code",[s._v("IDT")]),s._v("表处理本次异常中断，以本次异常为例，对应"),t("code",[s._v("IDT")]),s._v("表就是"),t("code",[s._v("divide_error")]),s._v("，程序就会基于此表项进一步定位到具体处理该异常的函数：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://qiniuyun.sharkchili.com/202511280913708.png",alt:""}})]),s._v(" "),t("p",[s._v("可以看到，在操作系统触发异常中断过程中涉及到了如下三个概念：")]),s._v(" "),t("ol",[t("li",[s._v("中断")]),s._v(" "),t("li",[s._v("异常")]),s._v(" "),t("li",[s._v("IDT")])]),s._v(" "),t("p",[s._v("我们先来说说中断的概念，中断在意味着操作系统中存有重要的事情发生，需要打断当前CPU的工作，让的"),t("code",[s._v("CPU")]),s._v("处理优先级更高的任务。触发中断的方式并非只有本文的异常，用户针对硬件输入、网卡数据包接收等实时行为也都会优先触发中断。")]),s._v(" "),t("p",[s._v("我们再来说说异常，在操作系统中异常泛指程序中的线程执行了错误代码指令，例如：")]),s._v(" "),t("ol",[t("li",[s._v("算数异常")]),s._v(" "),t("li",[s._v("非法访问错误内存地址")])]),s._v(" "),t("p",[s._v("当"),t("code",[s._v("CPU")]),s._v("执行指令触发异常时，就会强制打断执行流，进入内核根据"),t("code",[s._v("IDT")]),s._v("处理异常，可能读到这里读者会认为中断与异常类似，不过二者还是有些差异的：")]),s._v(" "),t("ol",[t("li",[s._v("异常是程序错误主动触发被迫打断的")]),s._v(" "),t("li",[s._v("中断都是线程执行过程中被某些信号通知后异步触发的。")])]),s._v(" "),t("p",[s._v("最后就是"),t("code",[s._v("IDT")]),s._v("表，如上文所说，它本质就是异软硬件协定后的一个数组表格，不同索引代表不同的编码并内置对应处理函数，进程根据异常编码快速定位到异常处理函数：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://qiniuyun.sharkchili.com/202511280913853.png",alt:""}})]),s._v(" "),t("p",[s._v("同时，为提升"),t("code",[s._v("CPU")]),s._v("定位和处理异常的效率，操作系统都会在"),t("code",[s._v("CPU核心")]),s._v("内部用"),t("code",[s._v("idt寄存器")]),s._v("也就是"),t("code",[s._v("idtr")]),s._v("中维护一份"),t("code",[s._v("idt表")]),s._v("让"),t("code",[s._v("CPU")]),s._v("能够高效快速的处理每一份中断和异常：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://qiniuyun.sharkchili.com/202511280913155.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"信号投递"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#信号投递"}},[s._v("#")]),s._v(" 信号投递")]),s._v(" "),t("p",[s._v("以我们算数异常为例，线程通过idt定位到异常函数"),t("code",[s._v("divide_error")]),s._v("函数后，就需要向进程发送信号处理该异常，以算数异常为例则是"),t("code",[s._v("SIGFPE")]),s._v("也就是"),t("code",[s._v("signal floating-point exception")]),s._v("即浮点异常因为历史兼容原因保留这个名字，实际上这个信号覆盖处理所有整数和浮点数的算术异常。除此之外还有键盘键入"),t("code",[s._v("Ctrl+C")]),s._v("的"),t("code",[s._v("SIGINT")]),s._v("以及杀死进程的"),t("code",[s._v("SIGREM")]),s._v("信号。")]),s._v(" "),t("p",[s._v("随后异常处理函数会将信号投递到信号的处理队列，以本次算术异常为例，"),t("code",[s._v("SIGFPE")]),s._v("即数值8封装成"),t("code",[s._v("sigqueue")]),s._v("追加到队列中，同时也会针对该进程对应位图"),t("code",[s._v("signal")]),s._v("对应标志为设置为1：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://qiniuyun.sharkchili.com/202511280913349.png",alt:""}})]),s._v(" "),t("p",[s._v("针对这一点的核心信号发送的实现，笔者也给出对应函数"),t("code",[s._v("send_signal")]),s._v("的代码段，可以看到该函数底层实现本质就是将信号封装为"),t("code",[s._v("sigqueue")]),s._v("追加到队列中，并调整信号位图：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("send_signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("siginfo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sigpending")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("signals"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sigqueue")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//内存分配")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("atomic_read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("nr_queued_signals"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" max_queued_signals"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kmem_cache_alloc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sigqueue_cachep"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" GFP_ATOMIC"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("atomic_inc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("nr_queued_signals"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        q"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("next "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//追加到队列中")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("signals"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("tail "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        signals"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("tail "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("next"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//根据信号值封装不同封装成对应的sigqueue")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n                q"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("si_signo "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                q"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("si_errno "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                q"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("si_code "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" SI_USER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                q"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("si_pid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" current"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("pid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                q"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("si_uid "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" current"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("uid"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n              "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//......")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("default")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("copy_siginfo")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("break")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sig "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),s._v(" SIGRTMIN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" info"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("si_code "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" SI_USER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("EAGAIN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//更新进程位图")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("sigaddset")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("signals"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("signal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br"),t("span",{staticClass:"line-number"},[s._v("24")]),t("br"),t("span",{staticClass:"line-number"},[s._v("25")]),t("br"),t("span",{staticClass:"line-number"},[s._v("26")]),t("br"),t("span",{staticClass:"line-number"},[s._v("27")]),t("br"),t("span",{staticClass:"line-number"},[s._v("28")]),t("br"),t("span",{staticClass:"line-number"},[s._v("29")]),t("br"),t("span",{staticClass:"line-number"},[s._v("30")]),t("br"),t("span",{staticClass:"line-number"},[s._v("31")]),t("br"),t("span",{staticClass:"line-number"},[s._v("32")]),t("br"),t("span",{staticClass:"line-number"},[s._v("33")]),t("br"),t("span",{staticClass:"line-number"},[s._v("34")]),t("br"),t("span",{staticClass:"line-number"},[s._v("35")]),t("br"),t("span",{staticClass:"line-number"},[s._v("36")]),t("br"),t("span",{staticClass:"line-number"},[s._v("37")]),t("br"),t("span",{staticClass:"line-number"},[s._v("38")]),t("br")])]),t("h3",{attrs:{id:"内核态返回"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#内核态返回"}},[s._v("#")]),s._v(" 内核态返回")]),s._v(" "),t("p",[s._v("触发异常时，操作系统会往线程的内核堆栈中的"),t("code",[s._v("EIP")]),s._v("寄存器，记录的异常除法运算指令下一条指令，确保线程处理完异常后基于该地址回到用户态下一个执行点，"),t("code",[s._v("CPU")]),s._v("在将当前指令信号投递到"),t("code",[s._v("pending位图")]),s._v("后，就会执行如下步骤：")]),s._v(" "),t("ol",[t("li",[s._v("处理当前线程对应的进程的信号(包含本次自己发送的信号)")]),s._v(" "),t("li",[s._v("线程处理完信号之后，通过"),t("code",[s._v("iret(即interrupt return)")]),s._v("指返回用户态处理异常之后的指令，也就是上述的EIP寄存器的位置：")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://qiniuyun.sharkchili.com/202511280913570.png",alt:""}})]),s._v(" "),t("p",[s._v("由此完成一次中断处理闭环，后文我们就展开聊聊线程如何处理这些信号")]),s._v(" "),t("h2",{attrs:{id:"中断的处理"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#中断的处理"}},[s._v("#")]),s._v(" 中断的处理")]),s._v(" "),t("h3",{attrs:{id:"unix信号的不可靠性"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#unix信号的不可靠性"}},[s._v("#")]),s._v(" unix信号的不可靠性")]),s._v(" "),t("p",[s._v("上文提及一个信号发送函数"),t("code",[s._v("send_signal")]),s._v("，通过该函数就可以通知CPU发生了某些事件需要触发中断，让其停下手里的工作优先处理这些信号。")]),s._v(" "),t("p",[s._v("针对异常亦或者是硬件中断，传统"),t("code",[s._v("unix")]),s._v("系统采用信号的方式告知操作系统响应该中断，即32位的位图数组标识信号，需要发送信号的时候针对队列中对应的索引位置设置为1即可，这种方案虽然能够正确传递信号，但是针对重复发送相同信号的情况，因为针对的位图索引都是相同的，所以线程在处理该信号时就可能存在信号丢失的情况：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://qiniuyun.sharkchili.com/202511280913735.png",alt:""}})]),s._v(" "),t("h3",{attrs:{id:"linux针对信号表的优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#linux针对信号表的优化"}},[s._v("#")]),s._v(" Linux针对信号表的优化")]),s._v(" "),t("p",[s._v("考虑到这一点，对此"),t("code",[s._v("Linux")]),s._v("系统在继承unix信号表技术同时，将信号增加达到了64位更细维度的区分信号的种类，对应我们可以通过"),t("code",[s._v("kill -l")]),s._v("指令查阅：")]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGHUP       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGINT       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGQUIT      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGILL       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGTRAP\n "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("6")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGABRT      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("7")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGBUS       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("8")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGFPE       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("9")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGKILL     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("10")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGUSR1\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("11")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGSEGV     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("12")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGUSR2     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("13")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGPIPE     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("14")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGALRM     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("15")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGTERM\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("16")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGSTKFLT   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("17")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGCHLD     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("18")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGCONT     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("19")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGSTOP     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGTSTP\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("21")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGTTIN     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("22")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGTTOU     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("23")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGURG      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("24")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGXCPU     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("25")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGXFSZ\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("26")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGVTALRM   "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("27")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGPROF     "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("28")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGWINCH    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("29")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGIO       "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGPWR\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("31")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGSYS      "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("34")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN    "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("35")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+1  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("36")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+2  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("37")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+3\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("38")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+4  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("39")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+5  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("40")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+6  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("41")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+7  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("42")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+8\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("43")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+9  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("44")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+10 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("45")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+11 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("46")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+12 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("47")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+13\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("48")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+14 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("49")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMIN+15 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("50")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-14 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("51")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-13 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("52")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-12\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("53")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-11 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("54")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-10 "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("55")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-9  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("56")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-8  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("57")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-7\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("58")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-6  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("59")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-5  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("60")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-4  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("61")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-3  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("62")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-2\n"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("63")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX-1  "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("64")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" SIGRTMAX\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("同时针对重复信号丢失的问题，"),t("code",[s._v("Linux")]),s._v("系统除了增加信号类型以外还补充了一个队列"),t("code",[s._v("sigqueue")]),s._v("以追加的方式接纳重复的信号消息，以最大限度避免信号丢失问题：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sigpending")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//信号队列")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sigqueue")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("head"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("tail"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//信号位图")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sigset_t")]),s._v(" signal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("p",[s._v("注意笔者上文所说的，最大限度避免信号丢失，因为信号队列的长度是有限制，如果当前队列长度超过信号队列的最大值，则会抛出异常无法添加信号，还是会导致信号丢失问题。")]),s._v(" "),t("p",[s._v("对应的我们还是给出"),t("code",[s._v("send_signal")]),s._v("的核心代码段印证这一点，可以看到在进行内存分配的时候会判断队列长度是否超过"),t("code",[s._v("max_queued_signals")]),s._v("，如果超出就不会进行结构体内存分配，后续处理逻辑就会直接抛出异常：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("static")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("send_signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("int")]),s._v(" sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("siginfo")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("info"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sigpending")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("signals"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("sigqueue")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v(" q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token constant"}},[s._v("NULL")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//内存分配")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("atomic_read")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("nr_queued_signals"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v(" max_queued_signals"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        q "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("kmem_cache_alloc")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sigqueue_cachep"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" GFP_ATOMIC"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//......")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("q"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//结构体非空，才会添加信号")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//......")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("else")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sig "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">=")]),s._v(" SIGRTMIN "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("unsigned")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("long")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("info "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n           "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" info"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("->")]),s._v("si_code "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("!=")]),s._v(" SI_USER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          \n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("-")]),s._v("EAGAIN"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("h3",{attrs:{id:"进程对于信号的处理时机"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#进程对于信号的处理时机"}},[s._v("#")]),s._v(" 进程对于信号的处理时机")]),s._v(" "),t("p",[s._v("一般情况下，线程会因为系统调用、异常、中断等时机从用户态进入内核态，在返回时线程就会查看当前进程是否有需要处理的信号，从而完成信号的响应。")]),s._v(" "),t("p",[s._v("可能会有读者认为如果线程没有涉及内核态调用是否就无法处理这些信号了，实际大可不必担心这一点，操作系统本质就是依靠时钟中断调度进程，这使得进程时钟会有一个时钟中断需要响应，同时这个中断的延迟对于人类而言基本没有任何延迟的感知，所以信号基本是可以及时的被响应。")]),s._v(" "),t("p",[s._v("我们都知道进程在操作系统用以"),t("code",[s._v("task_struct")]),s._v("标识，其内部信号结构体"),t("code",[s._v("signal_struct")]),s._v("对信号和处理器内置了一份信号处理表(本质就是"),t("code",[s._v("action")]),s._v("数组)，这份表格标识了不同信号及其处理函数，进程可以根据返回用户态时收到的信号执行特定的处理函数：")]),s._v(" "),t("p",[t("img",{attrs:{src:"https://qiniuyun.sharkchili.com/202511280913989.png",alt:""}})]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("task_struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n  \t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//信号对应处理方法 sig")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("signal_struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("sig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n   \n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//内置了action标识不同索引即代表不同信号，及信号对应处理函数")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("signal_struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("atomic_t")]),s._v("\t\tcount"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("k_sigaction")]),s._v("\taction"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("_NSIG"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("spinlock_t")]),s._v("\t\tsiglock"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[s._v("同时用户也可以通过自定义需要标识处理函数这本质就是修改上述"),t("code",[s._v("action")]),s._v("对应的处理逻辑，这使得很多高级语言的逻辑实现有了很大的灵活性，例如笔者"),t("code",[s._v("go语言")]),s._v("实现的"),t("code",[s._v("mini-redis")]),s._v("就针对进程的一些终止信号进行特定的处理：")]),s._v(" "),t("div",{staticClass:"language-go line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-go"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//监听关闭信号")]),s._v("\n\tsigCh "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("make")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("chan")]),s._v(" os"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("Signal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\tsignal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Notify")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("sigCh"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" syscall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SIGHUP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" syscall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SIGQUIT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" syscall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" syscall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SIGINT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//协程监听到这些信号直接关闭服务端并处理所有客户端连接")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("go")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("func")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("server "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("redisServer"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\tsig "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v(":=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<-")]),s._v("sigCh\n\t\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("switch")]),s._v(" sig "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("case")]),s._v(" syscall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SIGHUP"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" syscall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SIGQUIT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" syscall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SIGTERM"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" syscall"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("SIGINT"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("closeRedisServer")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//关闭所有客户端")]),s._v("\n\t\t\tserver"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("done"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("Store")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("server"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br")])]),t("p",[s._v("因为在正式处理信号前，线程还是处理内核态，所以为了避免处理自定义函数对系统内部造成破坏，"),t("code",[s._v("Linux")]),s._v("在进行信号处理时遵循如下原则：")]),s._v(" "),t("ol",[t("li",[s._v("如果信号处理函数为默认函数，则直接内核处理完成")]),s._v(" "),t("li",[s._v("如果信号对应处理函数为用户自定义，则会通过一个虚拟中断将调用返回用户态完成自定义函数处理，再返回内核完成剩余收尾工作：")])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://qiniuyun.sharkchili.com/202511280913215.png",alt:""}})]),s._v(" "),t("p",[s._v("对应我们给出线程从内核返回用户态时的信号处理函数"),t("code",[s._v("do_signal")]),s._v("，get_signal本质就是默认处理函数，我们不要被这个函数名误导了，其内部逻辑就会判断是否是默认信号处理，如果是则直接完成，反之返回"),t("code",[s._v("true")]),s._v("。")]),s._v(" "),t("p",[s._v("针对用户自定义信号处理"),t("code",[s._v("handle_signal")]),s._v("，"),t("code",[s._v("Linux")]),s._v("内核会将用户态寄存器上下文信息即regs保存下来，然后修改为自定义信号处理函数的地址回到用户态完成调用，然后返回内核态调用"),t("code",[s._v("restore_saved_sigmask")]),s._v("正式回到用户态：")]),s._v(" "),t("div",{staticClass:"language-c line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-c"}},[t("code",[t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//has_signal的值为 (ti_work & _TIF_SIGPENDING)")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("void")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("arch_do_signal_or_restart")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("pt_regs")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),s._v("regs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" bool has_signal"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("struct")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token class-name"}},[s._v("ksignal")]),s._v(" ksig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n\t\t"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//如果是处理函数则直接在get_signal中完成，反之get_signal返回大于0的数，交给handle_signal中断跳转到用户态安全执行再回来")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("if")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("has_signal "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&&")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("get_signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ksig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("handle_signal")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("&")]),s._v("ksig"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" regs"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("return")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    \n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//......")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("//返回原始用户态上下文")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("restore_saved_sigmask")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n\n\n\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("需要补充说明的是，信号可以在特定情况下不接收，我们可以通过刚调整"),t("code",[s._v("sigpromask")]),s._v("将信号屏蔽，但是"),t("code",[s._v("SIGKILL")]),s._v("或者"),t("code",[s._v("SIGSTOP")]),s._v("这些信号就无法被屏蔽。")]),s._v(" "),t("h3",{attrs:{id:"线程组的基本概念"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#线程组的基本概念"}},[s._v("#")]),s._v(" 线程组的基本概念")]),s._v(" "),t("p",[s._v("计算机发展初期系统都是以进程为最小子单位运行，即一个进程是最小的单元和执行流，这使得上述的信号可以在单进程中正确的处理。随着需要的增长，原有的单执行流进程变为多线程程序，为了兼容和适配旧有的设计理念，线程还是沿袭了"),t("code",[s._v("task_struct")]),s._v("这个结构体。")]),s._v(" "),t("p",[s._v("那么问题来：")]),s._v(" "),t("ol",[t("li",[s._v("我们如何处理单进程信号和各个线程独立信号")]),s._v(" "),t("li",[s._v("进程信号是所有线程共享要如何通知并正确的让某个线程处理")]),s._v(" "),t("li",[s._v("如何区分进程和线程级别的信号发送")])]),s._v(" "),t("p",[s._v("我们逐个说明，上文已告知线程沿袭"),t("code",[s._v("task_struct")]),s._v("结构体，所以针对线程的私有独立信号我们完全让各个线程利用"),t("code",[s._v("sigpending")]),s._v("这个队列维护自己的信号，同理这些线程对应进程也用"),t("code",[s._v("task_struct")]),s._v("标识，只不过这个"),t("code",[s._v("task_struct")]),s._v("地址空间线程共享，由此保证的一个结构体解决不同维度的信号管理。")]),s._v(" "),t("p",[s._v("再来说说进程的信号，因为进程信号是整体维度，即当前进程的线程组共享的，所以我们可以在原有"),t("code",[s._v("signal_struct")]),s._v("基础上增加一个"),t("code",[s._v("sharded_pending")]),s._v("专门维护标识进程级别的信号。")]),s._v(" "),t("p",[s._v("最后一个问题，这本质就是一个标识的问题，我们可以做出如下规定：")]),s._v(" "),t("ol",[t("li",[s._v("当发送的信号是给线程的，则设置"),t("code",[s._v("group")]),s._v("为0，即非分组信号。")]),s._v(" "),t("li",[s._v("如果要发送的给进程即全局任意线程可以处理的，则"),t("code",[s._v("group")]),s._v("分组设置为1，告知线程组可以共享接收处理，由此出于响应中断的线程就可以从"),t("code",[s._v("sharded_pending")]),s._v("看到进程信号并处理。")])]),s._v(" "),t("p",[s._v("总结一下上述的说法，笔者也给出如下架构图，读者可以参考理解一下：\n"),t("img",{attrs:{src:"https://qiniuyun.sharkchili.com/202511280913559.png",alt:""}})]),s._v(" "),t("h2",{attrs:{id:"小结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#小结"}},[s._v("#")]),s._v(" 小结")]),s._v(" "),t("p",[s._v("自此笔者自底层结合源码深入剖析的操作系统的进程异常与中断的响应如何通过信号发送通知，以及进程(线程)如何准确及时且安全的响应这个信号，希望对你有帮助。")]),s._v(" "),t("p",[s._v("我是 "),t("strong",[s._v("SharkChili")]),s._v(" ，Java 开发者，"),t("strong",[s._v("Java Guide")]),s._v(" 开源项目维护者。欢迎关注我的公众号："),t("strong",[s._v("写代码的SharkChili")]),s._v("，也欢迎您了解我的开源项目 mini-redis："),t("a",{attrs:{href:"https://github.com/shark-ctrl/mini-redis",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://github.com/shark-ctrl/mini-redis"),t("OutboundLink")],1),s._v("。")]),s._v(" "),t("p",[s._v("为方便与读者交流，现已创建读者群。关注下方公众号获取我的联系方式，添加时备注"),t("strong",[s._v("加群")]),s._v("即可加入。")]),s._v(" "),t("h2",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),t("p",[s._v("中断描述符表（Interrupt Descriptor Table，IDT)："),t("a",{attrs:{href:"https://www.cnblogs.com/qintangtao/p/3325985.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.cnblogs.com/qintangtao/p/3325985.html"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("从汇编角度理解 ebp&esp 寄存器、函数调用过程、函数参数传递以及堆栈平衡:"),t("a",{attrs:{href:"https://blog.csdn.net/song_lee/article/details/105297902",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.csdn.net/song_lee/article/details/105297902"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("【信号】信号保存:"),t("a",{attrs:{href:"https://blog.csdn.net/zty857016148/article/details/133955816",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.csdn.net/zty857016148/article/details/133955816"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("操作系统之GDT和IDT（三）:"),t("a",{attrs:{href:"https://blog.csdn.net/ice__snow/article/details/50654629",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.csdn.net/ice__snow/article/details/50654629"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("从CPU到内核/到用户态全景分析异常分发机制——内核接管[1]:"),t("a",{attrs:{href:"https://www.anquanke.com/post/id/230449",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.anquanke.com/post/id/230449"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("对int、iret和栈的深入理解\n:"),t("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/379553031",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://zhuanlan.zhihu.com/p/379553031"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("Linux信号机制及其原理分析\n:"),t("a",{attrs:{href:"https://juejin.cn/post/7081189234245107742",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://juejin.cn/post/7081189234245107742"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("linux内核信号处理机制--do_signal函数讲解 (适用mips架构)\n:"),t("a",{attrs:{href:"https://www.freesion.com/article/1364736621/",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.freesion.com/article/1364736621/"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("linux内核信号处理机制--do_signal函数讲解："),t("a",{attrs:{href:"https://blog.csdn.net/weixin_38669561/article/details/103920333",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://blog.csdn.net/weixin_38669561/article/details/103920333"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("sigset_t 操作\n:"),t("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/579973391",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://zhuanlan.zhihu.com/p/579973391"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("Linux信号处理:"),t("a",{attrs:{href:"https://www.cnblogs.com/sunsky303/p/10838610.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.cnblogs.com/sunsky303/p/10838610.html"),t("OutboundLink")],1)]),s._v(" "),t("p",[s._v("Linux signal 那些事儿（2）【转】:"),t("a",{attrs:{href:"https://www.cnblogs.com/sky-heaven/p/6844543.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("https://www.cnblogs.com/sky-heaven/p/6844543.html"),t("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=e.exports}}]);